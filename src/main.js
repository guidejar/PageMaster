!function(){"use strict";let e=null,t=null,o=!1,r=null;const s="offline-user";let n={},a={},i=!1,l="default";const d=localStorage.getItem("userPreferredTheme")||null;let c=JSON.parse(localStorage.getItem("resourceOrder")||"[]"),p=JSON.parse(localStorage.getItem("assetOrder")||"[]"),u=JSON.parse(localStorage.getItem("modifierOrder")||"[]");const m=["선택지 위에 있는 가로줄과 점들은 인포패널입니다. 한번 눌러보세요.","선택지 우측 하단에 위치한 아이콘을 눌러해보세요.","드래그 앤 드롭으로 목록의 위치를 바꿔보세요.","페이지 제목을 클릭하면 페이지 목록이 나옵니다.","페이지 양 옆의 화살표로 페이지를 이동할 수 있어요.","선택지 아래에 있는 이미지 아이콘을 클릭하면 해당 장면에 맞는 이미지를 생성할 수 있어요."],g=["fantasy","stone-cyan-dark","cyberpunk","horror","modern","cyberpunk-dark","material-dark","material-light"],h=e=>{document.body.className=document.body.className.split(" ").filter(e=>!e.startsWith("theme-")).join(" "),document.body.classList.add(`theme-${e}`),l=e,console.log(`Applied theme: ${e}`)},x=e=>{const t=document.querySelectorAll('script[id="codex"]');let o=null;t.forEach(t=>{t.getAttribute("data-type")===e&&(o=t)});const r={entities:[],resources:[],assets:[],modifiers:[],removed:{entities:[],resources:[],assets:[],modifiers:[]}};if(!o)return r;const s=o.textContent.trim().split("\n").map(e=>e.trim()).filter(e=>e),n={},a={},i={},l={};return s.forEach(t=>{const o=t.indexOf("|");if(-1===o)return;const s=t.substring(0,o).trim(),d=t.substring(o+1).trim(),c=s.split("."),p=c[0],u=c[1],m=c.slice(2);if("remove"!==e)if("entity"===p){n[u]||(n[u]={id:u,classifications:{}});const e=n[u];if(1===m.length)e[m[0]]=d;else if("classifications"===m[0]&&2===m.length){const t=m[1],o=d.indexOf(":");if(o>-1){const r=d.substring(0,o).trim(),s=d.substring(o+1).trim();e.classifications[t]={label:r,value:s}}else e.classifications[t]={label:t,value:d}}}else if("resource"===p){a[u]||(a[u]={id:u});const e=a[u],t=m[0];e[t]="current"===t||"max"===t?"NULL"===d?null:Number(d):d}else if("asset"===p){i[u]||(i[u]={id:u,properties:{}});const e=i[u];if(1===m.length){const t=m[0];e[t]="quantity"===t?Number(d):d}else if("properties"===m[0]&&2===m.length){const t=m[1],o=d.indexOf(":");if(o>-1){const r=d.substring(0,o).trim(),s=d.substring(o+1).trim();e.properties[t]={label:r,value:s}}else e.properties[t]={label:t,value:d}}}else"effect"===p&&(l[u]||(l[u]={id:u}),l[u][m[0]]=d);else"entity"===p?r.removed.entities.push(u):"resource"===p?r.removed.resources.push(u):"asset"===p?r.removed.assets.push(u):"effect"===p&&r.removed.modifiers.push(u)}),r.entities=Object.values(n),r.resources=Object.values(a),r.assets=Object.values(i),r.modifiers=Object.values(l),r},v=()=>{const e=document.getElementById("session-uuid");if(e&&e.textContent.trim()){const t=e.textContent.trim();return console.log(`Session ID loaded from HTML: ${t}`),t}let t=localStorage.getItem("gameSessionId");return t||(t=crypto.randomUUID(),localStorage.setItem("gameSessionId",t),console.warn("New Session ID generated and stored in localStorage.")),t},b=()=>{const e=(()=>{const e=document.getElementById("header");if(!e)return{title:"",location:"",date:"",time:""};const t=e.textContent.trim().split("|").map(e=>e.trim());return{title:t[0]||"",location:t[1]||"",date:t[2]||"",time:t[3]||""}})(),t=(()=>{const e=document.getElementById("story");return e?(e=>{if(!e)return"";let t=e;return t=t.replace(/^### (.+)$/gm,'<h3 class="text-xl font-bold text-[var(--text-color-primary)] mt-4 mb-2">$1</h3>'),t=t.replace(/^## (.+)$/gm,'<h2 class="text-2xl font-bold text-[var(--text-color-primary)] mt-6 mb-3">$1</h2>'),t=t.replace(/^# (.+)$/gm,'<h1 class="text-3xl font-bold text-[var(--text-color-primary)] mt-8 mb-4">$1</h1>'),t=t.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),t=t.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),t=t.replace(/\n\n/g,'</p><p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'),t='<p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'+t+"</p>",t})(e.textContent.trim()):""})(),o=(()=>{const e=document.getElementById("choices");return e?e.textContent.trim().split("\n").map(e=>e.trim()).filter(e=>e).map(e=>e.replace(/^\d+\.\s*/,"").trim()):[]})(),r=(()=>{const e=document.getElementById("scene-data");return e?e.textContent.trim().split("\n").map(e=>e.trim()).filter(e=>e).map(e=>{const t=e.split("|").map(e=>e.trim());return{type:t[1]||"",name:t[2]||"",distance:t[3]?Number(t[3]):0,status:t[4]||""}}).filter(e=>e.type):[]})(),s=x("new"),n=x("update"),a=x("remove"),i=s.entities,l=n.entities,d=[...s.resources,...n.resources],c=[...s.assets,...n.assets],p=[...s.modifiers,...n.modifiers],u=a.removed,m=document.querySelector("title"),g=m?parseInt(m.textContent.match(/\d+/)?.[0]||"0"):0,h=(()=>{const e={};return document.querySelectorAll('script[type="text/html"]').forEach(t=>{const o=t.getAttribute("data-id"),r=t.getAttribute("data-category");o&&(e[o]={category:r||"unknown",content:t.innerHTML.trim()})}),e})();return{sessionId:v(),header:e,story_html:t,choices:o,scene_elements:r,codex_new:i,codex_update:l,resources:d,asset:c,modifiers:p,removed:u,html_docs:h,page_number:g,define:i,update:l,hud:{location:e.location,date:e.date,time:e.time},title:e.title,character_stats:{resources:d,attributes:{},equipment:{},name:"",level:1},information_panel:[]}},f=()=>"undefined"!=typeof __app_id?__app_id:"default-app-id",y=(e,t,o="name")=>{if(!e||0===e.length)return t;if(!t||0===t.length)return e;const r=new Map;return e.forEach(e=>{e[o]&&r.set(e[o],e)}),t.forEach(e=>{e[o]&&r.set(e[o],{...r.get(e[o]),...e})}),Array.from(r.values())},w=(e,t,o,r)=>{const n=e||s,a=`artifacts_${f()}_users_${n}_sessions_${r}_${t}`;let i=JSON.parse(localStorage.getItem(a)||"[]"),l=o;i.length>0&&(l=y(i,o,"id")),localStorage.setItem(a,JSON.stringify(l)),console.log(`Data type ${t} for session ${r} saved to localStorage.`)},_=(e,t,o,r)=>{const n=e||s,a=`artifacts_${f()}_users_${n}_sessions_${r}_${t}`,i=JSON.parse(localStorage.getItem(a)||"[]").filter(e=>e.id!==o);localStorage.setItem(a,JSON.stringify(i)),console.log(`Item ${o} of type ${t} for session ${r} deleted from localStorage.`)},C=async(e,t,o,r,s)=>{try{const n=f();if("new"===o||"update"===o){const a=collection(t,`artifacts/${n}/users/${e}/sessions/${s}/codex_entities`);for(const e of r)if(e.id){const t=doc(a,e.id);await setDoc(t,{...e,updatedAt:serverTimestamp()},{merge:!0})}console.log(`Codex entities (${o}) saved for session ${s}:`,r.length)}else if("resources"===o||"asset"===o||"modifiers"===o){const a=doc(t,`artifacts/${n}/users/${e}/sessions/${s}/game_state/current_state`),i=await getDoc(a);let l=i.exists()?i.data():{},d=r;l[o]&&(d=y(l[o],r,"id")),await setDoc(a,{[o]:d,updatedAt:serverTimestamp()},{merge:!0}),console.log(`Game state (${o}) saved for session ${s}:`,d.length)}}catch(e){console.error(`Firestore 저장 실패 [${o}] for session ${s}:`,e)}},$=async(e,t,o,r,s)=>{try{const n=f();let a;if("entity"===o)a=doc(t,`artifacts/${n}/users/${e}/sessions/${s}/codex_entities`,r),await deleteDoc(a),console.log(`Entity ${r} deleted from session ${s}.`);else if("resource"===o||"asset"===o||"modifier"===o){const a=doc(t,`artifacts/${n}/users/${e}/sessions/${s}/game_state/current_state`),i=await getDoc(a);if(i.exists()){const e=(i.data()[o+"s"]||[]).filter(e=>e.id!==r);await setDoc(a,{[o+"s"]:e},{merge:!0}),console.log(`${o} ${r} removed from game_state for session ${s}.`)}}}catch(e){console.error(`Error deleting ${o} ${r} for session ${s}:`,e)}},L=(e,t="",o="")=>{const r=document.createElement(e);return t&&(r.className=t),o&&(r.textContent=o),r},E=()=>{const e=L("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");e.id="active-overlay";const t=L("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6");t.innerHTML='<h2 class="text-2xl font-bold text-[var(--ui-accent-primary)] mb-4">Image Modal (Placeholder)</h2><p>Image content will go here.</p><button class="mt-4 p-2 bg-[var(--ui-accent-primary)] rounded" onclick="document.getElementById(\'active-overlay\').remove()">Close</button>',e.appendChild(t),document.body.appendChild(e)},S=async o=>{if(!e||!t||!r)return void console.error("Firebase not initialized or user not logged in.");const n=v(),a=await(async(t,o,n)=>{try{const a=t||s;if(e&&r){const e=f(),t=doc(o,`artifacts/${e}/users/${a}/pages/${n}`),r=await getDoc(t);if(r.exists()){console.log(`Page snapshot for session ${n} loaded successfully from Firebase.`);const e=r.data();return e.current_theme&&h(e.current_theme),e}return console.log(`No snapshot found for session ${n} in Firebase.`),null}{const e=`page_snapshot_${n}`,t=localStorage.getItem(e);if(t){console.log(`Page snapshot for session ${n} loaded successfully from localStorage.`);const e=JSON.parse(t);return e.current_theme&&h(e.current_theme),e}return console.log(`No snapshot found for session ${n} in localStorage.`),null}}catch(e){return console.error("Error loading page snapshot:",e),null}})(r,t,o);a?(document.getElementById("app-root").innerHTML="",X(),F(a),W(a),R(a),U(a),G(a),a.current_theme&&h(a.current_theme),o!==n?k():I(),console.log(`Page snapshot for session ${o} rendered.`)):console.warn(`Could not load snapshot for session ${o}.`)},k=()=>{document.body.classList.add("read-only")},I=()=>{document.body.classList.remove("read-only")},H=async()=>{const{getDocs:o,collection:s,query:n,orderBy:a}=await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"),i=L("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");i.id="active-overlay";const l=L("div","w-full max-w-2xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),d=L("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),c=L("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","페이지 브라우징");d.appendChild(c);const p=L("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");p.textContent="×",p.onclick=()=>i.remove(),d.appendChild(p),l.appendChild(d);const u=L("div","flex-grow overflow-y-auto"),m=L("p","text-[var(--text-color-secondary)]","페이지 목록 불러오는 중...");if(u.appendChild(m),l.appendChild(u),i.appendChild(l),document.body.appendChild(i),e&&t&&r){const e=n(s(t,`artifacts/${f()}/users/${r}/page_index`),a("timestamp","desc")),l=await o(e);if(u.innerHTML="",l.empty)u.innerHTML='<p class="text-[var(--text-color-secondary)]">저장된 페이지가 없습니다.</p>';else{const e=L("ul","space-y-2");l.forEach(t=>{const o=t.data(),r=L("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),s=o.timestamp?new Date(o.timestamp.toDate()).toLocaleString():"날짜 없음";r.innerHTML=`\n                    <div class="font-bold text-[var(--text-color-primary)]">${o.title||"제목 없음"} (Page ${o.page_number})</div>\n                    <div class="text-sm text-[var(--text-color-secondary)]">저장 시간: ${s}</div>\n                    <div class="text-xs text-[var(--text-color-secondary)]">ID: ${o.sessionId}</div>\n                `,r.addEventListener("click",()=>{S(o.sessionId),i.remove()}),e.appendChild(r)}),u.appendChild(e)}}else{const e="saved_branches",t=JSON.parse(localStorage.getItem(e)||"[]");if(u.innerHTML="",0===t.length)u.innerHTML='<p class="text-[var(--text-color-secondary)]">로컬에 저장된 페이지가 없습니다.</p>';else{const e=L("ul","space-y-2");t.forEach(t=>{const o=`page_snapshot_${t}`,r=localStorage.getItem(o);if(r){const o=JSON.parse(r),s=L("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),n=(new Date).toLocaleString();s.innerHTML=`\n                        <div class="font-bold text-[var(--text-color-primary)]">${o.header.title||"제목 없음"} (Page ${o.page_number})</div>\n                        <div class="text-sm text-[var(--text-color-secondary)]">로컬 저장 (시간: ${n})</div>\n                        <div class="text-xs text-[var(--text-color-secondary)]">ID: ${t}</div>\n                    `,s.addEventListener("click",()=>{S(t),i.remove()}),e.appendChild(s)}}),u.appendChild(e)}}},M=()=>{const e=document.getElementById("active-overlay");e&&e.remove();const t=L("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");t.id="active-overlay";const o=L("div","w-full max-w-md max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),r=L("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=L("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","Codex");r.appendChild(s);const n=L("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");n.textContent="×",n.onclick=()=>t.remove(),r.appendChild(n),o.appendChild(r);const i=L("div","flex-grow overflow-y-auto"),l=b(),d=[];if(l.codex_new&&l.codex_new.length>0&&d.push(...l.codex_new),l.codex_update&&l.codex_update.length>0&&d.push(...l.codex_update),d.length>0){const e=d.reduce((e,t)=>{let o="General";return t.data&&t.data.length>0&&t.data[0].category?o=t.data[0].category:"player_001"===t.id&&(o="Player"),e[o]||(e[o]=[]),e[o].push(t),e},{});for(const t in e){const o=L("div","mb-4 last:mb-0"),r=!1!==a[t],s=L("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");s.innerHTML=`\n                <span class="font-bold text-[var(--text-color-primary)] text-lg">${t}</span>\n                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${r?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>\n            `,o.appendChild(s);const n=L("div","overflow-hidden transition-all duration-300 ease-in-out");n.style.maxHeight=r?n.scrollHeight+"px":"0px";const l=L("ul","space-y-2 mt-2 codex-list");l.setAttribute("data-list-type","codex"),e[t].forEach((e,t)=>{const o=!("player_001"===e.id&&!d.some(e=>"player_002"===e.id)),r=j(e,o);l.appendChild(r)}),n.appendChild(l),o.appendChild(n),i.appendChild(o),s.addEventListener("click",()=>{const e=s.querySelector("svg");"0px"===n.style.maxHeight||""===n.style.maxHeight?(n.style.maxHeight=n.scrollHeight+"px",e.classList.remove("rotate-180"),a[t]=!0):(n.style.maxHeight="0px",e.classList.add("rotate-180"),a[t]=!1)})}}else{const e=L("p","text-sm text-[var(--text-color-secondary)] italic");e.textContent="Codex 목록이 비어있습니다",i.appendChild(e)}o.appendChild(i),t.appendChild(o),document.body.appendChild(t),t.addEventListener("click",e=>{e.target===t&&t.remove()})},N=()=>{const e=document.getElementById("active-overlay");e&&e.remove();const t=L("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");t.id="active-overlay";const o=L("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6"),r=L("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=L("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","설정");r.appendChild(s);const n=L("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");n.textContent="×",n.onclick=()=>t.remove(),r.appendChild(n),o.appendChild(r);const a=L("div","mb-6"),i=L("label","block text-sm font-medium text-[var(--text-color-primary)] mb-2","테마 선택");a.appendChild(i);const d=L("select","w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-md text-[var(--text-color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--ui-accent-secondary)]");g.forEach(e=>{const t=L("option","",e);t.value=e,e===l&&(t.selected=!0),d.appendChild(t)}),d.addEventListener("change",e=>{h(e.target.value),localStorage.setItem("userPreferredTheme",e.target.value)}),a.appendChild(d),o.appendChild(a),t.appendChild(o),document.body.appendChild(t),t.addEventListener("click",e=>{e.target===t&&t.remove()})},T=()=>{const e=document.getElementById("active-overlay");e&&e.remove();const t=L("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");t.id="active-overlay";const o=L("div","w-full max-w-6xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl flex flex-col"),r=L("div","flex items-center justify-between border-b border-[var(--border-color)] p-6 pb-3"),s=L("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","🐛 Debug Data Browser");r.appendChild(s);const n=L("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");n.textContent="×",n.onclick=()=>t.remove(),r.appendChild(n),o.appendChild(r);const a=L("div","flex gap-2 px-6 pt-3 border-b border-[var(--border-color)]"),i=[];["Entities","Resources","Assets","Modifiers","localStorage","Page History"].forEach((e,t)=>{const o=L("button","px-4 py-2 rounded-t-md transition-colors "+(0===t?"bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]":"text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"));o.textContent=e,o.dataset.tab=e,i.push(o),a.appendChild(o)}),o.appendChild(a);const l=L("div","flex-grow overflow-y-auto p-6");o.appendChild(l);const d=b(),c=v(),p=e=>{const t=L("pre","bg-black/30 p-4 rounded-md overflow-x-auto text-xs text-[var(--text-color-primary)] font-mono");return t.textContent=JSON.stringify(e,null,2),t},u=(e,t)=>{const o=L("div","mb-6"),r=L("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3",t);if(o.appendChild(r),!e||0===e.length){const e=L("p","text-[var(--text-color-secondary)] italic","데이터 없음");return o.appendChild(e),o}const s=L("table","w-full border-collapse text-sm");s.style.fontSize="12px";const n=L("thead"),a=L("tr","border-b border-[var(--border-color)]"),i=Object.keys(e[0]);i.forEach(e=>{const t=L("th","text-left p-2 text-[var(--text-color-primary)] font-bold",e);a.appendChild(t)}),n.appendChild(a),s.appendChild(n);const l=L("tbody");return e.forEach((e,t)=>{const o=L("tr","border-b border-[var(--border-color)]/30 hover:bg-[var(--bg-color)] transition-colors");i.forEach(t=>{const r=L("td","p-2 text-[var(--text-color-secondary)]"),s=e[t];r.textContent="object"==typeof s&&null!==s?JSON.stringify(s):s??"null",o.appendChild(r)}),l.appendChild(o)}),s.appendChild(l),o.appendChild(s),o},m=e=>{switch(l.innerHTML="",e){case"Entities":l.appendChild(u(d.codex_new,"New Entities")),l.appendChild(u(d.codex_update,"Updated Entities"));break;case"Resources":l.appendChild(u(d.resources,"Resources"));break;case"Assets":l.appendChild(u(d.asset,"Assets"));break;case"Modifiers":l.appendChild(u(d.modifiers,"Modifiers"));break;case"localStorage":const e=L("div"),t=L("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","localStorage Keys");e.appendChild(t);const o=L("div","space-y-2"),r=Object.keys(localStorage).filter(e=>e.includes(c)||e.includes("processed_pages")||e.includes("snapshot_pages"));if(r.forEach(e=>{const t=L("div","bg-black/20 p-3 rounded-md"),r=L("div","font-bold text-[var(--ui-accent-primary)] mb-2",e);t.appendChild(r);try{const o=localStorage.getItem(e),r=JSON.parse(o);t.appendChild(p(r))}catch(o){const r=L("pre","text-xs text-[var(--text-color-secondary)]",localStorage.getItem(e));t.appendChild(r)}o.appendChild(t)}),0===r.length){const e=L("p","text-[var(--text-color-secondary)] italic","관련 localStorage 항목 없음");o.appendChild(e)}e.appendChild(o),l.appendChild(e);break;case"Page History":const s=L("div"),n=`processed_pages_${c}`,a=JSON.parse(localStorage.getItem(n)||"[]");s.appendChild(u(a,"Processed Pages (Anti-duplicate)"));const i=`snapshot_pages_${c}`,m=JSON.parse(localStorage.getItem(i)||"[]");s.appendChild(u(m,"Saved Snapshots"));const g=L("div","mt-6 bg-black/20 p-4 rounded-md"),h=L("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","Current Page Info");g.appendChild(h);const x={sessionId:c,page_number:d.page_number,title:d.header.title,timestamp:(new Date).toISOString()};g.appendChild(p(x)),s.appendChild(g),l.appendChild(s)}};i.forEach(e=>{e.addEventListener("click",()=>{i.forEach(e=>{e.className="px-4 py-2 rounded-t-md transition-colors text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}),e.className="px-4 py-2 rounded-t-md transition-colors bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]",m(e.dataset.tab)})}),m("Entities"),t.appendChild(o),document.body.appendChild(t),t.addEventListener("click",e=>{e.target===t&&t.remove()})};let O=null;const j=(e,t=!0)=>{const o=L("li","text-sm p-2 rounded-md transition-colors");t?(o.setAttribute("draggable","true"),o.classList.add("cursor-grab","bg-[var(--bg-panel)]/30","hover:bg-[var(--bg-panel)]/50")):o.classList.add("bg-amber-900/30","border","border-amber-600","text-amber-200","font-bold");const r=e.classifications||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--text-color-secondary)] mt-1">${Object.entries(r).map(([e,t])=>`<span>${t.label||e}: ${t.value||t}</span>`).join(", ")}</div>`:"";return o.innerHTML=`<strong class="text-[var(--ui-accent-secondary)]">${e.name||e.id}</strong>\n        ${s}\n    `,o.dataset.entityId=e.id,t&&(o.addEventListener("dragstart",B),o.addEventListener("dragend",D),o.addEventListener("dragover",J),o.addEventListener("drop",P)),o},A=(e,t)=>{const o=L("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");o.setAttribute("draggable","true"),o.setAttribute("data-index",t),o.dataset.assetId=e.id;const r=e.properties||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--ui-accent-tertiary)] mb-1">${Object.entries(r).map(([e,t])=>`<span>${t.label||e}: ${t.value||t}</span>`).join(", ")}</div>`:"";return o.innerHTML=`\n        <div class="flex justify-between items-center mb-1">\n            <span class="font-semibold text-[var(--text-color-primary)] text-base">${e.name}</span>\n            <span class="text-xs font-mono text-[var(--text-color-secondary)]">x${e.quantity}</span>\n        </div>\n        ${s}\n        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] leading-tight">${e.description}</p>`:""}\n    `,o.addEventListener("dragstart",B),o.addEventListener("dragend",D),o.addEventListener("dragover",J),o.addEventListener("drop",P),o},B=e=>{O=e.target.closest('[draggable="true"]'),O&&(O.style.opacity="0.5",O.classList.add("border","border-stone-500"),e.dataTransfer.effectAllowed="move")},D=e=>{if(O){O.style.opacity="1",O.classList.remove("border","border-stone-500");const e=O.parentNode;if(e){const t=e.getAttribute("data-list-type");z(e,t)}}},J=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest('[draggable="true"]');if(t&&t!==O&&t.parentNode===O.parentNode){const o=t.getBoundingClientRect(),r=o.top+o.height/2;e.clientY<r?t.parentNode.insertBefore(O,t):t.parentNode.insertBefore(O,t.nextSibling)}},P=e=>{e.preventDefault(),e.stopPropagation()},z=(e,t)=>{if(!e||!t)return;const o=Array.from(e.children).map(e=>"resource"===t?e.dataset.resourceId:"asset"===t?e.dataset.assetId||e.textContent.trim():"modifier"===t?e.dataset.modifierId:"codex"===t?e.dataset.entityId:null).filter(e=>null!==e);"resource"===t?((e=>{c=e,localStorage.setItem("resourceOrder",JSON.stringify(e))})(o),console.log("Resource order saved:",o)):"asset"===t?((e=>{p=e,localStorage.setItem("assetOrder",JSON.stringify(e))})(o),console.log("Asset order saved:",o)):"modifier"===t&&((e=>{u=e,localStorage.setItem("modifierOrder",JSON.stringify(e))})(o),console.log("Modifier order saved:",o))},q=(e,t,o="id")=>{if(!t||0===t.length)return e;const r=new Map(e.map(e=>[e[o],e])),s=[],n=[];return t.forEach(e=>{const t=r.get(e);t&&(s.push(t),r.delete(e))}),r.forEach(e=>n.push(e)),[...s,...n]},F=e=>{const t=document.getElementById("header-container");if(!t)return;const o=e.title||"제 1장: 그림자의 길";t.innerHTML=`\n        <div class="flex justify-between items-center">\n            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>\n            <h1 class="text-2xl font-bold text-[var(--text-color-primary)] text-center cursor-pointer" id="header-title">${o}</h1>\n            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>\n        </div>\n        <div class="text-center text-sm text-[var(--text-color-secondary)] mt-2">\n            <span>${e.hud?.location||"알 수 없는 장소"}</span>\n            <span class="mx-2">·</span>\n            <span>${e.hud?.date||""}</span>\n            <span class="mx-2">·</span>\n            <span>${e.hud?.time||""}</span>\n        </div>\n    `,document.getElementById("header-title").addEventListener("click",H)},R=e=>{const t=document.getElementById("info-panel-container");if(!t||!e.scene_elements||0===e.scene_elements.length)return;t.innerHTML="";const o=e.page_number||0,r=L("div","relative w-full transition-all duration-300 ease-in-out cursor-pointer rounded-lg hover:bg-[var(--bg-panel)]");i&&r.classList.add("is-expanded","bg-[var(--bg-panel)]");const s=L("div","h-24"),n=L("div","relative w-full h-full flex items-center"),a=L("div","absolute left-[5%] top-1/2 w-[90%] h-0.5 bg-[var(--info-panel-line-color)]");n.appendChild(a);const l=[...e.scene_elements].sort((e,t)=>e.distance-t.distance),d=Math.max(...e.scene_elements.map(e=>Math.abs(e.distance)),5),c=[];let p=!1;l.forEach((e,t)=>{const s=Math.max(-d,Math.min(d,e.distance)),a=l.filter(t=>t.distance===e.distance),i=a.findIndex(t=>t.name===e.name),u=a.length,m=50+s/d*45+-2*(u-1)/2+2*i,g=L("div","absolute top-1/2");g.style.left=`${m}%`,g.style.transform="translate(-50%, -50%)";const h=L("div","w-3 h-3 rounded-full border-2 transition-all duration-200 ease-in-out relative flex items-center justify-center");let x,v;if("player"===e.type){const e="var(--player-color)";h.classList.add(`border-[${e}]`,`bg-[${e}]`),v="text-black",x=e}else{let t,o;"ally"===e.type?(t="var(--ally-color-border)",o="var(--ally-color-fill)"):"enemy"===e.type?(t="var(--enemy-color-border)",o="var(--enemy-color-fill)"):(t="var(--object-color-border)",o="var(--object-color-fill)"),h.classList.add(`border-[${t}]`,`bg-[${o}]`),v="text-white",x=t}r.classList.contains("is-expanded")&&(h.classList.remove("w-3","h-3"),h.classList.add("w-5","h-5"));const b=L("div","absolute bottom-full mb-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap");b.style.left="50%",b.style.transform="translateX(-50%)",b.style.color=x,b.style.fontSize="16px",b.style.fontWeight="bold",b.textContent=e.name,"player"===e.type&&1===o?b.style.opacity="1":b.style.opacity="0",h.appendChild(b);let f=null;"player"===e.type&&e.status&&(f=L("div","absolute top-full mt-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap text-xs text-[var(--text-color-secondary)]"),f.style.left="50%",f.style.transform="translateX(-50%)",f.textContent=e.status,f.style.opacity=1===o?"1":"0",h.appendChild(f));const y=String.fromCharCode(65+t),w=L("span",`relative text-xs font-bold ${v} opacity-0 transition-opacity duration-200`);w.textContent=y,r.classList.contains("is-expanded")&&(w.style.opacity="1"),h.appendChild(w),c.push({dot:h,indexSpan:w,elementWrapper:g,nameTooltip:b,statusTooltip:f,element:e}),g.addEventListener("mouseenter",()=>{r.classList.contains("is-expanded")||(b.style.opacity="1",f&&1===o&&(f.style.opacity="1"))}),g.addEventListener("mouseleave",()=>{"player"!==e.type||1!==o||p?(b.style.opacity="0",f&&(f.style.opacity="0")):(b.style.opacity="1",f&&(f.style.opacity="1"))}),g.appendChild(h),n.appendChild(g)}),r.addEventListener("mouseenter",()=>{p=!0,1===o&&c.forEach(({nameTooltip:e,statusTooltip:t,element:o})=>{"player"===o.type&&(e.style.opacity="0",t&&(t.style.opacity="0"))})}),r.addEventListener("mouseleave",()=>{p=!1,1!==o||r.classList.contains("is-expanded")||c.forEach(({nameTooltip:e,statusTooltip:t,element:o})=>{"player"===o.type&&(e.style.opacity="1",t&&(t.style.opacity="1"))})}),s.appendChild(n),r.appendChild(s);const u=L("div","max-h-0 overflow-hidden transition-all duration-300 ease-in-out relative"),m=L("ul","space-y-3 px-[5%] pb-12 opacity-0 transition-opacity duration-300");l.forEach((e,t)=>{const o=L("li","text-[var(--text-color-primary)]");let r;"player"===e.type?r="text-[var(--player-color)]":"ally"===e.type?r="text-[var(--ally-color-border)]":"enemy"===e.type?r="text-[var(--enemy-color-border)]":"object"===e.type&&(r="text-[var(--object-color-border)]");const s=String.fromCharCode(65+t);o.innerHTML=`<strong class="font-bold ${r}">${s}. ${e.name}:</strong> <span class="text-[var(--text-color-secondary)]">${e.status}</span>`,m.appendChild(o)}),u.appendChild(m),r.appendChild(u),r.classList.contains("is-expanded")&&(u.style.maxHeight=u.scrollHeight+"px",setTimeout(()=>{m.classList.add("opacity-100")},50),n.style.pointerEvents="none"),r.addEventListener("click",e=>{if(e.target.closest(".pointer-events-auto"))return;const t=r.classList.contains("is-expanded");i&&t||(r.classList.toggle("is-expanded")?(r.classList.add("bg-[var(--bg-panel)]"),u.style.maxHeight=u.scrollHeight+"px",setTimeout(()=>{m.classList.add("opacity-100")},50),n.style.pointerEvents="none",c.forEach(({dot:e,indexSpan:t})=>{e.classList.remove("w-3","h-3"),e.classList.add("w-5","h-5"),t.style.opacity="1"})):(r.classList.remove("bg-[var(--bg-panel)]"),m.classList.remove("opacity-100"),u.style.maxHeight="0px",n.style.pointerEvents="auto",c.forEach(({dot:e,indexSpan:t})=>{e.classList.remove("w-5","h-5"),e.classList.add("w-3","h-3"),t.style.opacity="0"})))}),t.appendChild(r)},U=e=>{const t=document.getElementById("choices-container");if(!t||!e.choices||0===e.choices.length)return;t.innerHTML="";const o=L("div","w-full pt-4");e.choices.forEach((e,t)=>{const r=L("div","w-full text-left py-2 text-[var(--text-color-primary)] text-lg"),s=(e=>{if(!e)return"";let t=e;return t=t.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),t=t.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),t})(e);r.innerHTML=`<span class="font-bold text-[var(--text-accent-bold)]">${t+1}.</span> ${s}`,o.appendChild(r)}),t.appendChild(o)},W=e=>{const t=document.getElementById("content-container");if(t)if(t.innerHTML="",e.story_html){const o=L("div","space-y-4");o.innerHTML=e.story_html,t.appendChild(o)}else if(e.main_content&&e.main_content.length>0){const o=L("div","space-y-4");e.main_content.forEach(e=>{const t=L("p");"narration"===e.id?(t.className="text-[var(--text-color-primary)] leading-loose text-lg",t.textContent=e.content):"thought"===e.id?(t.className="text-[var(--text-accent-bold)] leading-loose text-lg pl-4 border-l-2 border-[var(--ui-accent-secondary)]",t.textContent=e.content):"document"===e.id?(t.className="text-[var(--text-color-primary)] leading-relaxed text-base bg-[var(--bg-panel)]/50 p-4 rounded border border-[var(--border-color)]",t.textContent=e.content):"system"===e.id?(t.className="text-[var(--text-color-secondary)] text-sm text-center",t.textContent=e.content):"quote"===e.id?(t.className="text-[var(--text-accent-aux)] leading-relaxed text-lg pl-6 border-l-4 border-[var(--text-accent-aux)] italic",t.textContent=e.content):(t.className="text-[var(--text-color-primary)] leading-loose text-lg",t.innerHTML=`<span class="font-bold text-[var(--text-accent-italic)]">${e.id}:</span> ${e.content}`),o.appendChild(t)}),t.appendChild(o)}},G=e=>{let t=!0,o=null,r=0,s=0,i="";const l=document.getElementById("hud-container");if(!l)return;l.innerHTML="";const d=L("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(e.resources&&e.resources.length>0){let t=[...e.resources.filter(e=>null!==e.max&&void 0!==e.max),...e.resources.filter(e=>null===e.max||void 0===e.max)];t=q(t,c,"id");const o=L("ul","space-y-2 resource-list");o.setAttribute("data-list-type","resource"),t.forEach((e,t)=>{const r=((e,t)=>{const o=L("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");o.setAttribute("draggable","true"),o.setAttribute("data-index",t),o.dataset.resourceId=e.id;const r=e.max&&e.max>0?e.current/e.max*100:0;return o.innerHTML=`\n        <div class="flex justify-between items-baseline text-sm mb-1">\n            <span class="font-semibold text-[var(--text-color-primary)]">${e.name}</span>\n            <span class="font-mono text-[var(--text-color-secondary)]">${e.current}${e.max?"/"+e.max:""}</span>\n        </div>\n        ${e.max?`\n            <div class="w-full bg-black/30 rounded-full h-1.5 mb-1">\n                <div class="h-1.5 rounded-full transition-all duration-300" style="width: ${r}%; background-color: ${e.color};"></div>\n            </div>\n        `:""}\n        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${e.description}</p>`:""}\n    `,o.addEventListener("dragstart",B),o.addEventListener("dragend",D),o.addEventListener("dragover",J),o.addEventListener("drop",P),o})(e,t);o.appendChild(r)}),d.appendChild(o)}else{const e=L("p","text-sm text-[var(--text-color-secondary)] italic");e.textContent="자원 정보가 없습니다",d.appendChild(e)}if(e.modifiers&&e.modifiers.length>0){const t=L("div","mt-4 pt-3 border-t border-[var(--border-color)]"),o=L("ul","space-y-2 modifier-list");o.setAttribute("data-list-type","modifier"),q(e.modifiers,u,"id").forEach((e,t)=>{const r=((e,t)=>{const o=L("li","bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors");o.setAttribute("draggable","true"),o.setAttribute("data-index",t),o.dataset.modifierId=e.id;let r="text-[var(--ui-accent-secondary)]",s="";return"good"===e.alignment?(r="text-green-400",s="border-l-2 border-green-400"):"bad"===e.alignment?(r="text-red-400",s="border-l-2 border-red-400"):"neutral"===e.alignment&&(r="text-gray-400",s="border-l-2 border-gray-400"),o.className=`bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors ${s}`,o.innerHTML=`\n        <div class="flex justify-between items-baseline mb-1">\n            <span class="font-semibold ${r} text-sm">${e.name}</span>\n            ${e.duration?`<span class="text-xs text-[var(--text-color-secondary)]">${e.duration}</span>`:""}\n        </div>\n        <div class="text-xs text-[var(--text-color-secondary)]">\n            ${e.target} ${e.operation} ${e.value}\n        </div>\n        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${e.description}</p>`:""}\n    `,o.addEventListener("dragstart",B),o.addEventListener("dragend",D),o.addEventListener("dragover",J),o.addEventListener("drop",P),o})(e,t);o.appendChild(r)}),t.appendChild(o),d.appendChild(t)}const g=L("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(e.asset&&e.asset.length>0){const t=e.asset.reduce((e,t)=>{const o=t.category||"기타";return e[o]||(e[o]=[]),e[o].push(t),e},{});for(const e in t){const o=L("div","mb-4 last:mb-0");o.setAttribute("draggable","true"),o.dataset.categoryName=e,o.addEventListener("dragstart",B),o.addEventListener("dragend",D),o.addEventListener("dragover",J),o.addEventListener("drop",P);const r=!1!==n[e],s=L("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");s.innerHTML=`\n                            <span class="font-bold text-[var(--ui-accent-primary)] text-lg">${e}</span>\n                            <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${r?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>\n                        `,o.appendChild(s);const a=L("div","overflow-hidden transition-all duration-300 ease-in-out");a.style.maxHeight=r?a.scrollHeight+"px":"0px";const i=L("ul","space-y-2 mt-2 asset-list");i.setAttribute("data-list-type","asset"),q(t[e],p,"id").forEach((e,t)=>{const o=A(e,t);i.appendChild(o)}),a.appendChild(i),o.appendChild(a),g.appendChild(o),s.addEventListener("click",()=>{const t=s.querySelector("svg");"0px"===a.style.maxHeight||""===a.style.maxHeight?(a.style.maxHeight=a.scrollHeight+"px",t.classList.remove("rotate-180"),n[e]=!0):(a.style.maxHeight="0px",t.classList.add("rotate-180"),n[e]=!1)})}}else{const e=L("p","text-sm text-[var(--text-color-secondary)] italic");e.textContent="Asset이 없습니다",g.appendChild(e)}const h=L("div","hidden sm:block bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]"),x=[];if(e.codex_new&&e.codex_new.length>0&&x.push(...e.codex_new),e.codex_update&&e.codex_update.length>0&&x.push(...e.codex_update),x.length>0){const e=x.reduce((e,t)=>{let o="General";return t.data&&t.data.length>0&&t.data[0].category?o=t.data[0].category:"player_001"===t.id&&(o="Player"),e[o]||(e[o]=[]),e[o].push(t),e},{});for(const t in e){const o=L("div","mb-4 last:mb-0"),r=!1!==a[t],s=L("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");s.innerHTML=`\n                <span class="font-bold text-[var(--text-color-primary)] text-lg">${t}</span>\n                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${r?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>\n            `,o.appendChild(s);const n=L("div","overflow-hidden transition-all duration-300 ease-in-out");n.style.maxHeight=r?n.scrollHeight+"px":"0px";const i=L("ul","space-y-2 mt-2 codex-list");i.setAttribute("data-list-type","codex"),e[t].forEach((e,t)=>{const o=!("player_001"===e.id&&!x.some(e=>"player_002"===e.id)),r=j(e,o);i.appendChild(r)}),n.appendChild(i),o.appendChild(n),h.appendChild(o),s.addEventListener("click",()=>{const e=s.querySelector("svg");"0px"===n.style.maxHeight||""===n.style.maxHeight?(n.style.maxHeight=n.scrollHeight+"px",e.classList.remove("rotate-180"),a[t]=!0):(n.style.maxHeight="0px",e.classList.add("rotate-180"),a[t]=!1)})}}const v=[d,g,h],b=[];v.forEach(e=>{e.classList.add("flex","flex-col");const t=L("div","mt-4 w-full flex items-end");t.setAttribute("data-tip-spacer","true"),t.style.transition="height 300ms ease-out",t.style.willChange="height",e.appendChild(t),b.push(t),l.appendChild(e)});const f=()=>{const e=v,n=e.map(e=>{const t=e.querySelector('[data-tip-spacer="true"]'),o=t?t.style.display:"";t&&(t.style.display="none");const r=e.offsetHeight;return t&&(t.style.display=o),r});if(0===n.length)return;const a=Math.max(...n);if(e.forEach((e,t)=>{const o=n[t],r=a-o,s=e.querySelector('[data-tip-spacer="true"]');s&&(s.style.height=`${Math.max(0,r)}px`)}),clearTimeout(o),a<1e3)return void e.forEach(e=>{const t=e.querySelector('[data-tip-spacer="true"]');t&&(t.innerHTML="")});const l=[];e.forEach((e,t)=>{a-n[t]>50&&l.push({panel:e,index:t})});const d=l.length>0?l[l.length-1]:null;if(e.forEach((e,t)=>{if(!d||t!==d.index){const t=e.querySelector('[data-tip-spacer="true"]');t&&(t.innerHTML="")}}),!t&&d){const e=Date.now();if(e<s)return;const t=d.panel.querySelector('[data-tip-spacer="true"]');(e-r>1e4||""===i)&&(r=e,i=m[Math.floor(Math.random()*m.length)]);let n=t.querySelector("p");n||(n=document.createElement("p"),n.className="p-4 text-sm text-[var(--text-color-secondary)] italic transition-opacity duration-300 opacity-0",t.appendChild(n)),n.textContent=i,requestAnimationFrame(()=>n.classList.remove("opacity-0")),o=setTimeout(()=>{n.classList.add("opacity-0"),s=Date.now()+1e4,setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300)},5e3)}},y=new ResizeObserver(f);v.forEach(e=>{y.observe(e)}),setTimeout(()=>{f(),t=!1},150)},X=()=>{const e=document.getElementById("app-root");e.innerHTML="";const t=L("div","max-w-5xl mx-auto p-4 sm:p-6"),o=L("div","mb-8");o.id="header-container";const r=L("div","my-8");r.id="content-container";const s=L("div","my-1");s.id="info-panel-container";const n=L("div");n.id="choices-container";const a=L("div","relative mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 items-start");a.id="hud-container";const l=L("div","flex justify-end gap-2 mt-2");l.id="hud-controls-container";const d=L("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");d.id="image-button",d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',d.addEventListener("click",E);const c=L("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");c.id="page-button",c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',c.addEventListener("click",H);const p=L("button","sm:hidden p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");p.id="codex-button",p.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>';const u=L("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");u.id="pin-infopanel-button",u.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',u.addEventListener("click",()=>{i=!i,u.classList.toggle("bg-[var(--ui-accent-primary)]",i);const e=document.querySelector("#info-panel-container > div");if(e){const t=e.classList.contains("is-expanded");(i&&!t||!i&&t)&&e.click()}});const m=L("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");m.id="settings-button",m.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67c-.2.2-.3.3-.3.3s-.2.1-.3.1c-.2.1-.4.1-.6.1-.2 0-.4 0-.6-.1a1.65 1.65 0 0 0-1.67-.3c-.2-.2-.3-.3-.3-.3s-.1-.2-.1-.3c-.1-.2-.1-.4-.1-.6 0-.2 0-.4.1-.6a1.65 1.65 0 0 0 .3-1.67c.2-.2.3-.3.3-.3s-.2-.1.3-.1c.2-.1.4-.1.6-.1.2 0 .4 0 .6.1a1.65 1.65 0 0 0 1.67.3c.2.2.3.3.3.3s.1.2.1.3c.1.2.1.4.1.6 0 .2 0 .4-.1.6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';const g=L("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors border border-[var(--border-color)]");g.id="debug-button",g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="6" width="8" height="1"></rect><rect x="8" y="11" width="8" height="1"></rect><rect x="8" y="16" width="8" height="1"></rect><path d="M12 3v3"></path><path d="M12 18v3"></path><path d="M4 9h2"></path><path d="M18 9h2"></path><path d="M4 15h2"></path><path d="M18 15h2"></path><circle cx="12" cy="12" r="9"></circle></svg>',g.title="Debug Data Browser",l.appendChild(d),l.appendChild(c),l.appendChild(p),l.appendChild(u),l.appendChild(m),l.appendChild(g),t.append(o,r,s,n,l,a),e.appendChild(t)};document.addEventListener("DOMContentLoaded",async()=>{await(async()=>{try{(()=>{try{const a="undefined"!=typeof __firebase_config?JSON.parse(__firebase_config):null,i="undefined"!=typeof __initial_auth_token?__initial_auth_token:null;let l;if(a)l=initializeApp(a);else{if(!(firebase.apps.length>0))return console.warn("Firebase config not found and no existing app. Running in offline mode."),!1;l=firebase.app(),console.log("Firebase app already initialized, using existing app.")}return n=getAuth(l),e=n,s=getFirestore(l),t=s,onAuthStateChanged(e,async t=>{if(t)s=t.uid,r=s,o=!0,console.log("Firebase authenticated:",t.uid);else if(i)try{await signInWithCustomToken(e,i)}catch(e){console.error("Custom token sign-in failed:",e)}else console.warn("No authentication available");var s}),!0}catch(e){return console.error("Firebase initialization error:",e),!1}var s,n})();let n=b();const a=n.sessionId;let i={resources:[],asset:[],modifiers:[],codex_new:[],codex_update:[]};i=e&&r?await(async(e,t,o)=>{const r={resources:[],asset:[],modifiers:[],entities:[]},n=f(),a=e||s,i=doc(t,`artifacts/${n}/users/${a}/sessions/${o}/game_state/current_state`),l=await getDoc(i);l.exists()&&(r.resources=l.data().resources||[],r.asset=l.data().asset||[],r.modifiers=l.data().modifiers||[]);const d=collection(t,`artifacts/${n}/users/${a}/sessions/${o}/codex_entities`);return(await getDocs(d)).forEach(e=>{r.entities.push(e.data())}),r})(r,t,a):((e,t)=>{const o={resources:[],asset:[],modifiers:[],entities:[]},r=f(),n=e||s;return o.resources=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${n}_sessions_${t}_resources`)||"[]"),o.asset=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${n}_sessions_${t}_asset`)||"[]"),o.modifiers=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${n}_sessions_${t}_modifiers`)||"[]"),o.entities=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${n}_sessions_${t}_entities`)||"[]"),o})(r,a),n.resources=y(i.resources,n.resources,"id"),n.asset=y(i.asset,n.asset,"id"),n.modifiers=y(i.modifiers,n.modifiers,"id"),n.codex_new=y(i.entities,n.codex_new,"id"),n.codex_update&&n.codex_update.length>0&&(n.codex_new=y(n.codex_new,n.codex_update,"id"),n.codex_update=[]),await(async(t,o,n)=>{try{const a=v(),i=t||s,l=n.page_number,d=`processed_pages_${a}`;let c=JSON.parse(localStorage.getItem(d)||"[]");const p=c.find(e=>e.page_number===l),u=Date.now();if(p)return void console.log(`Page ${l} was already processed in this session. Skipping duplicate save.`);if(c.push({page_number:l,timestamp:u}),localStorage.setItem(d,JSON.stringify(c)),e&&r){if(n.codex_new&&n.codex_new.length>0&&await C(i,o,"new",n.codex_new,a),n.codex_update&&n.codex_update.length>0&&await C(i,o,"update",n.codex_update,a),n.resources&&n.resources.length>0&&await C(i,o,"resources",n.resources,a),n.asset&&n.asset.length>0&&await C(i,o,"asset",n.asset,a),n.modifiers&&n.modifiers.length>0&&await C(i,o,"modifiers",n.modifiers,a),n.removed){for(const e of n.removed.entities)await $(i,o,"entity",e,a);for(const e of n.removed.resources)await $(i,o,"resource",e,a);for(const e of n.removed.assets)await $(i,o,"asset",e,a);for(const e of n.removed.modifiers)await $(i,o,"modifier",e,a)}const e=collection(o,`artifacts/${f()}/users/${i}/page_index`),t=`${a}_${n.page_number}`,r=doc(e,t);await setDoc(r,{sessionId:a,page_number:n.page_number,title:n.header.title,timestamp:serverTimestamp()},{merge:!0}),console.log(`Page index entry for page ${n.page_number} in session ${a} saved to Firebase.`),console.log("All codex data processed and saved successfully to Firebase.")}else{if(n.codex_new&&n.codex_new.length>0&&w(i,"entities",n.codex_new,a),n.codex_update&&n.codex_update.length>0&&w(i,"entities",n.codex_update,a),n.resources&&n.resources.length>0&&w(i,"resources",n.resources,a),n.asset&&n.asset.length>0&&w(i,"asset",n.asset,a),n.modifiers&&n.modifiers.length>0&&w(i,"modifiers",n.modifiers,a),n.removed){for(const e of n.removed.entities)_(i,"entities",e,a);for(const e of n.removed.resources)_(i,"resources",e,a);for(const e of n.removed.assets)_(i,"asset",e,a);for(const e of n.removed.modifiers)_(i,"modifiers",e,a)}console.log(`All codex data processed and saved successfully to localStorage for session ${a}.`);const e="saved_pages";let t=JSON.parse(localStorage.getItem(e)||"[]");const o={sessionId:a,page_number:n.page_number,title:n.header.title,timestamp:(new Date).toISOString()},r=t.findIndex(e=>e.sessionId===a&&e.page_number===n.page_number);r>-1?t[r]=o:t.push(o),localStorage.setItem(e,JSON.stringify(t)),console.log(`Page index entry for page ${n.page_number} in session ${a} saved to localStorage index.`)}}catch(e){console.error("Error processing codex data:",e)}})(r,t,n),await(async(t,o,n)=>{try{const a=v(),i=t||s,d=n.page_number,c=`snapshot_pages_${a}`;let p=JSON.parse(localStorage.getItem(c)||"[]");const u=p.find(e=>e.page_number===d),m=Date.now();if(u)return void console.log(`Page ${d} snapshot was already saved in this session. Skipping duplicate save.`);if(p.push({page_number:d,timestamp:m}),localStorage.setItem(c,JSON.stringify(p)),e&&r){const e=f(),t=doc(o,`artifacts/${e}/users/${i}/pages/${a}`),r={sessionId:a,page_number:n.page_number,header:n.header,story_html:n.story_html,choices:n.choices,scene_elements:n.scene_elements,resources:n.resources,asset:n.asset,modifiers:n.modifiers,html_docs:n.html_docs,codex_new:n.codex_new,codex_update:n.codex_update,current_theme:l,timestamp:serverTimestamp()};await setDoc(t,r,{merge:!0}),console.log(`Page snapshot for session ${a} saved successfully to Firebase.`)}else{const e=`page_snapshot_${a}`,t={sessionId:a,page_number:n.page_number,header:n.header,story_html:n.story_html,choices:n.choices,scene_elements:n.scene_elements,resources:n.resources,asset:n.asset,modifiers:n.modifiers,html_docs:n.html_docs,codex_new:n.codex_new,codex_update:n.codex_update,current_theme:l};localStorage.setItem(e,JSON.stringify(t)),console.log(`Page snapshot for session ${a} saved successfully to localStorage.`)}}catch(e){console.error("Error saving page snapshot:",e)}})(r,t,n);let c=(()=>{const e=document.getElementById("available-themes");return e&&e.textContent.trim()?e.textContent.trim().split("|").map(e=>e.trim()):["modern","material-dark","material-light","cyberpunk-dark"]})()[0]||"modern";d&&g.includes(d)&&(c=d),h(c),X(),F(n),W(n),R(n),U(n),G(n);const p=document.getElementById("codex-button");p&&p.addEventListener("click",M);const u=document.getElementById("settings-button");u&&u.addEventListener("click",N);const m=document.getElementById("debug-button");m&&m.addEventListener("click",T),console.log("Application initialized successfully")}catch(e){console.error("Initialization Error:",e),document.body.innerHTML=`<div class="text-red-400 p-8">Error: ${e.message}</div>`}})()})}();
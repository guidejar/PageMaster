var et=Object.defineProperty;var _e=(t,o)=>()=>(t&&(o=t(t=0)),o);var Je=(t,o)=>{for(var e in o)et(t,e,{get:o[e],enumerable:!0})};var F={};Je(F,{DEFAULT_OFFLINE_USER_ID:()=>B,applyTheme:()=>Q,assetCategoryStates:()=>G,assetOrder:()=>pe,auth:()=>H,codexCategoryStates:()=>j,controlTips:()=>fe,currentThemeName:()=>ce,currentUserId:()=>M,db:()=>T,isAuthReady:()=>qe,isInfoPanelPinned:()=>R,modifierOrder:()=>ue,parseAvailableThemes:()=>Pe,resourceOrder:()=>de,saveAssetOrder:()=>Oe,saveModifierOrder:()=>He,saveResourceOrder:()=>Me,setAuth:()=>Ie,setCurrentThemeName:()=>Fe,setCurrentUserId:()=>Ee,setDb:()=>Le,setIsAuthReady:()=>D,setIsInfoPanelPinned:()=>ke,themeNames:()=>Y,userPreferredTheme:()=>X});var H,T,qe,M,B,G,j,R,ce,X,de,pe,ue,fe,Y,Ie,Le,D,Ee,ke,Fe,Me,Oe,He,Q,Pe,A=_e(()=>{H=null,T=null,qe=!1,M=null,B="offline-user",G={},j={},R=!1,ce="default",X=localStorage.getItem("userPreferredTheme")||null,de=JSON.parse(localStorage.getItem("resourceOrder")||"[]"),pe=JSON.parse(localStorage.getItem("assetOrder")||"[]"),ue=JSON.parse(localStorage.getItem("modifierOrder")||"[]"),fe=["\uC120\uD0DD\uC9C0 \uC704\uC5D0 \uC788\uB294 \uAC00\uB85C\uC904\uACFC \uC810\uB4E4\uC740 \uC778\uD3EC\uD328\uB110\uC785\uB2C8\uB2E4. \uD55C\uBC88 \uB20C\uB7EC\uBCF4\uC138\uC694.","\uC120\uD0DD\uC9C0 \uC6B0\uCE21 \uD558\uB2E8\uC5D0 \uC704\uCE58\uD55C \uC544\uC774\uCF58\uC744 \uB20C\uB7EC\uD574\uBCF4\uC138\uC694.","\uB4DC\uB798\uADF8 \uC564 \uB4DC\uB86D\uC73C\uB85C \uBAA9\uB85D\uC758 \uC704\uCE58\uB97C \uBC14\uAFD4\uBCF4\uC138\uC694.","\uD398\uC774\uC9C0 \uC81C\uBAA9\uC744 \uD074\uB9AD\uD558\uBA74 \uD398\uC774\uC9C0 \uBAA9\uB85D\uC774 \uB098\uC635\uB2C8\uB2E4.","\uD398\uC774\uC9C0 \uC591 \uC606\uC758 \uD654\uC0B4\uD45C\uB85C \uD398\uC774\uC9C0\uB97C \uC774\uB3D9\uD560 \uC218 \uC788\uC5B4\uC694.","\uC120\uD0DD\uC9C0 \uC544\uB798\uC5D0 \uC788\uB294 \uC774\uBBF8\uC9C0 \uC544\uC774\uCF58\uC744 \uD074\uB9AD\uD558\uBA74 \uD574\uB2F9 \uC7A5\uBA74\uC5D0 \uB9DE\uB294 \uC774\uBBF8\uC9C0\uB97C \uC0DD\uC131\uD560 \uC218 \uC788\uC5B4\uC694."],Y=["fantasy","stone-cyan-dark","cyberpunk","horror","modern","cyberpunk-dark","material-dark","material-light"],Ie=t=>{H=t},Le=t=>{T=t},D=t=>{qe=t},Ee=t=>{M=t},ke=t=>{R=t},Fe=t=>{ce=t},Me=t=>{de=t,localStorage.setItem("resourceOrder",JSON.stringify(t))},Oe=t=>{pe=t,localStorage.setItem("assetOrder",JSON.stringify(t))},He=t=>{ue=t,localStorage.setItem("modifierOrder",JSON.stringify(t))},Q=t=>{document.body.className=document.body.className.split(" ").filter(o=>!o.startsWith("theme-")).join(" "),document.body.classList.add(`theme-${t}`),Fe(t),console.log(`Applied theme: ${t}`)},Pe=()=>{let t=document.getElementById("available-themes");return t&&t.textContent.trim()?t.textContent.trim().split("|").map(o=>o.trim()):["modern","material-dark","material-light","cyberpunk-dark"]}});var tt,ot,Ke,rt,st,nt,at,Te,q,K,Z=_e(()=>{ee();tt=()=>{let t={};return document.querySelectorAll('script[type="text/html"]').forEach(o=>{let e=o.getAttribute("data-id"),r=o.getAttribute("data-category");e&&(t[e]={category:r||"unknown",content:o.innerHTML.trim()})}),t},ot=t=>{if(!t)return"";let o=t;return o=o.replace(/^### (.+)$/gm,'<h3 class="text-xl font-bold text-[var(--text-color-primary)] mt-4 mb-2">$1</h3>'),o=o.replace(/^## (.+)$/gm,'<h2 class="text-2xl font-bold text-[var(--text-color-primary)] mt-6 mb-3">$1</h2>'),o=o.replace(/^# (.+)$/gm,'<h1 class="text-3xl font-bold text-[var(--text-color-primary)] mt-8 mb-4">$1</h1>'),o=o.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),o=o.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),o=o.replace(/\n\n/g,'</p><p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'),o='<p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'+o+"</p>",o},Ke=t=>{if(!t)return"";let o=t;return o=o.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),o=o.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),o},rt=()=>{let t=document.getElementById("header");if(!t)return{title:"",location:"",date:"",time:""};let e=t.textContent.trim().split("|").map(r=>r.trim());return{title:e[0]||"",location:e[1]||"",date:e[2]||"",time:e[3]||""}},st=()=>{let t=document.getElementById("story");return t?ot(t.textContent.trim()):""},nt=()=>{let t=document.getElementById("choices");return t?t.textContent.trim().split(`
`).map(r=>r.trim()).filter(r=>r).map(r=>r.replace(/^\d+\.\s*/,"").trim()):[]},at=()=>{let t=document.getElementById("scene-data");return t?t.textContent.trim().split(`
`).map(r=>r.trim()).filter(r=>r).map(r=>{let s=r.split("|").map(i=>i.trim());return{type:s[1]||"",name:s[2]||"",distance:s[3]?Number(s[3]):0,status:s[4]||""}}).filter(r=>r.type):[]},Te=t=>{let o=document.querySelectorAll('script[id="codex"]'),e=null;o.forEach(g=>{g.getAttribute("data-type")===t&&(e=g)});let r={entities:[],resources:[],assets:[],modifiers:[],removed:{entities:[],resources:[],assets:[],modifiers:[]}};if(!e)return r;let i=e.textContent.trim().split(`
`).map(g=>g.trim()).filter(g=>g),d={},p={},v={},f={};return i.forEach(g=>{let b=g.indexOf("|");if(b===-1)return;let w=g.substring(0,b).trim(),l=g.substring(b+1).trim(),h=w.split("."),u=h[0],a=h[1],c=h.slice(2);if(t==="remove"){u==="entity"?r.removed.entities.push(a):u==="resource"?r.removed.resources.push(a):u==="asset"?r.removed.assets.push(a):u==="effect"&&r.removed.modifiers.push(a);return}if(u==="entity"){d[a]||(d[a]={id:a,classifications:{}});let x=d[a];if(c.length===1){let m=c[0];x[m]=l}else if(c[0]==="classifications"&&c.length===2){let m=c[1],y=l.indexOf(":");if(y>-1){let I=l.substring(0,y).trim(),$=l.substring(y+1).trim();x.classifications[m]={label:I,value:$}}else x.classifications[m]={label:m,value:l}}}else if(u==="resource"){p[a]||(p[a]={id:a});let x=p[a],m=c[0];m==="current"||m==="max"?x[m]=l==="NULL"?null:Number(l):x[m]=l}else if(u==="asset"){v[a]||(v[a]={id:a,properties:{}});let x=v[a];if(c.length===1){let m=c[0];m==="quantity"?x[m]=Number(l):x[m]=l}else if(c[0]==="properties"&&c.length===2){let m=c[1],y=l.indexOf(":");if(y>-1){let I=l.substring(0,y).trim(),$=l.substring(y+1).trim();x.properties[m]={label:I,value:$}}else x.properties[m]={label:m,value:l}}}else if(u==="effect"){f[a]||(f[a]={id:a});let x=f[a],m=c[0];x[m]=l}}),r.entities=Object.values(d),r.resources=Object.values(p),r.assets=Object.values(v),r.modifiers=Object.values(f),r},q=()=>{let t=document.getElementById("session-uuid");if(t&&t.textContent.trim()){let e=t.textContent.trim();return console.log(`Session ID loaded from HTML: ${e}`),e}let o=localStorage.getItem("gameSessionId");return o||(o=crypto.randomUUID(),localStorage.setItem("gameSessionId",o),console.warn("New Session ID generated and stored in localStorage.")),o},K=()=>{let t=rt(),o=st(),e=nt(),r=at(),s=Te("new"),i=Te("update"),d=Te("remove"),p=s.entities,v=i.entities,f=[...s.resources,...i.resources],g=[...s.assets,...i.assets],b=[...s.modifiers,...i.modifiers],w=d.removed,l=document.querySelector("title"),h=l?parseInt(l.textContent.match(/\d+/)?.[0]||"0"):0,u=tt();return{sessionId:q(),header:t,story_html:o,choices:e,scene_elements:r,codex_new:p,codex_update:v,resources:f,asset:g,modifiers:b,removed:w,html_docs:u,page_number:h,define:p,update:v,hud:{location:t.location,date:t.date,time:t.time},title:t.title,character_stats:{resources:f,attributes:{},equipment:{},name:"",level:1},information_panel:[]}}});var Ve={};Je(Ve,{deleteFromFirestore:()=>oe,deleteFromLocalStorage:()=>te,getAppId:()=>he,getPrivateCollectionRef:()=>ft,initializeFirebase:()=>Ae,loadPageSnapshot:()=>Be,loadPersistentCodex:()=>je,loadPersistentCodexFromLocalStorage:()=>gt,mergeArrayByName:()=>N,processAndSaveCodex:()=>Re,savePageSnapshot:()=>Ne,saveToFirestore:()=>W,saveToLocalStorage:()=>V});import{getAuth as it,signInWithCustomToken as lt,onAuthStateChanged as ct}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore as dt,collection as me,doc as U,getDoc as xe,setDoc as re,serverTimestamp as ge,getDocs as pt,deleteDoc as ut}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";var he,ft,Ae,N,Ne,Be,je,gt,V,te,W,oe,Re,ee=_e(()=>{A();Z();he=()=>typeof __app_id<"u"?__app_id:"default-app-id",ft=(t,o,e,r)=>{let s=`artifacts/${o}/users/${e}/${r}`;return me(t,s)},Ae=t=>new Promise(o=>{try{let e=typeof __firebase_config<"u"?JSON.parse(__firebase_config):{},r=typeof __initial_auth_token<"u"?__initial_auth_token:null,s;if(typeof t>"u"&&typeof firebase<"u"&&typeof firebase.initializeApp<"u")t=firebase.initializeApp,console.warn("Using global firebase.initializeApp as passed parameter was undefined.");else if(typeof t>"u"){console.error("initializeApp function not provided. Cannot initialize Firebase."),D(!1),o();return}if(Object.keys(e).length>0)s=t(e);else if(typeof firebase<"u"&&firebase.apps.length>0)s=firebase.app(),console.log("Firebase app already initialized, using existing app.");else{console.warn("Firebase config not found and no existing app. Running in offline mode."),D(!1),o();return}Ie(it(s)),Le(dt(s)),ct(H,async i=>{if(i)Ee(i.uid),D(!0),console.log("Firebase authenticated:",i.uid),o();else if(r)try{await lt(H,r)}catch(d){console.error("Custom token sign-in failed:",d);try{await signInAnonymously(H)}catch(p){console.error("Anonymous sign-in failed after custom token failure:",p),console.warn("No authentication available, running in offline mode."),D(!1),o()}}else try{await signInAnonymously(H)}catch(d){console.error("Anonymous sign-in failed:",d),console.warn("No authentication available, running in offline mode."),D(!1),o()}})}catch(e){console.error("Firebase initialization error:",e),D(!1),o()}}),N=(t,o,e="name")=>{if(!t||t.length===0)return o;if(!o||o.length===0)return t;let r=new Map;return t.forEach(s=>{s[e]&&r.set(s[e],s)}),o.forEach(s=>{s[e]&&r.set(s[e],{...r.get(s[e]),...s})}),Array.from(r.values())},Ne=async(t,o,e)=>{try{let r=q(),s=t||B,i=e.page_number,d=`snapshot_pages_${r}`,p=JSON.parse(localStorage.getItem(d)||"[]"),v=p.find(c=>c.page_number===i),f=Date.now();if(v){console.log(`Page ${i} snapshot was already saved in this session. Skipping duplicate save.`);return}else p.push({page_number:i,timestamp:f}),localStorage.setItem(d,JSON.stringify(p));let{resourceOrder:g,assetOrder:b,modifierOrder:w,assetCategoryStates:l,codexCategoryStates:h,isInfoPanelPinned:u,currentThemeName:a}=await Promise.resolve().then(()=>(A(),F));if(H&&M){let c=he(),x=U(o,`artifacts/${r}/users/${s}/pages/page_${i}`),m={...e,globalStates:{resourceOrder:g,assetOrder:b,modifierOrder:w,assetCategoryStates:l,codexCategoryStates:h,isInfoPanelPinned:u,currentThemeName:a},timestamp:ge()};await re(x,m,{merge:!0}),console.log(`Page snapshot saved to Firebase: ${r}/page_${i} (Theme: ${a})`)}else{let c=`page_snapshot_${r}_${i}`,x={...e,globalStates:{resourceOrder:g,assetOrder:b,modifierOrder:w,assetCategoryStates:l,codexCategoryStates:h,isInfoPanelPinned:u,currentThemeName:a},timestamp:new Date().toISOString()};localStorage.setItem(c,JSON.stringify(x)),console.log(`Page snapshot saved to localStorage: ${c} (Theme: ${a})`)}}catch(r){console.error("Error saving page snapshot:",r)}},Be=async(t,o,e,r)=>{try{let s=t||B;if(H&&M){let i=he(),d=U(o,`artifacts/${e}/users/${s}/pages/page_${r}`),p=await xe(d);return p.exists()?(console.log(`Page snapshot loaded from Firebase: ${e}/page_${r}`),p.data()):(console.log(`No snapshot found: ${e}/page_${r}`),null)}else{let i=`page_snapshot_${e}_${r}`,d=localStorage.getItem(i);return d?(console.log(`Page snapshot loaded from localStorage: ${i}`),JSON.parse(d)):(console.log(`No snapshot found in localStorage: ${i}`),null)}}catch(s){return console.error("Error loading page snapshot:",s),null}},je=async(t,o,e)=>{let r={resources:[],asset:[],modifiers:[],entities:[]},s=t||B,i=U(o,`artifacts/${e}/users/${s}/game_state/current_state`),d=await xe(i);d.exists()&&(r.resources=d.data().resources||[],r.asset=d.data().asset||[],r.modifiers=d.data().modifiers||[]);let p=me(o,`artifacts/${e}/users/${s}/codex_entities`);return(await pt(p)).forEach(f=>{r.entities.push(f.data())}),r},gt=(t,o)=>{let e={resources:[],asset:[],modifiers:[],entities:[]},r=t||B;return e.resources=JSON.parse(localStorage.getItem(`artifacts_${o}_users_${r}_resources`)||"[]"),e.asset=JSON.parse(localStorage.getItem(`artifacts_${o}_users_${r}_asset`)||"[]"),e.modifiers=JSON.parse(localStorage.getItem(`artifacts_${o}_users_${r}_modifiers`)||"[]"),e.entities=JSON.parse(localStorage.getItem(`artifacts_${o}_users_${r}_entities`)||"[]"),e},V=(t,o,e,r)=>{let i=`artifacts_${r}_users_${t||B}_${o}`,d=JSON.parse(localStorage.getItem(i)||"[]"),p=e;d.length>0&&(p=N(d,e,"id")),localStorage.setItem(i,JSON.stringify(p)),console.log(`Data type ${o} for session ${r} saved to localStorage.`)},te=(t,o,e,r)=>{let i=`artifacts_${r}_users_${t||B}_${o}`,p=JSON.parse(localStorage.getItem(i)||"[]").filter(v=>v.id!==e);localStorage.setItem(i,JSON.stringify(p)),console.log(`Item ${e} of type ${o} for session ${r} deleted from localStorage.`)},W=async(t,o,e,r,s)=>{try{let i=he();if(e==="new"||e==="update"){let d=me(o,`artifacts/${s}/users/${t}/codex_entities`);for(let p of r)if(p.id){let v=U(d,p.id);await re(v,{...p,updatedAt:ge()},{merge:!0})}console.log(`Codex entities (${e}) saved for session ${s}:`,r.length)}else if(e==="resources"||e==="asset"||e==="modifiers"){let d=U(o,`artifacts/${s}/users/${t}/game_state/current_state`),p=await xe(d),v=p.exists()?p.data():{},f=r;v[e]&&(f=N(v[e],r,"id")),await re(d,{[e]:f,updatedAt:ge()},{merge:!0}),console.log(`Game state (${e}) saved for session ${s}:`,f.length)}}catch(i){console.error(`Firestore \uC800\uC7A5 \uC2E4\uD328 [${e}] for session ${s}:`,i)}},oe=async(t,o,e,r,s)=>{try{let i;if(e==="entity")i=U(o,`artifacts/${s}/users/${t}/codex_entities`,r),await ut(i),console.log(`Entity ${r} deleted from session ${s}.`);else if(e==="resource"||e==="asset"||e==="modifier"){let d=U(o,`artifacts/${s}/users/${t}/game_state/current_state`),p=await xe(d);if(p.exists()){let f=(p.data()[e+"s"]||[]).filter(g=>g.id!==r);await re(d,{[e+"s"]:f},{merge:!0}),console.log(`${e} ${r} removed from game_state for session ${s}.`)}}}catch(i){console.error(`Error deleting ${e} ${r} for session ${s}:`,i)}},Re=async(t,o,e)=>{try{let r=q(),s=t||B,i=e.page_number,d=`processed_pages_${r}`,p=JSON.parse(localStorage.getItem(d)||"[]"),v=p.find(g=>g.page_number===i),f=Date.now();if(v){console.log(`Page ${i} was already processed in this session. Skipping duplicate save.`);return}else p.push({page_number:i,timestamp:f}),localStorage.setItem(d,JSON.stringify(p));if(H&&M){if(e.codex_new&&e.codex_new.length>0&&await W(s,o,"new",e.codex_new,r),e.codex_update&&e.codex_update.length>0&&await W(s,o,"update",e.codex_update,r),e.resources&&e.resources.length>0&&await W(s,o,"resources",e.resources,r),e.asset&&e.asset.length>0&&await W(s,o,"asset",e.asset,r),e.modifiers&&e.modifiers.length>0&&await W(s,o,"modifiers",e.modifiers,r),e.removed){for(let l of e.removed.entities)await oe(s,o,"entity",l,r);for(let l of e.removed.resources)await oe(s,o,"resource",l,r);for(let l of e.removed.assets)await oe(s,o,"asset",l,r);for(let l of e.removed.modifiers)await oe(s,o,"modifier",l,r)}let g=me(o,`artifacts/${r}/users/${s}/page_index`),b=`${r}_${e.page_number}`,w=U(g,b);await re(w,{sessionId:r,page_number:e.page_number,title:e.header.title,timestamp:ge()},{merge:!0}),console.log(`Page index entry for page ${e.page_number} in session ${r} saved to Firebase.`),console.log("All codex data processed and saved successfully to Firebase.")}else{if(e.codex_new&&e.codex_new.length>0&&V(s,"entities",e.codex_new,r),e.codex_update&&e.codex_update.length>0&&V(s,"entities",e.codex_update,r),e.resources&&e.resources.length>0&&V(s,"resources",e.resources,r),e.asset&&e.asset.length>0&&V(s,"asset",e.asset,r),e.modifiers&&e.modifiers.length>0&&V(s,"modifiers",e.modifiers,r),e.removed){for(let h of e.removed.entities)te(s,"entities",h,r);for(let h of e.removed.resources)te(s,"resources",h,r);for(let h of e.removed.assets)te(s,"asset",h,r);for(let h of e.removed.modifiers)te(s,"modifiers",h,r)}console.log(`All codex data processed and saved successfully to localStorage for session ${r}.`);let g="saved_pages",b=JSON.parse(localStorage.getItem(g)||"[]"),w={sessionId:r,page_number:e.page_number,title:e.header.title,timestamp:new Date().toISOString()},l=b.findIndex(h=>h.sessionId===r&&h.page_number===e.page_number);l>-1?b[l]=w:b.push(w),localStorage.setItem(g,JSON.stringify(b)),console.log(`Page index entry for page ${e.page_number} in session ${r} saved to localStorage index.`)}}catch(r){console.error("Error processing codex data:",r)}}});ee();Z();A();Z();A();Z();ee();var n=(t,o="",e="")=>{let r=document.createElement(t);return o&&(r.className=o),e&&(r.textContent=e),r},Ge=()=>{let t=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");t.id="active-overlay";let o=n("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6");o.innerHTML=`<h2 class="text-2xl font-bold text-[var(--ui-accent-primary)] mb-4">Image Modal (Placeholder)</h2><p>Image content will go here.</p><button class="mt-4 p-2 bg-[var(--ui-accent-primary)] rounded" onclick="document.getElementById('active-overlay').remove()">Close</button>`,t.appendChild(o),document.body.appendChild(t)},We=async(t,o)=>{let e=await Be(M,T,t,o);if(!e){console.warn(`Could not load snapshot for session ${t}, page ${o}.`);return}console.log(`Loading snapshot: ${t}/page_${o} - complete data restoration`);let{applyTheme:r}=await Promise.resolve().then(()=>(A(),F)),s=e.globalStates?.currentThemeName||e.current_theme;if(s&&(console.log(`Applying theme from snapshot: ${s}`),r(s)),e.globalStates){let{setIsInfoPanelPinned:d,saveResourceOrder:p,saveAssetOrder:v,saveModifierOrder:f}=await Promise.resolve().then(()=>(A(),F));if(e.globalStates.isInfoPanelPinned!==void 0&&d(e.globalStates.isInfoPanelPinned),e.globalStates.resourceOrder&&p(e.globalStates.resourceOrder),e.globalStates.assetOrder&&v(e.globalStates.assetOrder),e.globalStates.modifierOrder&&f(e.globalStates.modifierOrder),e.globalStates.assetCategoryStates){let{assetCategoryStates:g}=await Promise.resolve().then(()=>(A(),F));Object.assign(g,e.globalStates.assetCategoryStates)}if(e.globalStates.codexCategoryStates){let{codexCategoryStates:g}=await Promise.resolve().then(()=>(A(),F));Object.assign(g,e.globalStates.codexCategoryStates)}}let i=document.getElementById("app-root");i.innerHTML="",Se(),ve(e),we(e),be(e),ye(e),Ce(e),console.log(`Page snapshot fully restored: ${t}/page_${o} with theme: ${s}`)},De=async()=>{let{getDocs:t,collection:o,query:e,orderBy:r}=await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"),s=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");s.id="active-overlay";let i=n("div","w-full max-w-2xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),d=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),p=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uD398\uC774\uC9C0 \uBE0C\uB77C\uC6B0\uC9D5");d.appendChild(p);let v=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");v.textContent="\xD7",v.onclick=()=>s.remove(),d.appendChild(v),i.appendChild(d);let f=n("div","flex-grow overflow-y-auto"),g=n("p","text-[var(--text-color-secondary)]","\uD398\uC774\uC9C0 \uBAA9\uB85D \uBD88\uB7EC\uC624\uB294 \uC911...");if(f.appendChild(g),i.appendChild(f),s.appendChild(i),document.body.appendChild(s),H&&T&&M){let b=q(),w=o(T,`artifacts/${b}/users/${M}/page_index`),l=e(w,r("timestamp","desc")),h=await t(l);if(f.innerHTML="",h.empty)f.innerHTML='<p class="text-[var(--text-color-secondary)]">\uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let u=n("ul","space-y-2");h.forEach(a=>{let c=a.data(),x=n("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),m=c.timestamp?new Date(c.timestamp.toDate()).toLocaleString():"\uB0A0\uC9DC \uC5C6\uC74C";x.innerHTML=`
                    <div class="font-bold text-[var(--text-color-primary)]">${c.title||"\uC81C\uBAA9 \uC5C6\uC74C"} (Page ${c.page_number})</div>
                    <div class="text-sm text-[var(--text-color-secondary)]">\uC800\uC7A5 \uC2DC\uAC04: ${m}</div>
                    <div class="text-xs text-[var(--text-color-secondary)]">ID: ${c.sessionId}</div>
                `,x.addEventListener("click",()=>{We(c.sessionId,c.page_number),s.remove()}),u.appendChild(x)}),f.appendChild(u)}}else{let w=JSON.parse(localStorage.getItem("saved_branches")||"[]");if(f.innerHTML="",w.length===0)f.innerHTML='<p class="text-[var(--text-color-secondary)]">\uB85C\uCEEC\uC5D0 \uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let l=n("ul","space-y-2");w.forEach(h=>{let u=`page_snapshot_${h}`,a=localStorage.getItem(u);if(a){let c=JSON.parse(a),x=n("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),m=new Date().toLocaleString();x.innerHTML=`
                        <div class="font-bold text-[var(--text-color-primary)]">${c.header.title||"\uC81C\uBAA9 \uC5C6\uC74C"} (Page ${c.page_number})</div>
                        <div class="text-sm text-[var(--text-color-secondary)]">\uB85C\uCEEC \uC800\uC7A5 (\uC2DC\uAC04: ${m})</div>
                        <div class="text-xs text-[var(--text-color-secondary)]">ID: ${h}</div>
                    `,x.addEventListener("click",()=>{We(c.sessionId,c.page_number),s.remove()}),l.appendChild(x)}}),f.appendChild(l)}}},Xe=()=>{let t=document.getElementById("active-overlay");t&&t.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let e=n("div","w-full max-w-md max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","Codex");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),e.appendChild(r);let d=n("div","flex-grow overflow-y-auto"),p=K(),v=[];if(p.codex_new&&p.codex_new.length>0&&v.push(...p.codex_new),p.codex_update&&p.codex_update.length>0&&v.push(...p.codex_update),v.length>0){let f=v.reduce((g,b)=>{let w="General";return b.data&&b.data.length>0&&b.data[0].category?w=b.data[0].category:b.id==="player_001"&&(w="Player"),g[w]||(g[w]=[]),g[w].push(b),g},{});for(let g in f){let b=n("div","mb-4 last:mb-0"),w=j[g]!==!1,l=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");l.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${g}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${w?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,b.appendChild(l);let h=n("div","overflow-hidden transition-all duration-300 ease-in-out");w?h.style.maxHeight=h.scrollHeight+"px":h.style.maxHeight="0px";let u=n("ul","space-y-2 mt-2 codex-list");u.setAttribute("data-list-type","codex"),f[g].forEach((a,c)=>{let x=!(a.id==="player_001"&&!v.some(y=>y.id==="player_002")),m=Ue(a,x);u.appendChild(m)}),h.appendChild(u),b.appendChild(h),d.appendChild(b),l.addEventListener("click",()=>{let a=l.querySelector("svg");h.style.maxHeight==="0px"||h.style.maxHeight===""?(h.style.maxHeight=h.scrollHeight+"px",a.classList.remove("rotate-180"),j[g]=!0):(h.style.maxHeight="0px",a.classList.add("rotate-180"),j[g]=!1)})}}else{let f=n("p","text-sm text-[var(--text-color-secondary)] italic");f.textContent="Codex \uBAA9\uB85D\uC774 \uBE44\uC5B4\uC788\uC2B5\uB2C8\uB2E4",d.appendChild(f)}e.appendChild(d),o.appendChild(e),document.body.appendChild(o),o.addEventListener("click",f=>{f.target===o&&o.remove()})},Ye=()=>{let t=document.getElementById("active-overlay");t&&t.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let e=n("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uC124\uC815");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),e.appendChild(r);let d=n("div","mb-6"),p=n("label","block text-sm font-medium text-[var(--text-color-primary)] mb-2","\uD14C\uB9C8 \uC120\uD0DD");d.appendChild(p);let v=n("select","w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-md text-[var(--text-color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--ui-accent-secondary)]");Y.forEach(f=>{let g=n("option","",f);g.value=f,f===ce&&(g.selected=!0),v.appendChild(g)}),v.addEventListener("change",async f=>{Q(f.target.value),localStorage.setItem("userPreferredTheme",f.target.value);let{savePageSnapshot:g}=await Promise.resolve().then(()=>(ee(),Ve)),b=K();await g(M,T,b),console.log(`Snapshot updated with new theme: ${f.target.value}`)}),d.appendChild(v),e.appendChild(d),o.appendChild(e),document.body.appendChild(o),o.addEventListener("click",f=>{f.target===o&&o.remove()})};var Qe=()=>{let t=document.getElementById("active-overlay");t&&t.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let e=n("div","w-full max-w-6xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl flex flex-col"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] p-6 pb-3"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\u{1F41B} Debug Data Browser");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),e.appendChild(r);let d=n("div","flex gap-2 px-6 pt-3 border-b border-[var(--border-color)]"),p=["Entities","Resources","Assets","Modifiers","localStorage","Page History"],v=[];p.forEach((u,a)=>{let c=n("button",`px-4 py-2 rounded-t-md transition-colors ${a===0?"bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]":"text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}`);c.textContent=u,c.dataset.tab=u,v.push(c),d.appendChild(c)}),e.appendChild(d);let f=n("div","flex-grow overflow-y-auto p-6");e.appendChild(f);let g=K(),b=q(),w=u=>{let a=n("pre","bg-black/30 p-4 rounded-md overflow-x-auto text-xs text-[var(--text-color-primary)] font-mono");return a.textContent=JSON.stringify(u,null,2),a},l=(u,a)=>{let c=n("div","mb-6"),x=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3",a);if(c.appendChild(x),!u||u.length===0){let C=n("p","text-[var(--text-color-secondary)] italic","\uB370\uC774\uD130 \uC5C6\uC74C");return c.appendChild(C),c}let m=n("table","w-full border-collapse text-sm");m.style.fontSize="12px";let y=n("thead"),I=n("tr","border-b border-[var(--border-color)]"),$=Object.keys(u[0]);$.forEach(C=>{let L=n("th","text-left p-2 text-[var(--text-color-primary)] font-bold",C);I.appendChild(L)}),y.appendChild(I),m.appendChild(y);let S=n("tbody");return u.forEach((C,L)=>{let O=n("tr","border-b border-[var(--border-color)]/30 hover:bg-[var(--bg-color)] transition-colors");$.forEach(z=>{let _=n("td","p-2 text-[var(--text-color-secondary)]"),E=C[z];typeof E=="object"&&E!==null?_.textContent=JSON.stringify(E):_.textContent=E??"null",O.appendChild(_)}),S.appendChild(O)}),m.appendChild(S),c.appendChild(m),c},h=u=>{switch(f.innerHTML="",u){case"Entities":f.appendChild(l(g.codex_new,"New Entities")),f.appendChild(l(g.codex_update,"Updated Entities"));break;case"Resources":f.appendChild(l(g.resources,"Resources"));break;case"Assets":f.appendChild(l(g.asset,"Assets"));break;case"Modifiers":f.appendChild(l(g.modifiers,"Modifiers"));break;case"localStorage":let a=n("div"),c=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","localStorage Keys");a.appendChild(c);let x=n("div","space-y-2"),m=Object.keys(localStorage).filter(_=>_.includes(b)||_.includes("processed_pages")||_.includes("snapshot_pages"));if(m.forEach(_=>{let E=n("div","bg-black/20 p-3 rounded-md"),$e=n("div","font-bold text-[var(--ui-accent-primary)] mb-2",_);E.appendChild($e);try{let J=localStorage.getItem(_),k=JSON.parse(J);E.appendChild(w(k))}catch{let k=n("pre","text-xs text-[var(--text-color-secondary)]",localStorage.getItem(_));E.appendChild(k)}x.appendChild(E)}),m.length===0){let _=n("p","text-[var(--text-color-secondary)] italic","\uAD00\uB828 localStorage \uD56D\uBAA9 \uC5C6\uC74C");x.appendChild(_)}a.appendChild(x),f.appendChild(a);break;case"Page History":let y=n("div"),I=`processed_pages_${b}`,$=JSON.parse(localStorage.getItem(I)||"[]");y.appendChild(l($,"Processed Pages (Anti-duplicate)"));let S=`snapshot_pages_${b}`,C=JSON.parse(localStorage.getItem(S)||"[]");y.appendChild(l(C,"Saved Snapshots"));let L=n("div","mt-6 bg-black/20 p-4 rounded-md"),O=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","Current Page Info");L.appendChild(O);let z={sessionId:b,page_number:g.page_number,title:g.header.title,timestamp:new Date().toISOString()};L.appendChild(w(z)),y.appendChild(L),f.appendChild(y);break}};v.forEach(u=>{u.addEventListener("click",()=>{v.forEach(a=>{a.className="px-4 py-2 rounded-t-md transition-colors text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}),u.className="px-4 py-2 rounded-t-md transition-colors bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]",h(u.dataset.tab)})}),h("Entities"),o.appendChild(e),document.body.appendChild(o),o.addEventListener("click",u=>{u.target===o&&o.remove()})};var P=null,Ue=(t,o=!0)=>{let e=n("li","text-sm p-2 rounded-md transition-colors");o?(e.setAttribute("draggable","true"),e.classList.add("cursor-grab","bg-[var(--bg-panel)]/30","hover:bg-[var(--bg-panel)]/50")):e.classList.add("bg-amber-900/30","border","border-amber-600","text-amber-200","font-bold");let r=t.classifications||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--text-color-secondary)] mt-1">${Object.entries(r).map(([i,d])=>{let p=d.label||i,v=d.value||d;return`<span>${p}: ${v}</span>`}).join(", ")}</div>`:"";return e.innerHTML=`<strong class="text-[var(--ui-accent-secondary)]">${t.name||t.id}</strong>
        ${s}
    `,e.dataset.entityId=t.id,o&&(e.addEventListener("dragstart",se),e.addEventListener("dragend",ne),e.addEventListener("dragover",ae),e.addEventListener("drop",ie)),e},mt=(t,o)=>{let e=n("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");e.setAttribute("draggable","true"),e.setAttribute("data-index",o),e.dataset.assetId=t.id;let r=t.properties||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--ui-accent-tertiary)] mb-1">${Object.entries(r).map(([i,d])=>{let p=d.label||i,v=d.value||d;return`<span>${p}: ${v}</span>`}).join(", ")}</div>`:"";return e.innerHTML=`
        <div class="flex justify-between items-center mb-1">
            <span class="font-semibold text-[var(--text-color-primary)] text-base">${t.name}</span>
            <span class="text-xs font-mono text-[var(--text-color-secondary)]">x${t.quantity}</span>
        </div>
        ${s}
        ${t.description?`<p class="text-xs text-[var(--text-color-secondary)] leading-tight">${t.description}</p>`:""}
    `,e.addEventListener("dragstart",se),e.addEventListener("dragend",ne),e.addEventListener("dragover",ae),e.addEventListener("drop",ie),e},xt=(t,o)=>{let e=n("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");e.setAttribute("draggable","true"),e.setAttribute("data-index",o),e.dataset.resourceId=t.id;let r=t.max&&t.max>0?t.current/t.max*100:0;return e.innerHTML=`
        <div class="flex justify-between items-baseline text-sm mb-1">
            <span class="font-semibold text-[var(--text-color-primary)]">${t.name}</span>
            <span class="font-mono text-[var(--text-color-secondary)]">${t.current}${t.max?"/"+t.max:""}</span>
        </div>
        ${t.max?`
            <div class="w-full bg-black/30 rounded-full h-1.5 mb-1">
                <div class="h-1.5 rounded-full transition-all duration-300" style="width: ${r}%; background-color: ${t.color};"></div>
            </div>
        `:""}
        ${t.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${t.description}</p>`:""}
    `,e.addEventListener("dragstart",se),e.addEventListener("dragend",ne),e.addEventListener("dragover",ae),e.addEventListener("drop",ie),e},ht=(t,o)=>{let e=n("li","bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors");e.setAttribute("draggable","true"),e.setAttribute("data-index",o),e.dataset.modifierId=t.id;let r="text-[var(--ui-accent-secondary)]",s="";return t.alignment==="good"?(r="text-green-400",s="border-l-2 border-green-400"):t.alignment==="bad"?(r="text-red-400",s="border-l-2 border-red-400"):t.alignment==="neutral"&&(r="text-gray-400",s="border-l-2 border-gray-400"),e.className=`bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors ${s}`,e.innerHTML=`
        <div class="flex justify-between items-baseline mb-1">
            <span class="font-semibold ${r} text-sm">${t.name}</span>
            ${t.duration?`<span class="text-xs text-[var(--text-color-secondary)]">${t.duration}</span>`:""}
        </div>
        <div class="text-xs text-[var(--text-color-secondary)]">
            ${t.target} ${t.operation} ${t.value}
        </div>
        ${t.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${t.description}</p>`:""}
    `,e.addEventListener("dragstart",se),e.addEventListener("dragend",ne),e.addEventListener("dragover",ae),e.addEventListener("drop",ie),e},se=t=>{P=t.target.closest('[draggable="true"]'),P&&(P.style.opacity="0.5",P.classList.add("border","border-stone-500"),t.dataTransfer.effectAllowed="move")},ne=t=>{if(P){P.style.opacity="1",P.classList.remove("border","border-stone-500");let o=P.parentNode;if(o){let e=o.getAttribute("data-list-type");vt(o,e)}}},ae=t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";let o=t.target.closest('[draggable="true"]');if(o&&o!==P&&o.parentNode===P.parentNode){let e=o.getBoundingClientRect(),r=e.top+e.height/2;t.clientY<r?o.parentNode.insertBefore(P,o):o.parentNode.insertBefore(P,o.nextSibling)}},ie=t=>{t.preventDefault(),t.stopPropagation()},vt=(t,o)=>{if(!t||!o)return;let r=Array.from(t.children).map(s=>o==="resource"?s.dataset.resourceId:o==="asset"?s.dataset.assetId||s.textContent.trim():o==="modifier"?s.dataset.modifierId:o==="codex"?s.dataset.entityId:null).filter(s=>s!==null);o==="resource"?(Me(r),console.log("Resource order saved:",r)):o==="asset"?(Oe(r),console.log("Asset order saved:",r)):o==="modifier"&&(He(r),console.log("Modifier order saved:",r))},ze=(t,o,e="id")=>{if(!o||o.length===0)return t;let r=new Map(t.map(d=>[d[e],d])),s=[],i=[];return o.forEach(d=>{let p=r.get(d);p&&(s.push(p),r.delete(d))}),r.forEach(d=>i.push(d)),[...s,...i]},ve=t=>{let o=document.getElementById("header-container");if(!o)return;let e=t.title||"\uC81C 1\uC7A5: \uADF8\uB9BC\uC790\uC758 \uAE38";o.innerHTML=`
        <div class="flex justify-between items-center">
            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
            <h1 class="text-2xl font-bold text-[var(--text-color-primary)] text-center cursor-pointer" id="header-title">${e}</h1>
            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
        </div>
        <div class="text-center text-sm text-[var(--text-color-secondary)] mt-2">
            <span>${t.hud?.location||"\uC54C \uC218 \uC5C6\uB294 \uC7A5\uC18C"}</span>
            <span class="mx-2">\xB7</span>
            <span>${t.hud?.date||""}</span>
            <span class="mx-2">\xB7</span>
            <span>${t.hud?.time||""}</span>
        </div>
    `,document.getElementById("header-title").addEventListener("click",De)};var be=t=>{let o=document.getElementById("info-panel-container");if(!o||!t.scene_elements||t.scene_elements.length===0)return;o.innerHTML="";let e=t.page_number||0,r=n("div","relative w-full transition-all duration-300 ease-in-out cursor-pointer rounded-lg hover:bg-[var(--bg-panel)]");R&&r.classList.add("is-expanded","bg-[var(--bg-panel)]");let s=n("div","h-24"),i=n("div","relative w-full h-full flex items-center"),d=n("div","absolute left-[5%] top-1/2 w-[90%] h-0.5 bg-[var(--info-panel-line-color)]");i.appendChild(d);let p=[...t.scene_elements].sort((l,h)=>l.distance-h.distance),v=Math.max(...t.scene_elements.map(l=>Math.abs(l.distance)),5),f=[],g=!1;p.forEach((l,h)=>{let u=Math.max(-v,Math.min(v,l.distance)),a=p.filter(k=>k.distance===l.distance),c=a.findIndex(k=>k.name===l.name),x=a.length,m=2,I=-((x-1)*m)/2,S=50+u/v*45+I+c*m,C=n("div","absolute top-1/2");C.style.left=`${S}%`,C.style.transform="translate(-50%, -50%)";let L=n("div","w-3 h-3 rounded-full border-2 transition-all duration-200 ease-in-out relative flex items-center justify-center"),O,z;if(l.type==="player"){let k="var(--player-color)";L.classList.add(`border-[${k}]`,`bg-[${k}]`),z="text-black",O=k}else{let k,le;l.type==="ally"?(k="var(--ally-color-border)",le="var(--ally-color-fill)"):l.type==="enemy"?(k="var(--enemy-color-border)",le="var(--enemy-color-fill)"):(k="var(--object-color-border)",le="var(--object-color-fill)"),L.classList.add(`border-[${k}]`,`bg-[${le}]`),z="text-white",O=k}r.classList.contains("is-expanded")&&(L.classList.remove("w-3","h-3"),L.classList.add("w-5","h-5"));let _=n("div","absolute bottom-full mb-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap");_.style.left="50%",_.style.transform="translateX(-50%)",_.style.color=O,_.style.fontSize="16px",_.style.fontWeight="bold",_.textContent=l.name,l.type==="player"&&e===1?_.style.opacity="1":_.style.opacity="0",L.appendChild(_);let E=null;l.type==="player"&&l.status&&(E=n("div","absolute top-full mt-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap text-xs text-[var(--text-color-secondary)]"),E.style.left="50%",E.style.transform="translateX(-50%)",E.textContent=l.status,e===1?E.style.opacity="1":E.style.opacity="0",L.appendChild(E));let $e=String.fromCharCode(65+h),J=n("span",`relative text-xs font-bold ${z} opacity-0 transition-opacity duration-200`);J.textContent=$e,r.classList.contains("is-expanded")&&(J.style.opacity="1"),L.appendChild(J),f.push({dot:L,indexSpan:J,elementWrapper:C,nameTooltip:_,statusTooltip:E,element:l}),C.addEventListener("mouseenter",()=>{r.classList.contains("is-expanded")||(_.style.opacity="1",E&&e===1&&(E.style.opacity="1"))}),C.addEventListener("mouseleave",()=>{l.type==="player"&&e===1&&!g?(_.style.opacity="1",E&&(E.style.opacity="1")):(_.style.opacity="0",E&&(E.style.opacity="0"))}),C.appendChild(L),i.appendChild(C)}),r.addEventListener("mouseenter",()=>{g=!0,e===1&&f.forEach(({nameTooltip:l,statusTooltip:h,element:u})=>{u.type==="player"&&(l.style.opacity="0",h&&(h.style.opacity="0"))})}),r.addEventListener("mouseleave",()=>{g=!1,e===1&&!r.classList.contains("is-expanded")&&f.forEach(({nameTooltip:l,statusTooltip:h,element:u})=>{u.type==="player"&&(l.style.opacity="1",h&&(h.style.opacity="1"))})}),s.appendChild(i),r.appendChild(s);let b=n("div","max-h-0 overflow-hidden transition-all duration-300 ease-in-out relative"),w=n("ul","space-y-3 px-[5%] pb-12 opacity-0 transition-opacity duration-300");p.forEach((l,h)=>{let u=n("li","text-[var(--text-color-primary)]"),a;l.type==="player"?a="text-[var(--player-color)]":l.type==="ally"?a="text-[var(--ally-color-border)]":l.type==="enemy"?a="text-[var(--enemy-color-border)]":l.type==="object"&&(a="text-[var(--object-color-border)]");let c=String.fromCharCode(65+h);u.innerHTML=`<strong class="font-bold ${a}">${c}. ${l.name}:</strong> <span class="text-[var(--text-color-secondary)]">${l.status}</span>`,w.appendChild(u)}),b.appendChild(w),r.appendChild(b),r.classList.contains("is-expanded")&&(b.style.maxHeight=b.scrollHeight+"px",setTimeout(()=>{w.classList.add("opacity-100")},50),i.style.pointerEvents="none"),r.addEventListener("click",l=>{if(l.target.closest(".pointer-events-auto"))return;let h=r.classList.contains("is-expanded");if(R&&h)return;r.classList.toggle("is-expanded")?(r.classList.add("bg-[var(--bg-panel)]"),b.style.maxHeight=b.scrollHeight+"px",setTimeout(()=>{w.classList.add("opacity-100")},50),i.style.pointerEvents="none",f.forEach(({dot:a,indexSpan:c})=>{a.classList.remove("w-3","h-3"),a.classList.add("w-5","h-5"),c.style.opacity="1"})):(r.classList.remove("bg-[var(--bg-panel)]"),w.classList.remove("opacity-100"),b.style.maxHeight="0px",i.style.pointerEvents="auto",f.forEach(({dot:a,indexSpan:c})=>{a.classList.remove("w-5","h-5"),a.classList.add("w-3","h-3"),c.style.opacity="0"}))}),o.appendChild(r)},ye=t=>{let o=document.getElementById("choices-container");if(!o||!t.choices||t.choices.length===0)return;o.innerHTML="";let e=n("div","w-full pt-4");t.choices.forEach((r,s)=>{let i=n("div","w-full text-left py-2 text-[var(--text-color-primary)] text-lg"),d=Ke(r);i.innerHTML=`<span class="font-bold text-[var(--text-accent-bold)]">${s+1}.</span> ${d}`,e.appendChild(i)}),o.appendChild(e)},we=t=>{let o=document.getElementById("content-container");if(o){if(o.innerHTML="",t.story_html){let e=n("div","space-y-4");e.innerHTML=t.story_html,o.appendChild(e)}else if(t.main_content&&t.main_content.length>0){let e=n("div","space-y-4");t.main_content.forEach(r=>{let s=n("p");r.id==="narration"?(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.textContent=r.content):r.id==="thought"?(s.className="text-[var(--text-accent-bold)] leading-loose text-lg pl-4 border-l-2 border-[var(--ui-accent-secondary)]",s.textContent=r.content):r.id==="document"?(s.className="text-[var(--text-color-primary)] leading-relaxed text-base bg-[var(--bg-panel)]/50 p-4 rounded border border-[var(--border-color)]",s.textContent=r.content):r.id==="system"?(s.className="text-[var(--text-color-secondary)] text-sm text-center",s.textContent=r.content):r.id==="quote"?(s.className="text-[var(--text-accent-aux)] leading-relaxed text-lg pl-6 border-l-4 border-[var(--text-accent-aux)] italic",s.textContent=r.content):(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.innerHTML=`<span class="font-bold text-[var(--text-accent-italic)]">${r.id}:</span> ${r.content}`),e.appendChild(s)}),o.appendChild(e)}}},Ce=t=>{let o=!0,e=null,r=0,s=0,i="",d=document.getElementById("hud-container");if(!d)return;d.innerHTML="";let p=n("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(t.resources&&t.resources.length>0){let u=t.resources.filter(m=>m.max!==null&&m.max!==void 0),a=t.resources.filter(m=>m.max===null||m.max===void 0),c=[...u,...a];c=ze(c,de,"id");let x=n("ul","space-y-2 resource-list");x.setAttribute("data-list-type","resource"),c.forEach((m,y)=>{let I=xt(m,y);x.appendChild(I)}),p.appendChild(x)}else{let u=n("p","text-sm text-[var(--text-color-secondary)] italic");u.textContent="\uC790\uC6D0 \uC815\uBCF4\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4",p.appendChild(u)}if(t.modifiers&&t.modifiers.length>0){let u=n("div","mt-4 pt-3 border-t border-[var(--border-color)]"),a=n("ul","space-y-2 modifier-list");a.setAttribute("data-list-type","modifier"),ze(t.modifiers,ue,"id").forEach((x,m)=>{let y=ht(x,m);a.appendChild(y)}),u.appendChild(a),p.appendChild(u)}let v=n("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(t.asset&&t.asset.length>0){let u=t.asset.reduce((a,c)=>{let x=c.category||"\uAE30\uD0C0";return a[x]||(a[x]=[]),a[x].push(c),a},{});for(let a in u){let c=n("div","mb-4 last:mb-0");c.setAttribute("draggable","true"),c.dataset.categoryName=a,c.addEventListener("dragstart",se),c.addEventListener("dragend",ne),c.addEventListener("dragover",ae),c.addEventListener("drop",ie);let x=G[a]!==!1,m=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");m.innerHTML=`
                            <span class="font-bold text-[var(--ui-accent-primary)] text-lg">${a}</span>
                            <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${x?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        `,c.appendChild(m);let y=n("div","overflow-hidden transition-all duration-300 ease-in-out");x?y.style.maxHeight=y.scrollHeight+"px":y.style.maxHeight="0px";let I=n("ul","space-y-2 mt-2 asset-list");I.setAttribute("data-list-type","asset"),ze(u[a],pe,"id").forEach((S,C)=>{let L=mt(S,C);I.appendChild(L)}),y.appendChild(I),c.appendChild(y),v.appendChild(c),m.addEventListener("click",()=>{let S=m.querySelector("svg");y.style.maxHeight==="0px"||y.style.maxHeight===""?(y.style.maxHeight=y.scrollHeight+"px",S.classList.remove("rotate-180"),G[a]=!0):(y.style.maxHeight="0px",S.classList.add("rotate-180"),G[a]=!1)})}}else{let u=n("p","text-sm text-[var(--text-color-secondary)] italic");u.textContent="Asset\uC774 \uC5C6\uC2B5\uB2C8\uB2E4",v.appendChild(u)}let f=n("div","hidden sm:block bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]"),g=[];if(t.codex_new&&t.codex_new.length>0&&g.push(...t.codex_new),t.codex_update&&t.codex_update.length>0&&g.push(...t.codex_update),g.length>0){let u=g.reduce((a,c)=>{let x="General";return c.data&&c.data.length>0&&c.data[0].category?x=c.data[0].category:c.id==="player_001"&&(x="Player"),a[x]||(a[x]=[]),a[x].push(c),a},{});for(let a in u){let c=n("div","mb-4 last:mb-0"),x=j[a]!==!1,m=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");m.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${a}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${x?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,c.appendChild(m);let y=n("div","overflow-hidden transition-all duration-300 ease-in-out");x?y.style.maxHeight=y.scrollHeight+"px":y.style.maxHeight="0px";let I=n("ul","space-y-2 mt-2 codex-list");I.setAttribute("data-list-type","codex"),u[a].forEach(($,S)=>{let C=!($.id==="player_001"&&!g.some(O=>O.id==="player_002")),L=Ue($,C);I.appendChild(L)}),y.appendChild(I),c.appendChild(y),f.appendChild(c),m.addEventListener("click",()=>{let $=m.querySelector("svg");y.style.maxHeight==="0px"||y.style.maxHeight===""?(y.style.maxHeight=y.scrollHeight+"px",$.classList.remove("rotate-180"),j[a]=!0):(y.style.maxHeight="0px",$.classList.add("rotate-180"),j[a]=!1)})}}let b=[p,v,f],w=[];b.forEach(u=>{u.classList.add("flex","flex-col");let a=n("div","mt-4 w-full flex items-end");a.setAttribute("data-tip-spacer","true"),a.style.transition="height 300ms ease-out",a.style.willChange="height",u.appendChild(a),w.push(a),d.appendChild(u)});let l=()=>{requestAnimationFrame(()=>{let c=b,x=c.map($=>{let S=$.querySelector('[data-tip-spacer="true"]'),C=S?S.style.display:"";S&&(S.style.display="none");let L=$.offsetHeight;return S&&(S.style.display=C),L});if(x.length===0)return;let m=Math.max(...x);if(c.forEach(($,S)=>{let C=x[S],L=m-C,O=$.querySelector('[data-tip-spacer="true"]');O&&(O.style.height=`${Math.max(0,L)}px`)}),clearTimeout(e),m<1e3){c.forEach($=>{let S=$.querySelector('[data-tip-spacer="true"]');S&&(S.innerHTML="")});return}let y=[];c.forEach(($,S)=>{m-x[S]>50&&y.push({panel:$,index:S})});let I=y.length>0?y[y.length-1]:null;if(c.forEach(($,S)=>{if(!I||S!==I.index){let C=$.querySelector('[data-tip-spacer="true"]');C&&(C.innerHTML="")}}),!o&&I){let $=Date.now();if($<s)return;let S=I.panel.querySelector('[data-tip-spacer="true"]');($-r>1e4||i==="")&&(r=$,i=fe[Math.floor(Math.random()*fe.length)]);let C=S.querySelector("p");C||(C=document.createElement("p"),C.className="p-4 text-sm text-[var(--text-color-secondary)] italic transition-opacity duration-300 opacity-0",S.appendChild(C)),C.textContent=i,requestAnimationFrame(()=>C.classList.remove("opacity-0")),e=setTimeout(()=>{C.classList.add("opacity-0"),s=Date.now()+1e4,setTimeout(()=>{C.parentNode&&C.parentNode.removeChild(C)},300)},5e3)}})},h=new ResizeObserver(l);b.forEach(u=>{h.observe(u)}),setTimeout(()=>{l(),o=!1},150)},Se=()=>{let t=document.getElementById("app-root");t.innerHTML="";let o=n("div","max-w-5xl mx-auto p-4 sm:p-6"),e=n("div","mb-8");e.id="header-container";let r=n("div","my-8");r.id="content-container";let s=n("div","my-1");s.id="info-panel-container";let i=n("div");i.id="choices-container";let d=n("div","relative mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 items-start");d.id="hud-container";let p=n("div","flex justify-end gap-2 mt-2");p.id="hud-controls-container";let v=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");v.id="image-button",v.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',v.addEventListener("click",Ge);let f=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");f.id="page-button",f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',f.addEventListener("click",De);let g=n("button","sm:hidden p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");g.id="codex-button",g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>';let b=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");b.id="pin-infopanel-button",b.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',b.addEventListener("click",()=>{ke(!R),b.classList.toggle("bg-[var(--ui-accent-primary)]",R);let h=document.querySelector("#info-panel-container > div");if(h){let u=h.classList.contains("is-expanded");(R&&!u||!R&&u)&&h.click()}});let w=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");w.id="settings-button",w.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67c-.2.2-.3.3-.3.3s-.2.1-.3.1c-.2.1-.4.1-.6.1-.2 0-.4 0-.6-.1a1.65 1.65 0 0 0-1.67-.3c-.2-.2-.3-.3-.3-.3s-.1-.2-.1-.3c-.1-.2-.1-.4-.1-.6 0-.2 0-.4.1-.6a1.65 1.65 0 0 0 .3-1.67c.2-.2.3-.3.3-.3s-.2-.1.3-.1c.2-.1.4-.1.6-.1.2 0 .4 0 .6.1a1.65 1.65 0 0 0 1.67.3c.2.2.3.3.3.3s.1.2.1.3c.1.2.1.4.1.6 0 .2 0 .4-.1.6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';let l=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors border border-[var(--border-color)]");l.id="debug-button",l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="6" width="8" height="1"></rect><rect x="8" y="11" width="8" height="1"></rect><rect x="8" y="16" width="8" height="1"></rect><path d="M12 3v3"></path><path d="M12 18v3"></path><path d="M4 9h2"></path><path d="M18 9h2"></path><path d="M4 15h2"></path><path d="M18 15h2"></path><circle cx="12" cy="12" r="9"></circle></svg>',l.title="Debug Data Browser",p.appendChild(v),p.appendChild(f),p.appendChild(g),p.appendChild(b),p.appendChild(w),p.appendChild(l),o.append(e,r,s,i,p,d),t.appendChild(o)};A();import{initializeApp as bt}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";var Ze=async()=>{try{await Ae(bt);let t=K(),o=t.sessionId,e={resources:[],asset:[],modifiers:[],codex_new:[],codex_update:[]};e=await je(M,T,o),t.resources=N(e.resources,t.resources,"id"),t.asset=N(e.asset,t.asset,"id"),t.modifiers=N(e.modifiers,t.modifiers,"id"),t.codex_new=N(e.entities,t.codex_new,"id"),t.codex_update&&t.codex_update.length>0&&(t.codex_new=N(t.codex_new,t.codex_update,"id"),t.codex_update=[]);let s=Pe()[0]||"modern";X&&Y.includes(X)&&(s=X),Q(s),await Re(M,T,t),await Ne(M,T,t),Se(),ve(t),we(t),be(t),ye(t),Ce(t);let i=document.getElementById("codex-button");i&&i.addEventListener("click",Xe);let d=document.getElementById("settings-button");d&&d.addEventListener("click",Ye);let p=document.getElementById("debug-button");p&&p.addEventListener("click",Qe),console.log("Application initialized successfully")}catch(t){console.error("Initialization Error:",t),document.body.innerHTML=`<div class="text-red-400 p-8">Error: ${t.message}</div>`}};document.addEventListener("DOMContentLoaded",async()=>{await Ze()});
//# sourceMappingURL=bundle.min.js.map

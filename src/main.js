var lt=Object.defineProperty;var Ee=(e,o)=>()=>(e&&(o=e(e=0)),o);var ke=(e,o)=>{for(var t in o)lt(e,t,{get:o[t],enumerable:!0})};var Q={};ke(Q,{getSessionId:()=>F,parseAllData:()=>W,parseChoices:()=>Qe,parseCodex:()=>pe,parseCodexCsv:()=>pt,parseDefineUpdate:()=>ct,parseHeader:()=>Xe,parseHtmlDocs:()=>We,parseInlineMarkdown:()=>Me,parseMarkdown:()=>Ge,parseProps:()=>dt,parseSceneData:()=>Ze,parseStory:()=>Ye});var We,Ge,Me,Xe,Ye,Qe,Ze,ct,dt,pe,F,pt,W,D=Ee(()=>{R();We=()=>{let e={};return document.querySelectorAll('script[type="text/html"]').forEach(o=>{let t=o.getAttribute("data-id"),r=o.getAttribute("data-category");t&&(e[t]={category:r||"unknown",content:o.innerHTML.trim()})}),e},Ge=e=>{if(!e)return"";let o=e;return o=o.replace(/^### (.+)$/gm,'<h3 class="text-xl font-bold text-[var(--text-color-primary)] mt-4 mb-2">$1</h3>'),o=o.replace(/^## (.+)$/gm,'<h2 class="text-2xl font-bold text-[var(--text-color-primary)] mt-6 mb-3">$1</h2>'),o=o.replace(/^# (.+)$/gm,'<h1 class="text-3xl font-bold text-[var(--text-color-primary)] mt-8 mb-4">$1</h1>'),o=o.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),o=o.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),o=o.replace(/\n\n/g,'</p><p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'),o='<p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'+o+"</p>",o},Me=e=>{if(!e)return"";let o=e;return o=o.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),o=o.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),o},Xe=()=>{let e=document.getElementById("header");if(!e)return{title:"",location:"",date:"",time:""};let t=e.textContent.trim().split("|").map(r=>r.trim());return{title:t[0]||"",location:t[1]||"",date:t[2]||"",time:t[3]||""}},Ye=()=>{let e=document.getElementById("story");return e?Ge(e.textContent.trim()):""},Qe=()=>{let e=document.getElementById("choices");return e?e.textContent.trim().split(`
`).map(r=>r.trim()).filter(r=>r).map(r=>r.replace(/^\d+\.\s*/,"").trim()):[]},Ze=()=>{let e=document.getElementById("scene-data");return e?e.textContent.trim().split(`
`).map(r=>r.trim()).filter(r=>r).map(r=>{let s=r.split("|").map(i=>i.trim());return{type:s[1]||"",name:s[2]||"",distance:s[3]?Number(s[3]):0,status:s[4]||""}}).filter(r=>r.type):[]},ct=e=>{let o=document.getElementById(e);if(!o)return null;let r=o.textContent.trim().split(`
`).map(i=>i.trim()).filter(i=>i),s={name:"",id:"",description:"",data:[]};return r.forEach(i=>{let l=i.split("|").map(h=>h.trim()),c=l[0];c==="name"?s.name=l[1]||"":c==="id"?s.id=l[1]||"":c==="description"?s.description=l[1]||"":c==="data"&&s.data.push({category:l[1]||"",value:l[2]||""})}),s},dt=(e,o)=>{let t={};for(let r=o;r<e.length;r++){let s=e[r],i=s.indexOf(":");if(i>-1){let l=s.substring(0,i).trim(),c=s.substring(i+1).trim();t[l]=c}}return t},pe=e=>{let o=document.querySelectorAll('script[id="codex"]'),t=null;o.forEach(f=>{f.getAttribute("data-type")===e&&(t=f)});let r={entities:[],resources:[],assets:[],modifiers:[],removed:{entities:[],resources:[],assets:[],modifiers:[]}};if(!t)return r;let i=t.textContent.trim().split(`
`).map(f=>f.trim()).filter(f=>f),l={},c={},h={},g={};return i.forEach(f=>{let b=f.indexOf("|");if(b===-1)return;let C=f.substring(0,b).trim(),d=f.substring(b+1).trim(),v=C.split("."),u=v[0],a=v[1],p=v.slice(2);if(e==="remove"){u==="entity"?r.removed.entities.push(a):u==="resource"?r.removed.resources.push(a):u==="asset"?r.removed.assets.push(a):u==="effect"&&r.removed.modifiers.push(a);return}if(u==="entity"){l[a]||(l[a]={id:a,classifications:{}});let x=l[a];if(p.length===1){let m=p[0];x[m]=d}else if(p[0]==="classifications"&&p.length===2){let m=p[1],y=d.indexOf(":");if(y>-1){let E=d.substring(0,y).trim(),$=d.substring(y+1).trim();x.classifications[m]={label:E,value:$}}else x.classifications[m]={label:m,value:d}}}else if(u==="resource"){c[a]||(c[a]={id:a});let x=c[a],m=p[0];m==="current"||m==="max"?x[m]=d==="NULL"?null:Number(d):x[m]=d}else if(u==="asset"){h[a]||(h[a]={id:a,properties:{}});let x=h[a];if(p.length===1){let m=p[0];m==="quantity"?x[m]=Number(d):x[m]=d}else if(p[0]==="properties"&&p.length===2){let m=p[1],y=d.indexOf(":");if(y>-1){let E=d.substring(0,y).trim(),$=d.substring(y+1).trim();x.properties[m]={label:E,value:$}}else x.properties[m]={label:m,value:d}}}else if(u==="effect"){g[a]||(g[a]={id:a});let x=g[a],m=p[0];x[m]=d}}),r.entities=Object.values(l),r.resources=Object.values(c),r.assets=Object.values(h),r.modifiers=Object.values(g),r},F=()=>{let e=document.getElementById("session-uuid");if(e&&e.textContent.trim()){let t=e.textContent.trim();return console.log(`Session ID loaded from HTML: ${t}`),t}let o=localStorage.getItem("gameSessionId");return o||(o=crypto.randomUUID(),localStorage.setItem("gameSessionId",o),console.warn("New Session ID generated and stored in localStorage.")),o},pt=e=>{if(!e)return[];let o=e.trim().split(`
`).filter(s=>s.trim()!=="");if(o.length===0)return[];let t=o[0].split("|").map(s=>s.trim());return o.slice(1).map(s=>{let i=s.split("|").map(c=>c.trim()),l={};return t.forEach((c,h)=>{c&&(l[c]=i[h]||null)}),l})},W=()=>{let e=Xe(),o=Ye(),t=Qe(),r=Ze(),s=pe("new"),i=pe("update"),l=pe("remove"),c=s.entities,h=i.entities,g=[...s.resources,...i.resources],f=[...s.assets,...i.assets],b=[...s.modifiers,...i.modifiers],C=l.removed,d=document.querySelector("title"),v=d?parseInt(d.textContent.match(/\d+/)?.[0]||"0"):0,u=We();return{sessionId:F(),header:e,story_html:o,choices:t,scene_elements:r,codex_new:c,codex_update:h,resources:g,asset:f,modifiers:b,removed:C,html_docs:u,page_number:v,define:c,update:h,hud:{location:e.location,date:e.date,time:e.time},title:e.title,character_stats:{resources:g,attributes:{},equipment:{},name:"",level:1},information_panel:[]}}});var J={};ke(J,{DEFAULT_OFFLINE_USER_ID:()=>U,applyTheme:()=>oe,assetCategoryStates:()=>Z,assetOrder:()=>fe,auth:()=>P,codexCategoryStates:()=>z,controlTips:()=>xe,currentThemeName:()=>ue,currentUserId:()=>O,db:()=>A,isAuthReady:()=>et,isInfoPanelPinned:()=>B,modifierOrder:()=>me,parseAvailableThemes:()=>De,resourceOrder:()=>ge,saveAssetOrder:()=>Ne,saveModifierOrder:()=>Be,saveResourceOrder:()=>Te,setAuth:()=>Oe,setCurrentThemeName:()=>tt,setCurrentUserId:()=>Pe,setDb:()=>He,setIsAuthReady:()=>q,setIsInfoPanelPinned:()=>Ae,themeNames:()=>te,userPreferredTheme:()=>ee});var P,A,et,O,U,Z,z,B,ue,ee,ge,fe,me,xe,te,Oe,He,q,Pe,Ae,tt,Te,Ne,Be,je,oe,De,H=Ee(()=>{P=null,A=null,et=!1,O=null,U="offline-user",Z={},z={},B=!1,ue="default",ee=localStorage.getItem("userPreferredTheme")||null,ge=JSON.parse(localStorage.getItem("resourceOrder")||"[]"),fe=JSON.parse(localStorage.getItem("assetOrder")||"[]"),me=JSON.parse(localStorage.getItem("modifierOrder")||"[]"),xe=["\uC120\uD0DD\uC9C0 \uC704\uC5D0 \uC788\uB294 \uAC00\uB85C\uC904\uACFC \uC810\uB4E4\uC740 \uC778\uD3EC\uD328\uB110\uC785\uB2C8\uB2E4. \uD55C\uBC88 \uB20C\uB7EC\uBCF4\uC138\uC694.","\uC120\uD0DD\uC9C0 \uC6B0\uCE21 \uD558\uB2E8\uC5D0 \uC704\uCE58\uD55C \uC544\uC774\uCF58\uC744 \uB20C\uB7EC\uD574\uBCF4\uC138\uC694.","\uB4DC\uB798\uADF8 \uC564 \uB4DC\uB86D\uC73C\uB85C \uBAA9\uB85D\uC758 \uC704\uCE58\uB97C \uBC14\uAFD4\uBCF4\uC138\uC694.","\uD398\uC774\uC9C0 \uC81C\uBAA9\uC744 \uD074\uB9AD\uD558\uBA74 \uD398\uC774\uC9C0 \uBAA9\uB85D\uC774 \uB098\uC635\uB2C8\uB2E4.","\uD398\uC774\uC9C0 \uC591 \uC606\uC758 \uD654\uC0B4\uD45C\uB85C \uD398\uC774\uC9C0\uB97C \uC774\uB3D9\uD560 \uC218 \uC788\uC5B4\uC694.","\uC120\uD0DD\uC9C0 \uC544\uB798\uC5D0 \uC788\uB294 \uC774\uBBF8\uC9C0 \uC544\uC774\uCF58\uC744 \uD074\uB9AD\uD558\uBA74 \uD574\uB2F9 \uC7A5\uBA74\uC5D0 \uB9DE\uB294 \uC774\uBBF8\uC9C0\uB97C \uC0DD\uC131\uD560 \uC218 \uC788\uC5B4\uC694."],te=["fantasy","stone-cyan-dark","cyberpunk","horror","modern","cyberpunk-dark","material-dark","material-light"],Oe=e=>{P=e},He=e=>{A=e},q=e=>{et=e},Pe=e=>{O=e},Ae=e=>{B=e},tt=e=>{ue=e},Te=async e=>{ge=e,localStorage.setItem("resourceOrder",JSON.stringify(e)),await je()},Ne=async e=>{fe=e,localStorage.setItem("assetOrder",JSON.stringify(e)),await je()},Be=async e=>{me=e,localStorage.setItem("modifierOrder",JSON.stringify(e)),await je()},je=async()=>{try{let{parseAllData:e}=await Promise.resolve().then(()=>(D(),Q)),{savePageSnapshot:o}=await Promise.resolve().then(()=>(R(),G)),t=e();await o(O,A,t),console.log("Snapshot updated with UI state changes")}catch(e){console.error("Failed to update snapshot with UI state:",e)}},oe=e=>{document.body.className=document.body.className.split(" ").filter(o=>!o.startsWith("theme-")).join(" "),document.body.classList.add(`theme-${e}`),tt(e),console.log(`Applied theme: ${e}`)},De=()=>{let e=document.getElementById("available-themes");return e&&e.textContent.trim()?e.textContent.trim().split("|").map(o=>o.trim()):["modern","material-dark","material-light","cyberpunk-dark"]}});var G={};ke(G,{deleteFromFirestore:()=>se,deleteFromLocalStorage:()=>re,getAppId:()=>ye,getPrivateCollectionRef:()=>vt,initializeFirebase:()=>Re,loadPageSnapshot:()=>ze,loadPersistentCodex:()=>Je,loadPersistentCodexFromLocalStorage:()=>bt,mergeArrayByName:()=>j,processAndSaveCodex:()=>Fe,savePageSnapshot:()=>Ue,saveToFirestore:()=>Y,saveToLocalStorage:()=>X});import{getAuth as ut,signInWithCustomToken as gt,onAuthStateChanged as ft}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore as mt,collection as ve,doc as K,getDoc as be,setDoc as ne,serverTimestamp as he,getDocs as xt,deleteDoc as ht}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";var ye,vt,Re,j,Ue,ze,Je,bt,X,re,Y,se,Fe,R=Ee(()=>{H();D();ye=()=>typeof __app_id<"u"?__app_id:"default-app-id",vt=(e,o,t,r)=>{let s=`artifacts/${o}/users/${t}/${r}`;return ve(e,s)},Re=e=>new Promise(o=>{try{let t=typeof __firebase_config<"u"?JSON.parse(__firebase_config):{},r=typeof __initial_auth_token<"u"?__initial_auth_token:null,s;if(typeof e>"u"&&typeof firebase<"u"&&typeof firebase.initializeApp<"u")e=firebase.initializeApp,console.warn("Using global firebase.initializeApp as passed parameter was undefined.");else if(typeof e>"u"){console.error("initializeApp function not provided. Cannot initialize Firebase."),q(!1),o();return}if(Object.keys(t).length>0)s=e(t);else if(typeof firebase<"u"&&firebase.apps.length>0)s=firebase.app(),console.log("Firebase app already initialized, using existing app.");else{console.warn("Firebase config not found and no existing app. Running in offline mode."),q(!1),o();return}Oe(ut(s)),He(mt(s)),ft(P,async i=>{if(i)Pe(i.uid),q(!0),console.log("Firebase authenticated:",i.uid),o();else if(r)try{await gt(P,r)}catch(l){console.error("Custom token sign-in failed:",l);try{await signInAnonymously(P)}catch(c){console.error("Anonymous sign-in failed after custom token failure:",c),console.warn("No authentication available, running in offline mode."),q(!1),o()}}else try{await signInAnonymously(P)}catch(l){console.error("Anonymous sign-in failed:",l),console.warn("No authentication available, running in offline mode."),q(!1),o()}})}catch(t){console.error("Firebase initialization error:",t),q(!1),o()}}),j=(e,o,t="name")=>{if(!e||e.length===0)return o;if(!o||o.length===0)return e;let r=new Map;return e.forEach(s=>{s[t]&&r.set(s[t],s)}),o.forEach(s=>{s[t]&&r.set(s[t],{...r.get(s[t]),...s})}),Array.from(r.values())},Ue=async(e,o,t)=>{try{let r=F(),s=e||U,i=t.page_number,l=`snapshot_pages_${r}`,c=JSON.parse(localStorage.getItem(l)||"[]"),h=c.find(p=>p.page_number===i),g=Date.now();if(h){console.log(`Page ${i} snapshot was already saved in this session. Skipping duplicate save.`);return}else c.push({page_number:i,timestamp:g}),localStorage.setItem(l,JSON.stringify(c));let{resourceOrder:f,assetOrder:b,modifierOrder:C,assetCategoryStates:d,codexCategoryStates:v,isInfoPanelPinned:u,currentThemeName:a}=await Promise.resolve().then(()=>(H(),J));if(P&&O){let p=ye(),x=K(o,`artifacts/${r}/users/${s}/pages/page_${i}`),m={...t,globalStates:{resourceOrder:f,assetOrder:b,modifierOrder:C,assetCategoryStates:d,codexCategoryStates:v,isInfoPanelPinned:u,currentThemeName:a},timestamp:he()};await ne(x,m,{merge:!0}),console.log(`Page snapshot saved to Firebase: ${r}/page_${i} (Theme: ${a})`)}else{let p=`page_snapshot_${r}_${i}`,x={...t,globalStates:{resourceOrder:f,assetOrder:b,modifierOrder:C,assetCategoryStates:d,codexCategoryStates:v,isInfoPanelPinned:u,currentThemeName:a},timestamp:new Date().toISOString()};localStorage.setItem(p,JSON.stringify(x)),console.log(`Page snapshot saved to localStorage: ${p} (Theme: ${a})`)}}catch(r){console.error("Error saving page snapshot:",r)}},ze=async(e,o,t,r)=>{try{let s=e||U;if(P&&O){let i=ye(),l=K(o,`artifacts/${t}/users/${s}/pages/page_${r}`),c=await be(l);return c.exists()?(console.log(`Page snapshot loaded from Firebase: ${t}/page_${r}`),c.data()):(console.log(`No snapshot found: ${t}/page_${r}`),null)}else{let i=`page_snapshot_${t}_${r}`,l=localStorage.getItem(i);return l?(console.log(`Page snapshot loaded from localStorage: ${i}`),JSON.parse(l)):(console.log(`No snapshot found in localStorage: ${i}`),null)}}catch(s){return console.error("Error loading page snapshot:",s),null}},Je=async(e,o,t)=>{let r={resources:[],asset:[],modifiers:[],entities:[]},s=e||U,i=K(o,`artifacts/${t}/users/${s}/game_state/current_state`),l=await be(i);l.exists()&&(r.resources=l.data().resources||[],r.asset=l.data().asset||[],r.modifiers=l.data().modifiers||[]);let c=ve(o,`artifacts/${t}/users/${s}/codex_entities`);return(await xt(c)).forEach(g=>{r.entities.push(g.data())}),r},bt=(e,o)=>{let t={resources:[],asset:[],modifiers:[],entities:[]},r=e||U;return t.resources=JSON.parse(localStorage.getItem(`artifacts_${o}_users_${r}_resources`)||"[]"),t.asset=JSON.parse(localStorage.getItem(`artifacts_${o}_users_${r}_asset`)||"[]"),t.modifiers=JSON.parse(localStorage.getItem(`artifacts_${o}_users_${r}_modifiers`)||"[]"),t.entities=JSON.parse(localStorage.getItem(`artifacts_${o}_users_${r}_entities`)||"[]"),t},X=(e,o,t,r)=>{let i=`artifacts_${r}_users_${e||U}_${o}`,l=JSON.parse(localStorage.getItem(i)||"[]"),c=t;l.length>0&&(c=j(l,t,"id")),localStorage.setItem(i,JSON.stringify(c)),console.log(`Data type ${o} for session ${r} saved to localStorage.`)},re=(e,o,t,r)=>{let i=`artifacts_${r}_users_${e||U}_${o}`,c=JSON.parse(localStorage.getItem(i)||"[]").filter(h=>h.id!==t);localStorage.setItem(i,JSON.stringify(c)),console.log(`Item ${t} of type ${o} for session ${r} deleted from localStorage.`)},Y=async(e,o,t,r,s)=>{try{let i=ye();if(t==="new"||t==="update"){let l=ve(o,`artifacts/${s}/users/${e}/codex_entities`);for(let c of r)if(c.id){let h=K(l,c.id);await ne(h,{...c,updatedAt:he()},{merge:!0})}console.log(`Codex entities (${t}) saved for session ${s}:`,r.length)}else if(t==="resources"||t==="asset"||t==="modifiers"){let l=K(o,`artifacts/${s}/users/${e}/game_state/current_state`),c=await be(l),h=c.exists()?c.data():{},g=r;h[t]&&(g=j(h[t],r,"id")),await ne(l,{[t]:g,updatedAt:he()},{merge:!0}),console.log(`Game state (${t}) saved for session ${s}:`,g.length)}}catch(i){console.error(`Firestore \uC800\uC7A5 \uC2E4\uD328 [${t}] for session ${s}:`,i)}},se=async(e,o,t,r,s)=>{try{let i;if(t==="entity")i=K(o,`artifacts/${s}/users/${e}/codex_entities`,r),await ht(i),console.log(`Entity ${r} deleted from session ${s}.`);else if(t==="resource"||t==="asset"||t==="modifier"){let l=K(o,`artifacts/${s}/users/${e}/game_state/current_state`),c=await be(l);if(c.exists()){let g=(c.data()[t+"s"]||[]).filter(f=>f.id!==r);await ne(l,{[t+"s"]:g},{merge:!0}),console.log(`${t} ${r} removed from game_state for session ${s}.`)}}}catch(i){console.error(`Error deleting ${t} ${r} for session ${s}:`,i)}},Fe=async(e,o,t)=>{try{let r=F(),s=e||U,i=t.page_number,l=`processed_pages_${r}`,c=JSON.parse(localStorage.getItem(l)||"[]"),h=c.find(f=>f.page_number===i),g=Date.now();if(h){console.log(`Page ${i} was already processed in this session. Skipping duplicate save.`);return}else c.push({page_number:i,timestamp:g}),localStorage.setItem(l,JSON.stringify(c));if(P&&O){if(t.codex_new&&t.codex_new.length>0&&await Y(s,o,"new",t.codex_new,r),t.codex_update&&t.codex_update.length>0&&await Y(s,o,"update",t.codex_update,r),t.resources&&t.resources.length>0&&await Y(s,o,"resources",t.resources,r),t.asset&&t.asset.length>0&&await Y(s,o,"asset",t.asset,r),t.modifiers&&t.modifiers.length>0&&await Y(s,o,"modifiers",t.modifiers,r),t.removed){for(let d of t.removed.entities)await se(s,o,"entity",d,r);for(let d of t.removed.resources)await se(s,o,"resource",d,r);for(let d of t.removed.assets)await se(s,o,"asset",d,r);for(let d of t.removed.modifiers)await se(s,o,"modifier",d,r)}let f=ve(o,`artifacts/${r}/users/${s}/page_index`),b=`${r}_${t.page_number}`,C=K(f,b);await ne(C,{sessionId:r,page_number:t.page_number,title:t.header.title,timestamp:he()},{merge:!0}),console.log(`Page index entry for page ${t.page_number} in session ${r} saved to Firebase.`),console.log("All codex data processed and saved successfully to Firebase.")}else{if(t.codex_new&&t.codex_new.length>0&&X(s,"entities",t.codex_new,r),t.codex_update&&t.codex_update.length>0&&X(s,"entities",t.codex_update,r),t.resources&&t.resources.length>0&&X(s,"resources",t.resources,r),t.asset&&t.asset.length>0&&X(s,"asset",t.asset,r),t.modifiers&&t.modifiers.length>0&&X(s,"modifiers",t.modifiers,r),t.removed){for(let v of t.removed.entities)re(s,"entities",v,r);for(let v of t.removed.resources)re(s,"resources",v,r);for(let v of t.removed.assets)re(s,"asset",v,r);for(let v of t.removed.modifiers)re(s,"modifiers",v,r)}console.log(`All codex data processed and saved successfully to localStorage for session ${r}.`);let f="saved_pages",b=JSON.parse(localStorage.getItem(f)||"[]"),C={sessionId:r,page_number:t.page_number,title:t.header.title,timestamp:new Date().toISOString()},d=b.findIndex(v=>v.sessionId===r&&v.page_number===t.page_number);d>-1?b[d]=C:b.push(C),localStorage.setItem(f,JSON.stringify(b)),console.log(`Page index entry for page ${t.page_number} in session ${r} saved to localStorage index.`)}}catch(r){console.error("Error processing codex data:",r)}}});R();D();H();D();H();D();R();var n=(e,o="",t="")=>{let r=document.createElement(e);return o&&(r.className=o),t&&(r.textContent=t),r},rt=()=>{let e=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");e.id="active-overlay";let o=n("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6");o.innerHTML=`<h2 class="text-2xl font-bold text-[var(--ui-accent-primary)] mb-4">Image Modal (Placeholder)</h2><p>Image content will go here.</p><button class="mt-4 p-2 bg-[var(--ui-accent-primary)] rounded" onclick="document.getElementById('active-overlay').remove()">Close</button>`,e.appendChild(o),document.body.appendChild(e)},ot=async(e,o)=>{let t=await ze(O,A,e,o);if(!t){console.warn(`Could not load snapshot for session ${e}, page ${o}.`);return}console.log(`Loading snapshot: ${e}/page_${o} - complete data restoration`);let{applyTheme:r}=await Promise.resolve().then(()=>(H(),J)),s=t.globalStates?.currentThemeName||t.current_theme;if(s&&(console.log(`Applying theme from snapshot: ${s}`),r(s)),t.globalStates){let{setIsInfoPanelPinned:l,saveResourceOrder:c,saveAssetOrder:h,saveModifierOrder:g}=await Promise.resolve().then(()=>(H(),J));if(t.globalStates.isInfoPanelPinned!==void 0&&l(t.globalStates.isInfoPanelPinned),t.globalStates.resourceOrder&&c(t.globalStates.resourceOrder),t.globalStates.assetOrder&&h(t.globalStates.assetOrder),t.globalStates.modifierOrder&&g(t.globalStates.modifierOrder),t.globalStates.assetCategoryStates){let{assetCategoryStates:f}=await Promise.resolve().then(()=>(H(),J));Object.assign(f,t.globalStates.assetCategoryStates)}if(t.globalStates.codexCategoryStates){let{codexCategoryStates:f}=await Promise.resolve().then(()=>(H(),J));Object.assign(f,t.globalStates.codexCategoryStates)}}let i=document.getElementById("app-root");i.innerHTML="",Ie(),we(t),$e(t),Ce(t),Se(t),_e(t),console.log(`Page snapshot fully restored: ${e}/page_${o} with theme: ${s}`)},qe=async()=>{let{getDocs:e,collection:o,query:t,orderBy:r}=await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"),s=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");s.id="active-overlay";let i=n("div","w-full max-w-2xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),l=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),c=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uD398\uC774\uC9C0 \uBE0C\uB77C\uC6B0\uC9D5");l.appendChild(c);let h=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");h.textContent="\xD7",h.onclick=()=>s.remove(),l.appendChild(h),i.appendChild(l);let g=n("div","flex-grow overflow-y-auto"),f=n("p","text-[var(--text-color-secondary)]","\uD398\uC774\uC9C0 \uBAA9\uB85D \uBD88\uB7EC\uC624\uB294 \uC911...");if(g.appendChild(f),i.appendChild(g),s.appendChild(i),document.body.appendChild(s),P&&A&&O){let b=F(),C=o(A,`artifacts/${b}/users/${O}/page_index`),d=t(C,r("timestamp","desc")),v=await e(d);if(g.innerHTML="",v.empty)g.innerHTML='<p class="text-[var(--text-color-secondary)]">\uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let u=n("ul","space-y-2");v.forEach(a=>{let p=a.data(),x=n("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),m=p.timestamp?new Date(p.timestamp.toDate()).toLocaleString():"\uB0A0\uC9DC \uC5C6\uC74C";x.innerHTML=`
                    <div class="font-bold text-[var(--text-color-primary)]">${p.title||"\uC81C\uBAA9 \uC5C6\uC74C"} (Page ${p.page_number})</div>
                    <div class="text-sm text-[var(--text-color-secondary)]">\uC800\uC7A5 \uC2DC\uAC04: ${m}</div>
                    <div class="text-xs text-[var(--text-color-secondary)]">ID: ${p.sessionId}</div>
                `,x.addEventListener("click",()=>{ot(p.sessionId,p.page_number),s.remove()}),u.appendChild(x)}),g.appendChild(u)}}else{let C=JSON.parse(localStorage.getItem("saved_branches")||"[]");if(g.innerHTML="",C.length===0)g.innerHTML='<p class="text-[var(--text-color-secondary)]">\uB85C\uCEEC\uC5D0 \uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let d=n("ul","space-y-2");C.forEach(v=>{let u=`page_snapshot_${v}`,a=localStorage.getItem(u);if(a){let p=JSON.parse(a),x=n("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),m=new Date().toLocaleString();x.innerHTML=`
                        <div class="font-bold text-[var(--text-color-primary)]">${p.header.title||"\uC81C\uBAA9 \uC5C6\uC74C"} (Page ${p.page_number})</div>
                        <div class="text-sm text-[var(--text-color-secondary)]">\uB85C\uCEEC \uC800\uC7A5 (\uC2DC\uAC04: ${m})</div>
                        <div class="text-xs text-[var(--text-color-secondary)]">ID: ${v}</div>
                    `,x.addEventListener("click",()=>{ot(p.sessionId,p.page_number),s.remove()}),d.appendChild(x)}}),g.appendChild(d)}}},st=()=>{let e=document.getElementById("active-overlay");e&&e.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let t=n("div","w-full max-w-md max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","Codex");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),t.appendChild(r);let l=n("div","flex-grow overflow-y-auto"),c=W(),h=[];if(c.codex_new&&c.codex_new.length>0&&h.push(...c.codex_new),c.codex_update&&c.codex_update.length>0&&h.push(...c.codex_update),h.length>0){let g=h.reduce((f,b)=>{let C="General";return b.data&&b.data.length>0&&b.data[0].category?C=b.data[0].category:b.id==="player_001"&&(C="Player"),f[C]||(f[C]=[]),f[C].push(b),f},{});for(let f in g){let b=n("div","mb-4 last:mb-0"),C=z[f]!==!1,d=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");d.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${f}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${C?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,b.appendChild(d);let v=n("div","overflow-hidden transition-all duration-300 ease-in-out");C?v.style.maxHeight=v.scrollHeight+"px":v.style.maxHeight="0px";let u=n("ul","space-y-2 mt-2 codex-list");u.setAttribute("data-list-type","codex"),g[f].forEach((a,p)=>{let x=!(a.id==="player_001"&&!h.some(y=>y.id==="player_002")),m=Ke(a,x);u.appendChild(m)}),v.appendChild(u),b.appendChild(v),l.appendChild(b),d.addEventListener("click",()=>{let a=d.querySelector("svg");v.style.maxHeight==="0px"||v.style.maxHeight===""?(v.style.maxHeight=v.scrollHeight+"px",a.classList.remove("rotate-180"),z[f]=!0):(v.style.maxHeight="0px",a.classList.add("rotate-180"),z[f]=!1)})}}else{let g=n("p","text-sm text-[var(--text-color-secondary)] italic");g.textContent="Codex \uBAA9\uB85D\uC774 \uBE44\uC5B4\uC788\uC2B5\uB2C8\uB2E4",l.appendChild(g)}t.appendChild(l),o.appendChild(t),document.body.appendChild(o),o.addEventListener("click",g=>{g.target===o&&o.remove()})},nt=()=>{let e=document.getElementById("active-overlay");e&&e.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let t=n("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uC124\uC815");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),t.appendChild(r);let l=n("div","mb-6"),c=n("label","block text-sm font-medium text-[var(--text-color-primary)] mb-2","\uD14C\uB9C8 \uC120\uD0DD");l.appendChild(c);let h=n("select","w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-md text-[var(--text-color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--ui-accent-secondary)]");te.forEach(g=>{let f=n("option","",g);f.value=g,g===ue&&(f.selected=!0),h.appendChild(f)}),h.addEventListener("change",async g=>{oe(g.target.value),localStorage.setItem("userPreferredTheme",g.target.value);let{savePageSnapshot:f}=await Promise.resolve().then(()=>(R(),G)),b=W();await f(O,A,b),console.log(`Snapshot updated with new theme: ${g.target.value}`)}),l.appendChild(h),t.appendChild(l),o.appendChild(t),document.body.appendChild(o),o.addEventListener("click",g=>{g.target===o&&o.remove()})};var at=()=>{let e=document.getElementById("active-overlay");e&&e.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let t=n("div","w-full max-w-6xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl flex flex-col"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] p-6 pb-3"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\u{1F41B} Debug Data Browser");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),t.appendChild(r);let l=n("div","flex gap-2 px-6 pt-3 border-b border-[var(--border-color)]"),c=["Entities","Resources","Assets","Modifiers","localStorage","Page History"],h=[];c.forEach((u,a)=>{let p=n("button",`px-4 py-2 rounded-t-md transition-colors ${a===0?"bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]":"text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}`);p.textContent=u,p.dataset.tab=u,h.push(p),l.appendChild(p)}),t.appendChild(l);let g=n("div","flex-grow overflow-y-auto p-6");t.appendChild(g);let f=W(),b=F(),C=u=>{let a=n("pre","bg-black/30 p-4 rounded-md overflow-x-auto text-xs text-[var(--text-color-primary)] font-mono");return a.textContent=JSON.stringify(u,null,2),a},d=(u,a)=>{let p=n("div","mb-6"),x=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3",a);if(p.appendChild(x),!u||u.length===0){let w=n("p","text-[var(--text-color-secondary)] italic","\uB370\uC774\uD130 \uC5C6\uC74C");return p.appendChild(w),p}let m=n("table","w-full border-collapse text-sm");m.style.fontSize="12px";let y=n("thead"),E=n("tr","border-b border-[var(--border-color)]"),$=Object.keys(u[0]);$.forEach(w=>{let I=n("th","text-left p-2 text-[var(--text-color-primary)] font-bold",w);E.appendChild(I)}),y.appendChild(E),m.appendChild(y);let S=n("tbody");return u.forEach((w,I)=>{let M=n("tr","border-b border-[var(--border-color)]/30 hover:bg-[var(--bg-color)] transition-colors");$.forEach(N=>{let _=n("td","p-2 text-[var(--text-color-secondary)]"),L=w[N];typeof L=="object"&&L!==null?_.textContent=JSON.stringify(L):_.textContent=L??"null",M.appendChild(_)}),S.appendChild(M)}),m.appendChild(S),p.appendChild(m),p},v=u=>{switch(g.innerHTML="",u){case"Entities":g.appendChild(d(f.codex_new,"New Entities")),g.appendChild(d(f.codex_update,"Updated Entities"));break;case"Resources":g.appendChild(d(f.resources,"Resources"));break;case"Assets":g.appendChild(d(f.asset,"Assets"));break;case"Modifiers":g.appendChild(d(f.modifiers,"Modifiers"));break;case"localStorage":let a=n("div"),p=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","localStorage Keys");a.appendChild(p);let x=n("div","space-y-2"),m=Object.keys(localStorage).filter(_=>_.includes(b)||_.includes("processed_pages")||_.includes("snapshot_pages"));if(m.forEach(_=>{let L=n("div","bg-black/20 p-3 rounded-md"),Le=n("div","font-bold text-[var(--ui-accent-primary)] mb-2",_);L.appendChild(Le);try{let V=localStorage.getItem(_),k=JSON.parse(V);L.appendChild(C(k))}catch{let k=n("pre","text-xs text-[var(--text-color-secondary)]",localStorage.getItem(_));L.appendChild(k)}x.appendChild(L)}),m.length===0){let _=n("p","text-[var(--text-color-secondary)] italic","\uAD00\uB828 localStorage \uD56D\uBAA9 \uC5C6\uC74C");x.appendChild(_)}a.appendChild(x),g.appendChild(a);break;case"Page History":let y=n("div"),E=`processed_pages_${b}`,$=JSON.parse(localStorage.getItem(E)||"[]");y.appendChild(d($,"Processed Pages (Anti-duplicate)"));let S=`snapshot_pages_${b}`,w=JSON.parse(localStorage.getItem(S)||"[]");y.appendChild(d(w,"Saved Snapshots"));let I=n("div","mt-6 bg-black/20 p-4 rounded-md"),M=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","Current Page Info");I.appendChild(M);let N={sessionId:b,page_number:f.page_number,title:f.header.title,timestamp:new Date().toISOString()};I.appendChild(C(N)),y.appendChild(I),g.appendChild(y);break}};h.forEach(u=>{u.addEventListener("click",()=>{h.forEach(a=>{a.className="px-4 py-2 rounded-t-md transition-colors text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}),u.className="px-4 py-2 rounded-t-md transition-colors bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]",v(u.dataset.tab)})}),v("Entities"),o.appendChild(t),document.body.appendChild(o),o.addEventListener("click",u=>{u.target===o&&o.remove()})};var T=null,Ke=(e,o=!0)=>{let t=n("li","text-sm p-2 rounded-md transition-colors");o?(t.setAttribute("draggable","true"),t.classList.add("cursor-grab","bg-[var(--bg-panel)]/30","hover:bg-[var(--bg-panel)]/50")):t.classList.add("bg-amber-900/30","border","border-amber-600","text-amber-200","font-bold");let r=e.classifications||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--text-color-secondary)] mt-1">${Object.entries(r).map(([i,l])=>{let c=l.label||i,h=l.value||l;return`<span>${c}: ${h}</span>`}).join(", ")}</div>`:"";return t.innerHTML=`<strong class="text-[var(--ui-accent-secondary)]">${e.name||e.id}</strong>
        ${s}
    `,t.dataset.entityId=e.id,o&&(t.addEventListener("dragstart",ae),t.addEventListener("dragend",ie),t.addEventListener("dragover",le),t.addEventListener("drop",ce)),t},yt=(e,o)=>{let t=n("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");t.setAttribute("draggable","true"),t.setAttribute("data-index",o),t.dataset.assetId=e.id;let r=e.properties||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--ui-accent-tertiary)] mb-1">${Object.entries(r).map(([i,l])=>{let c=l.label||i,h=l.value||l;return`<span>${c}: ${h}</span>`}).join(", ")}</div>`:"";return t.innerHTML=`
        <div class="flex justify-between items-center mb-1">
            <span class="font-semibold text-[var(--text-color-primary)] text-base">${e.name}</span>
            <span class="text-xs font-mono text-[var(--text-color-secondary)]">x${e.quantity}</span>
        </div>
        ${s}
        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] leading-tight">${e.description}</p>`:""}
    `,t.addEventListener("dragstart",ae),t.addEventListener("dragend",ie),t.addEventListener("dragover",le),t.addEventListener("drop",ce),t},wt=(e,o)=>{let t=n("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");t.setAttribute("draggable","true"),t.setAttribute("data-index",o),t.dataset.resourceId=e.id;let r=e.max&&e.max>0?e.current/e.max*100:0;return t.innerHTML=`
        <div class="flex justify-between items-baseline text-sm mb-1">
            <span class="font-semibold text-[var(--text-color-primary)]">${e.name}</span>
            <span class="font-mono text-[var(--text-color-secondary)]">${e.current}${e.max?"/"+e.max:""}</span>
        </div>
        ${e.max?`
            <div class="w-full bg-black/30 rounded-full h-1.5 mb-1">
                <div class="h-1.5 rounded-full transition-all duration-300" style="width: ${r}%; background-color: ${e.color};"></div>
            </div>
        `:""}
        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${e.description}</p>`:""}
    `,t.addEventListener("dragstart",ae),t.addEventListener("dragend",ie),t.addEventListener("dragover",le),t.addEventListener("drop",ce),t},Ct=(e,o)=>{let t=n("li","bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors");t.setAttribute("draggable","true"),t.setAttribute("data-index",o),t.dataset.modifierId=e.id;let r="text-[var(--ui-accent-secondary)]",s="";return e.alignment==="good"?(r="text-green-400",s="border-l-2 border-green-400"):e.alignment==="bad"?(r="text-red-400",s="border-l-2 border-red-400"):e.alignment==="neutral"&&(r="text-gray-400",s="border-l-2 border-gray-400"),t.className=`bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors ${s}`,t.innerHTML=`
        <div class="flex justify-between items-baseline mb-1">
            <span class="font-semibold ${r} text-sm">${e.name}</span>
            ${e.duration?`<span class="text-xs text-[var(--text-color-secondary)]">${e.duration}</span>`:""}
        </div>
        <div class="text-xs text-[var(--text-color-secondary)]">
            ${e.target} ${e.operation} ${e.value}
        </div>
        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${e.description}</p>`:""}
    `,t.addEventListener("dragstart",ae),t.addEventListener("dragend",ie),t.addEventListener("dragover",le),t.addEventListener("drop",ce),t},ae=e=>{T=e.target.closest('[draggable="true"]'),T&&(T.style.opacity="0.5",T.classList.add("border","border-stone-500"),e.dataTransfer.effectAllowed="move")},ie=e=>{if(T){T.style.opacity="1",T.classList.remove("border","border-stone-500");let o=T.parentNode;if(o){let t=o.getAttribute("data-list-type");St(o,t)}}},le=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";let o=e.target.closest('[draggable="true"]');if(o&&o!==T&&o.parentNode===T.parentNode){let t=o.getBoundingClientRect(),r=t.top+t.height/2;e.clientY<r?o.parentNode.insertBefore(T,o):o.parentNode.insertBefore(T,o.nextSibling)}},ce=e=>{e.preventDefault(),e.stopPropagation()},St=(e,o)=>{if(!e||!o)return;let r=Array.from(e.children).map(s=>o==="resource"?s.dataset.resourceId:o==="asset"?s.dataset.assetId||s.textContent.trim():o==="modifier"?s.dataset.modifierId:o==="codex"?s.dataset.entityId:null).filter(s=>s!==null);o==="resource"?(Te(r),console.log("Resource order saved:",r)):o==="asset"?(Ne(r),console.log("Asset order saved:",r)):o==="modifier"&&(Be(r),console.log("Modifier order saved:",r))},Ve=(e,o,t="id")=>{if(!o||o.length===0)return e;let r=new Map(e.map(l=>[l[t],l])),s=[],i=[];return o.forEach(l=>{let c=r.get(l);c&&(s.push(c),r.delete(l))}),r.forEach(l=>i.push(l)),[...s,...i]},we=e=>{let o=document.getElementById("header-container");if(!o)return;let t=e.title||"\uC81C 1\uC7A5: \uADF8\uB9BC\uC790\uC758 \uAE38";o.innerHTML=`
        <div class="flex justify-between items-center">
            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
            <h1 class="text-2xl font-bold text-[var(--text-color-primary)] text-center cursor-pointer" id="header-title">${t}</h1>
            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
        </div>
        <div class="text-center text-sm text-[var(--text-color-secondary)] mt-2">
            <span>${e.hud?.location||"\uC54C \uC218 \uC5C6\uB294 \uC7A5\uC18C"}</span>
            <span class="mx-2">\xB7</span>
            <span>${e.hud?.date||""}</span>
            <span class="mx-2">\xB7</span>
            <span>${e.hud?.time||""}</span>
        </div>
    `,document.getElementById("header-title").addEventListener("click",qe)};var Ce=e=>{let o=document.getElementById("info-panel-container");if(!o||!e.scene_elements||e.scene_elements.length===0)return;o.innerHTML="";let t=e.page_number||0,r=n("div","relative w-full transition-all duration-300 ease-in-out cursor-pointer rounded-lg hover:bg-[var(--bg-panel)]");B&&r.classList.add("is-expanded","bg-[var(--bg-panel)]");let s=n("div","h-24"),i=n("div","relative w-full h-full flex items-center"),l=n("div","absolute left-[5%] top-1/2 w-[90%] h-0.5 bg-[var(--info-panel-line-color)]");i.appendChild(l);let c=[...e.scene_elements].sort((d,v)=>d.distance-v.distance),h=Math.max(...e.scene_elements.map(d=>Math.abs(d.distance)),5),g=[],f=!1;c.forEach((d,v)=>{let u=Math.max(-h,Math.min(h,d.distance)),a=c.filter(k=>k.distance===d.distance),p=a.findIndex(k=>k.name===d.name),x=a.length,m=2,E=-((x-1)*m)/2,S=50+u/h*45+E+p*m,w=n("div","absolute top-1/2");w.style.left=`${S}%`,w.style.transform="translate(-50%, -50%)";let I=n("div","w-3 h-3 rounded-full border-2 transition-all duration-200 ease-in-out relative flex items-center justify-center"),M,N;if(d.type==="player"){let k="var(--player-color)";I.classList.add(`border-[${k}]`,`bg-[${k}]`),N="text-black",M=k}else{let k,de;d.type==="ally"?(k="var(--ally-color-border)",de="var(--ally-color-fill)"):d.type==="enemy"?(k="var(--enemy-color-border)",de="var(--enemy-color-fill)"):(k="var(--object-color-border)",de="var(--object-color-fill)"),I.classList.add(`border-[${k}]`,`bg-[${de}]`),N="text-white",M=k}r.classList.contains("is-expanded")&&(I.classList.remove("w-3","h-3"),I.classList.add("w-5","h-5"));let _=n("div","absolute bottom-full mb-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap");_.style.left="50%",_.style.transform="translateX(-50%)",_.style.color=M,_.style.fontSize="16px",_.style.fontWeight="bold",_.textContent=d.name,d.type==="player"&&t===1?_.style.opacity="1":_.style.opacity="0",I.appendChild(_);let L=null;d.type==="player"&&d.status&&(L=n("div","absolute top-full mt-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap text-xs text-[var(--text-color-secondary)]"),L.style.left="50%",L.style.transform="translateX(-50%)",L.textContent=d.status,t===1?L.style.opacity="1":L.style.opacity="0",I.appendChild(L));let Le=String.fromCharCode(65+v),V=n("span",`relative text-xs font-bold ${N} opacity-0 transition-opacity duration-200`);V.textContent=Le,r.classList.contains("is-expanded")&&(V.style.opacity="1"),I.appendChild(V),g.push({dot:I,indexSpan:V,elementWrapper:w,nameTooltip:_,statusTooltip:L,element:d}),w.addEventListener("mouseenter",()=>{r.classList.contains("is-expanded")||(_.style.opacity="1",L&&t===1&&(L.style.opacity="1"))}),w.addEventListener("mouseleave",()=>{d.type==="player"&&t===1&&!f?(_.style.opacity="1",L&&(L.style.opacity="1")):(_.style.opacity="0",L&&(L.style.opacity="0"))}),w.appendChild(I),i.appendChild(w)}),r.addEventListener("mouseenter",()=>{f=!0,t===1&&g.forEach(({nameTooltip:d,statusTooltip:v,element:u})=>{u.type==="player"&&(d.style.opacity="0",v&&(v.style.opacity="0"))})}),r.addEventListener("mouseleave",()=>{f=!1,t===1&&!r.classList.contains("is-expanded")&&g.forEach(({nameTooltip:d,statusTooltip:v,element:u})=>{u.type==="player"&&(d.style.opacity="1",v&&(v.style.opacity="1"))})}),s.appendChild(i),r.appendChild(s);let b=n("div","max-h-0 overflow-hidden transition-all duration-300 ease-in-out relative"),C=n("ul","space-y-3 px-[5%] pb-12 opacity-0 transition-opacity duration-300");c.forEach((d,v)=>{let u=n("li","text-[var(--text-color-primary)]"),a;d.type==="player"?a="text-[var(--player-color)]":d.type==="ally"?a="text-[var(--ally-color-border)]":d.type==="enemy"?a="text-[var(--enemy-color-border)]":d.type==="object"&&(a="text-[var(--object-color-border)]");let p=String.fromCharCode(65+v);u.innerHTML=`<strong class="font-bold ${a}">${p}. ${d.name}:</strong> <span class="text-[var(--text-color-secondary)]">${d.status}</span>`,C.appendChild(u)}),b.appendChild(C),r.appendChild(b),r.classList.contains("is-expanded")&&(b.style.maxHeight=b.scrollHeight+"px",setTimeout(()=>{C.classList.add("opacity-100")},50),i.style.pointerEvents="none"),r.addEventListener("click",d=>{if(d.target.closest(".pointer-events-auto"))return;let v=r.classList.contains("is-expanded");if(B&&v)return;r.classList.toggle("is-expanded")?(r.classList.add("bg-[var(--bg-panel)]"),b.style.maxHeight=b.scrollHeight+"px",setTimeout(()=>{C.classList.add("opacity-100")},50),i.style.pointerEvents="none",g.forEach(({dot:a,indexSpan:p})=>{a.classList.remove("w-3","h-3"),a.classList.add("w-5","h-5"),p.style.opacity="1"})):(r.classList.remove("bg-[var(--bg-panel)]"),C.classList.remove("opacity-100"),b.style.maxHeight="0px",i.style.pointerEvents="auto",g.forEach(({dot:a,indexSpan:p})=>{a.classList.remove("w-5","h-5"),a.classList.add("w-3","h-3"),p.style.opacity="0"}))}),o.appendChild(r)},Se=e=>{let o=document.getElementById("choices-container");if(!o||!e.choices||e.choices.length===0)return;o.innerHTML="";let t=n("div","w-full pt-4");e.choices.forEach((r,s)=>{let i=n("div","w-full text-left py-2 text-[var(--text-color-primary)] text-lg"),l=Me(r);i.innerHTML=`<span class="font-bold text-[var(--text-accent-bold)]">${s+1}.</span> ${l}`,t.appendChild(i)}),o.appendChild(t)},$e=e=>{let o=document.getElementById("content-container");if(o){if(o.innerHTML="",e.story_html){let t=n("div","space-y-4");t.innerHTML=e.story_html,o.appendChild(t)}else if(e.main_content&&e.main_content.length>0){let t=n("div","space-y-4");e.main_content.forEach(r=>{let s=n("p");r.id==="narration"?(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.textContent=r.content):r.id==="thought"?(s.className="text-[var(--text-accent-bold)] leading-loose text-lg pl-4 border-l-2 border-[var(--ui-accent-secondary)]",s.textContent=r.content):r.id==="document"?(s.className="text-[var(--text-color-primary)] leading-relaxed text-base bg-[var(--bg-panel)]/50 p-4 rounded border border-[var(--border-color)]",s.textContent=r.content):r.id==="system"?(s.className="text-[var(--text-color-secondary)] text-sm text-center",s.textContent=r.content):r.id==="quote"?(s.className="text-[var(--text-accent-aux)] leading-relaxed text-lg pl-6 border-l-4 border-[var(--text-accent-aux)] italic",s.textContent=r.content):(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.innerHTML=`<span class="font-bold text-[var(--text-accent-italic)]">${r.id}:</span> ${r.content}`),t.appendChild(s)}),o.appendChild(t)}}},_e=e=>{let o=!0,t=null,r=0,s=0,i="",l=document.getElementById("hud-container");if(!l)return;l.innerHTML="";let c=n("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(e.resources&&e.resources.length>0){let u=e.resources.filter(m=>m.max!==null&&m.max!==void 0),a=e.resources.filter(m=>m.max===null||m.max===void 0),p=[...u,...a];p=Ve(p,ge,"id");let x=n("ul","space-y-2 resource-list");x.setAttribute("data-list-type","resource"),p.forEach((m,y)=>{let E=wt(m,y);x.appendChild(E)}),c.appendChild(x)}else{let u=n("p","text-sm text-[var(--text-color-secondary)] italic");u.textContent="\uC790\uC6D0 \uC815\uBCF4\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4",c.appendChild(u)}if(e.modifiers&&e.modifiers.length>0){let u=n("div","mt-4 pt-3 border-t border-[var(--border-color)]"),a=n("ul","space-y-2 modifier-list");a.setAttribute("data-list-type","modifier"),Ve(e.modifiers,me,"id").forEach((x,m)=>{let y=Ct(x,m);a.appendChild(y)}),u.appendChild(a),c.appendChild(u)}let h=n("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(e.asset&&e.asset.length>0){let u=e.asset.reduce((a,p)=>{let x=p.category||"\uAE30\uD0C0";return a[x]||(a[x]=[]),a[x].push(p),a},{});for(let a in u){let p=n("div","mb-4 last:mb-0");p.setAttribute("draggable","true"),p.dataset.categoryName=a,p.addEventListener("dragstart",ae),p.addEventListener("dragend",ie),p.addEventListener("dragover",le),p.addEventListener("drop",ce);let x=Z[a]!==!1,m=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");m.innerHTML=`
                            <span class="font-bold text-[var(--ui-accent-primary)] text-lg">${a}</span>
                            <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${x?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        `,p.appendChild(m);let y=n("div","overflow-hidden transition-all duration-300 ease-in-out");x?y.style.maxHeight=y.scrollHeight+"px":y.style.maxHeight="0px";let E=n("ul","space-y-2 mt-2 asset-list");E.setAttribute("data-list-type","asset"),Ve(u[a],fe,"id").forEach((S,w)=>{let I=yt(S,w);E.appendChild(I)}),y.appendChild(E),p.appendChild(y),h.appendChild(p),m.addEventListener("click",async()=>{let S=m.querySelector("svg");y.style.maxHeight==="0px"||y.style.maxHeight===""?(y.style.maxHeight=y.scrollHeight+"px",S.classList.remove("rotate-180"),Z[a]=!0):(y.style.maxHeight="0px",S.classList.add("rotate-180"),Z[a]=!1);try{let{parseAllData:w}=await Promise.resolve().then(()=>(D(),Q)),{savePageSnapshot:I}=await Promise.resolve().then(()=>(R(),G)),{auth:M,db:N,currentUserId:_}=await Promise.resolve().then(()=>(H(),J)),L=w();await I(_,N,L)}catch(w){console.error("Failed to save asset category state:",w)}})}}else{let u=n("p","text-sm text-[var(--text-color-secondary)] italic");u.textContent="Asset\uC774 \uC5C6\uC2B5\uB2C8\uB2E4",h.appendChild(u)}let g=n("div","hidden sm:block bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]"),f=[];if(e.codex_new&&e.codex_new.length>0&&f.push(...e.codex_new),e.codex_update&&e.codex_update.length>0&&f.push(...e.codex_update),f.length>0){let u=f.reduce((a,p)=>{let x="General";return p.data&&p.data.length>0&&p.data[0].category?x=p.data[0].category:p.id==="player_001"&&(x="Player"),a[x]||(a[x]=[]),a[x].push(p),a},{});for(let a in u){let p=n("div","mb-4 last:mb-0"),x=z[a]!==!1,m=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");m.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${a}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${x?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,p.appendChild(m);let y=n("div","overflow-hidden transition-all duration-300 ease-in-out");x?y.style.maxHeight=y.scrollHeight+"px":y.style.maxHeight="0px";let E=n("ul","space-y-2 mt-2 codex-list");E.setAttribute("data-list-type","codex"),u[a].forEach(($,S)=>{let w=!($.id==="player_001"&&!f.some(M=>M.id==="player_002")),I=Ke($,w);E.appendChild(I)}),y.appendChild(E),p.appendChild(y),g.appendChild(p),m.addEventListener("click",async()=>{let $=m.querySelector("svg");y.style.maxHeight==="0px"||y.style.maxHeight===""?(y.style.maxHeight=y.scrollHeight+"px",$.classList.remove("rotate-180"),z[a]=!0):(y.style.maxHeight="0px",$.classList.add("rotate-180"),z[a]=!1);try{let{parseAllData:S}=await Promise.resolve().then(()=>(D(),Q)),{savePageSnapshot:w}=await Promise.resolve().then(()=>(R(),G)),{auth:I,db:M,currentUserId:N}=await Promise.resolve().then(()=>(H(),J)),_=S();await w(N,M,_)}catch(S){console.error("Failed to save codex category state:",S)}})}}let b=[c,h,g],C=[];b.forEach(u=>{u.classList.add("flex","flex-col");let a=n("div","mt-4 w-full flex items-end");a.setAttribute("data-tip-spacer","true"),a.style.transition="height 300ms ease-out",a.style.willChange="height",u.appendChild(a),C.push(a),l.appendChild(u)});let d=()=>{requestAnimationFrame(()=>{let p=b,x=p.map($=>{let S=$.querySelector('[data-tip-spacer="true"]'),w=S?S.style.display:"";S&&(S.style.display="none");let I=$.offsetHeight;return S&&(S.style.display=w),I});if(x.length===0)return;let m=Math.max(...x);if(p.forEach(($,S)=>{let w=x[S],I=m-w,M=$.querySelector('[data-tip-spacer="true"]');M&&(M.style.height=`${Math.max(0,I)}px`)}),clearTimeout(t),m<1e3){p.forEach($=>{let S=$.querySelector('[data-tip-spacer="true"]');S&&(S.innerHTML="")});return}let y=[];p.forEach(($,S)=>{m-x[S]>50&&y.push({panel:$,index:S})});let E=y.length>0?y[y.length-1]:null;if(p.forEach(($,S)=>{if(!E||S!==E.index){let w=$.querySelector('[data-tip-spacer="true"]');w&&(w.innerHTML="")}}),!o&&E){let $=Date.now();if($<s)return;let S=E.panel.querySelector('[data-tip-spacer="true"]');($-r>1e4||i==="")&&(r=$,i=xe[Math.floor(Math.random()*xe.length)]);let w=S.querySelector("p");w||(w=document.createElement("p"),w.className="p-4 text-sm text-[var(--text-color-secondary)] italic transition-opacity duration-300 opacity-0",S.appendChild(w)),w.textContent=i,requestAnimationFrame(()=>w.classList.remove("opacity-0")),t=setTimeout(()=>{w.classList.add("opacity-0"),s=Date.now()+1e4,setTimeout(()=>{w.parentNode&&w.parentNode.removeChild(w)},300)},5e3)}})},v=new ResizeObserver(d);b.forEach(u=>{v.observe(u)}),setTimeout(()=>{d(),o=!1},150)},Ie=()=>{let e=document.getElementById("app-root");e.innerHTML="";let o=n("div","max-w-5xl mx-auto p-4 sm:p-6"),t=n("div","mb-8");t.id="header-container";let r=n("div","my-8");r.id="content-container";let s=n("div","my-1");s.id="info-panel-container";let i=n("div");i.id="choices-container";let l=n("div","relative mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 items-start");l.id="hud-container";let c=n("div","flex justify-end gap-2 mt-2");c.id="hud-controls-container";let h=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");h.id="image-button",h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',h.addEventListener("click",rt);let g=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");g.id="page-button",g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',g.addEventListener("click",qe);let f=n("button","sm:hidden p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");f.id="codex-button",f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>';let b=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");b.id="pin-infopanel-button",b.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',b.addEventListener("click",async()=>{Ae(!B),b.classList.toggle("bg-[var(--ui-accent-primary)]",B);let v=document.querySelector("#info-panel-container > div");if(v){let u=v.classList.contains("is-expanded");(B&&!u||!B&&u)&&v.click()}try{let{parseAllData:u}=await Promise.resolve().then(()=>(D(),Q)),{savePageSnapshot:a}=await Promise.resolve().then(()=>(R(),G)),{auth:p,db:x,currentUserId:m}=await Promise.resolve().then(()=>(H(),J)),y=u();await a(m,x,y),console.log(`Info panel pin state saved: ${B}`)}catch(u){console.error("Failed to save info panel pin state:",u)}});let C=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");C.id="settings-button",C.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67c-.2.2-.3.3-.3.3s-.2.1-.3.1c-.2.1-.4.1-.6.1-.2 0-.4 0-.6-.1a1.65 1.65 0 0 0-1.67-.3c-.2-.2-.3-.3-.3-.3s-.1-.2-.1-.3c-.1-.2-.1-.4-.1-.6 0-.2 0-.4.1-.6a1.65 1.65 0 0 0 .3-1.67c.2-.2.3-.3.3-.3s-.2-.1.3-.1c.2-.1.4-.1.6-.1.2 0 .4 0 .6.1a1.65 1.65 0 0 0 1.67.3c.2.2.3.3.3.3s.1.2.1.3c.1.2.1.4.1.6 0 .2 0 .4-.1.6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';let d=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors border border-[var(--border-color)]");d.id="debug-button",d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="6" width="8" height="1"></rect><rect x="8" y="11" width="8" height="1"></rect><rect x="8" y="16" width="8" height="1"></rect><path d="M12 3v3"></path><path d="M12 18v3"></path><path d="M4 9h2"></path><path d="M18 9h2"></path><path d="M4 15h2"></path><path d="M18 15h2"></path><circle cx="12" cy="12" r="9"></circle></svg>',d.title="Debug Data Browser",c.appendChild(h),c.appendChild(g),c.appendChild(f),c.appendChild(b),c.appendChild(C),c.appendChild(d),o.append(t,r,s,i,c,l),e.appendChild(o)};H();import{initializeApp as $t}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";var it=async()=>{try{await Re($t);let e=W(),o=e.sessionId,t={resources:[],asset:[],modifiers:[],codex_new:[],codex_update:[]};t=await Je(O,A,o),e.resources=j(t.resources,e.resources,"id"),e.asset=j(t.asset,e.asset,"id"),e.modifiers=j(t.modifiers,e.modifiers,"id"),e.codex_new=j(t.entities,e.codex_new,"id"),e.codex_update&&e.codex_update.length>0&&(e.codex_new=j(e.codex_new,e.codex_update,"id"),e.codex_update=[]);let s=De()[0]||"modern";ee&&te.includes(ee)&&(s=ee),oe(s),await Fe(O,A,e),await Ue(O,A,e),Ie(),we(e),$e(e),Ce(e),Se(e),_e(e);let i=document.getElementById("codex-button");i&&i.addEventListener("click",st);let l=document.getElementById("settings-button");l&&l.addEventListener("click",nt);let c=document.getElementById("debug-button");c&&c.addEventListener("click",at),console.log("Application initialized successfully")}catch(e){console.error("Initialization Error:",e),document.body.innerHTML=`<div class="text-red-400 p-8">Error: ${e.message}</div>`}};document.addEventListener("DOMContentLoaded",async()=>{await it()});
//# sourceMappingURL=bundle.min.js.map

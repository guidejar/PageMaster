var et=Object.defineProperty;var _e=(t,o)=>()=>(t&&(o=t(t=0)),o);var Ue=(t,o)=>{for(var e in o)et(t,e,{get:o[e],enumerable:!0})};var F={};Ue(F,{DEFAULT_OFFLINE_USER_ID:()=>j,applyTheme:()=>Z,assetCategoryStates:()=>X,assetOrder:()=>ue,auth:()=>P,codexCategoryStates:()=>R,controlTips:()=>ge,currentThemeName:()=>de,currentUserId:()=>M,db:()=>A,isAuthReady:()=>qe,isInfoPanelPinned:()=>D,modifierOrder:()=>fe,parseAvailableThemes:()=>Pe,resourceOrder:()=>pe,saveAssetOrder:()=>Oe,saveModifierOrder:()=>He,saveResourceOrder:()=>Me,setAuth:()=>Ie,setCurrentThemeName:()=>Fe,setCurrentUserId:()=>Ee,setDb:()=>Le,setIsAuthReady:()=>z,setIsInfoPanelPinned:()=>ke,themeNames:()=>Q,userPreferredTheme:()=>Y});var P,A,qe,M,j,X,R,D,de,Y,pe,ue,fe,ge,Q,Ie,Le,z,Ee,ke,Fe,Me,Oe,He,Z,Pe,N=_e(()=>{P=null,A=null,qe=!1,M=null,j="offline-user",X={},R={},D=!1,de="default",Y=localStorage.getItem("userPreferredTheme")||null,pe=JSON.parse(localStorage.getItem("resourceOrder")||"[]"),ue=JSON.parse(localStorage.getItem("assetOrder")||"[]"),fe=JSON.parse(localStorage.getItem("modifierOrder")||"[]"),ge=["\uC120\uD0DD\uC9C0 \uC704\uC5D0 \uC788\uB294 \uAC00\uB85C\uC904\uACFC \uC810\uB4E4\uC740 \uC778\uD3EC\uD328\uB110\uC785\uB2C8\uB2E4. \uD55C\uBC88 \uB20C\uB7EC\uBCF4\uC138\uC694.","\uC120\uD0DD\uC9C0 \uC6B0\uCE21 \uD558\uB2E8\uC5D0 \uC704\uCE58\uD55C \uC544\uC774\uCF58\uC744 \uB20C\uB7EC\uD574\uBCF4\uC138\uC694.","\uB4DC\uB798\uADF8 \uC564 \uB4DC\uB86D\uC73C\uB85C \uBAA9\uB85D\uC758 \uC704\uCE58\uB97C \uBC14\uAFD4\uBCF4\uC138\uC694.","\uD398\uC774\uC9C0 \uC81C\uBAA9\uC744 \uD074\uB9AD\uD558\uBA74 \uD398\uC774\uC9C0 \uBAA9\uB85D\uC774 \uB098\uC635\uB2C8\uB2E4.","\uD398\uC774\uC9C0 \uC591 \uC606\uC758 \uD654\uC0B4\uD45C\uB85C \uD398\uC774\uC9C0\uB97C \uC774\uB3D9\uD560 \uC218 \uC788\uC5B4\uC694.","\uC120\uD0DD\uC9C0 \uC544\uB798\uC5D0 \uC788\uB294 \uC774\uBBF8\uC9C0 \uC544\uC774\uCF58\uC744 \uD074\uB9AD\uD558\uBA74 \uD574\uB2F9 \uC7A5\uBA74\uC5D0 \uB9DE\uB294 \uC774\uBBF8\uC9C0\uB97C \uC0DD\uC131\uD560 \uC218 \uC788\uC5B4\uC694."],Q=["fantasy","stone-cyan-dark","cyberpunk","horror","modern","cyberpunk-dark","material-dark","material-light"],Ie=t=>{P=t},Le=t=>{A=t},z=t=>{qe=t},Ee=t=>{M=t},ke=t=>{D=t},Fe=t=>{de=t},Me=t=>{pe=t,localStorage.setItem("resourceOrder",JSON.stringify(t))},Oe=t=>{ue=t,localStorage.setItem("assetOrder",JSON.stringify(t))},He=t=>{fe=t,localStorage.setItem("modifierOrder",JSON.stringify(t))},Z=t=>{document.body.className=document.body.className.split(" ").filter(o=>!o.startsWith("theme-")).join(" "),document.body.classList.add(`theme-${t}`),Fe(t),console.log(`Applied theme: ${t}`)},Pe=()=>{let t=document.getElementById("available-themes");return t&&t.textContent.trim()?t.textContent.trim().split("|").map(o=>o.trim()):["modern","material-dark","material-light","cyberpunk-dark"]}});var tt,ot,Ke,rt,st,nt,at,Te,K,V,ee=_e(()=>{te();tt=()=>{let t={};return document.querySelectorAll('script[type="text/html"]').forEach(o=>{let e=o.getAttribute("data-id"),r=o.getAttribute("data-category");e&&(t[e]={category:r||"unknown",content:o.innerHTML.trim()})}),t},ot=t=>{if(!t)return"";let o=t;return o=o.replace(/^### (.+)$/gm,'<h3 class="text-xl font-bold text-[var(--text-color-primary)] mt-4 mb-2">$1</h3>'),o=o.replace(/^## (.+)$/gm,'<h2 class="text-2xl font-bold text-[var(--text-color-primary)] mt-6 mb-3">$1</h2>'),o=o.replace(/^# (.+)$/gm,'<h1 class="text-3xl font-bold text-[var(--text-color-primary)] mt-8 mb-4">$1</h1>'),o=o.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),o=o.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),o=o.replace(/\n\n/g,'</p><p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'),o='<p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'+o+"</p>",o},Ke=t=>{if(!t)return"";let o=t;return o=o.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),o=o.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),o},rt=()=>{let t=document.getElementById("header");if(!t)return{title:"",location:"",date:"",time:""};let e=t.textContent.trim().split("|").map(r=>r.trim());return{title:e[0]||"",location:e[1]||"",date:e[2]||"",time:e[3]||""}},st=()=>{let t=document.getElementById("story");return t?ot(t.textContent.trim()):""},nt=()=>{let t=document.getElementById("choices");return t?t.textContent.trim().split(`
`).map(r=>r.trim()).filter(r=>r).map(r=>r.replace(/^\d+\.\s*/,"").trim()):[]},at=()=>{let t=document.getElementById("scene-data");return t?t.textContent.trim().split(`
`).map(r=>r.trim()).filter(r=>r).map(r=>{let s=r.split("|").map(i=>i.trim());return{type:s[1]||"",name:s[2]||"",distance:s[3]?Number(s[3]):0,status:s[4]||""}}).filter(r=>r.type):[]},Te=t=>{let o=document.querySelectorAll('script[id="codex"]'),e=null;o.forEach(f=>{f.getAttribute("data-type")===t&&(e=f)});let r={entities:[],resources:[],assets:[],modifiers:[],removed:{entities:[],resources:[],assets:[],modifiers:[]}};if(!e)return r;let i=e.textContent.trim().split(`
`).map(f=>f.trim()).filter(f=>f),p={},c={},m={},g={};return i.forEach(f=>{let b=f.indexOf("|");if(b===-1)return;let w=f.substring(0,b).trim(),l=f.substring(b+1).trim(),h=w.split("."),u=h[0],a=h[1],d=h.slice(2);if(t==="remove"){u==="entity"?r.removed.entities.push(a):u==="resource"?r.removed.resources.push(a):u==="asset"?r.removed.assets.push(a):u==="effect"&&r.removed.modifiers.push(a);return}if(u==="entity"){p[a]||(p[a]={id:a,classifications:{}});let v=p[a];if(d.length===1){let x=d[0];v[x]=l}else if(d[0]==="classifications"&&d.length===2){let x=d[1],y=l.indexOf(":");if(y>-1){let I=l.substring(0,y).trim(),$=l.substring(y+1).trim();v.classifications[x]={label:I,value:$}}else v.classifications[x]={label:x,value:l}}}else if(u==="resource"){c[a]||(c[a]={id:a});let v=c[a],x=d[0];x==="current"||x==="max"?v[x]=l==="NULL"?null:Number(l):v[x]=l}else if(u==="asset"){m[a]||(m[a]={id:a,properties:{}});let v=m[a];if(d.length===1){let x=d[0];x==="quantity"?v[x]=Number(l):v[x]=l}else if(d[0]==="properties"&&d.length===2){let x=d[1],y=l.indexOf(":");if(y>-1){let I=l.substring(0,y).trim(),$=l.substring(y+1).trim();v.properties[x]={label:I,value:$}}else v.properties[x]={label:x,value:l}}}else if(u==="effect"){g[a]||(g[a]={id:a});let v=g[a],x=d[0];v[x]=l}}),r.entities=Object.values(p),r.resources=Object.values(c),r.assets=Object.values(m),r.modifiers=Object.values(g),r},K=()=>{let t=document.getElementById("session-uuid");if(t&&t.textContent.trim()){let e=t.textContent.trim();return console.log(`Session ID loaded from HTML: ${e}`),e}let o=localStorage.getItem("gameSessionId");return o||(o=crypto.randomUUID(),localStorage.setItem("gameSessionId",o),console.warn("New Session ID generated and stored in localStorage.")),o},V=()=>{let t=rt(),o=st(),e=nt(),r=at(),s=Te("new"),i=Te("update"),p=Te("remove"),c=s.entities,m=i.entities,g=[...s.resources,...i.resources],f=[...s.assets,...i.assets],b=[...s.modifiers,...i.modifiers],w=p.removed,l=document.querySelector("title"),h=l?parseInt(l.textContent.match(/\d+/)?.[0]||"0"):0,u=tt();return{sessionId:K(),header:t,story_html:o,choices:e,scene_elements:r,codex_new:c,codex_update:m,resources:g,asset:f,modifiers:b,removed:w,html_docs:u,page_number:h,define:c,update:m,hud:{location:t.location,date:t.date,time:t.time},title:t.title,character_stats:{resources:g,attributes:{},equipment:{},name:"",level:1},information_panel:[]}}});var Ve={};Ue(Ve,{deleteFromFirestore:()=>re,deleteFromLocalStorage:()=>oe,getAppId:()=>H,getPrivateCollectionRef:()=>ft,initializeFirebase:()=>Ae,loadPageSnapshot:()=>Be,loadPersistentCodex:()=>je,loadPersistentCodexFromLocalStorage:()=>gt,mergeArrayByName:()=>B,processAndSaveCodex:()=>Re,savePageSnapshot:()=>Ne,saveToFirestore:()=>G,saveToLocalStorage:()=>W});import{getAuth as it,signInWithCustomToken as lt,onAuthStateChanged as ct}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore as dt,collection as xe,doc as J,getDoc as he,setDoc as se,serverTimestamp as me,getDocs as pt,deleteDoc as ut}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";var H,ft,Ae,B,Ne,Be,je,gt,W,oe,G,re,Re,te=_e(()=>{N();ee();H=()=>typeof __app_id<"u"?__app_id:"default-app-id",ft=(t,o,e)=>{let s=`artifacts/${H()}/users/${o}/${e}`;return xe(t,s)},Ae=t=>new Promise(o=>{try{let e=typeof __firebase_config<"u"?JSON.parse(__firebase_config):{},r=typeof __initial_auth_token<"u"?__initial_auth_token:null,s;if(typeof t>"u"&&typeof firebase<"u"&&typeof firebase.initializeApp<"u")t=firebase.initializeApp,console.warn("Using global firebase.initializeApp as passed parameter was undefined.");else if(typeof t>"u"){console.error("initializeApp function not provided. Cannot initialize Firebase."),z(!1),o();return}if(Object.keys(e).length>0)s=t(e);else if(typeof firebase<"u"&&firebase.apps.length>0)s=firebase.app(),console.log("Firebase app already initialized, using existing app.");else{console.warn("Firebase config not found and no existing app. Running in offline mode."),z(!1),o();return}Ie(it(s)),Le(dt(s)),ct(P,async i=>{if(i)Ee(i.uid),z(!0),console.log("Firebase authenticated:",i.uid),o();else if(r)try{await lt(P,r)}catch(p){console.error("Custom token sign-in failed:",p);try{await signInAnonymously(P)}catch(c){console.error("Anonymous sign-in failed after custom token failure:",c),console.warn("No authentication available, running in offline mode."),z(!1),o()}}else try{await signInAnonymously(P)}catch(p){console.error("Anonymous sign-in failed:",p),console.warn("No authentication available, running in offline mode."),z(!1),o()}})}catch(e){console.error("Firebase initialization error:",e),z(!1),o()}}),B=(t,o,e="name")=>{if(!t||t.length===0)return o;if(!o||o.length===0)return t;let r=new Map;return t.forEach(s=>{s[e]&&r.set(s[e],s)}),o.forEach(s=>{s[e]&&r.set(s[e],{...r.get(s[e]),...s})}),Array.from(r.values())},Ne=async(t,o,e)=>{try{let r=K(),s=t||j,i=e.page_number,p=`snapshot_pages_${r}`,c=JSON.parse(localStorage.getItem(p)||"[]"),m=c.find(d=>d.page_number===i),g=Date.now();if(m){console.log(`Page ${i} snapshot was already saved in this session. Skipping duplicate save.`);return}else c.push({page_number:i,timestamp:g}),localStorage.setItem(p,JSON.stringify(c));let{resourceOrder:f,assetOrder:b,modifierOrder:w,assetCategoryStates:l,codexCategoryStates:h,isInfoPanelPinned:u,currentThemeName:a}=await Promise.resolve().then(()=>(N(),F));if(P&&M){let d=H(),v=J(o,`artifacts/${d}/users/${s}/pages/${r}/snapshots/page_${i}`),x={...e,globalStates:{resourceOrder:f,assetOrder:b,modifierOrder:w,assetCategoryStates:l,codexCategoryStates:h,isInfoPanelPinned:u,currentThemeName:a},timestamp:me()};await se(v,x,{merge:!0}),console.log(`Page snapshot saved to Firebase: ${r}/page_${i} (Theme: ${a})`)}else{let d=`page_snapshot_${r}_${i}`,v={...e,globalStates:{resourceOrder:f,assetOrder:b,modifierOrder:w,assetCategoryStates:l,codexCategoryStates:h,isInfoPanelPinned:u,currentThemeName:a},timestamp:new Date().toISOString()};localStorage.setItem(d,JSON.stringify(v)),console.log(`Page snapshot saved to localStorage: ${d} (Theme: ${a})`)}}catch(r){console.error("Error saving page snapshot:",r)}},Be=async(t,o,e,r)=>{try{let s=t||j;if(P&&M){let i=H(),p=J(o,`artifacts/${i}/users/${s}/pages/${e}/snapshots/page_${r}`),c=await he(p);return c.exists()?(console.log(`Page snapshot loaded from Firebase: ${e}/page_${r}`),c.data()):(console.log(`No snapshot found: ${e}/page_${r}`),null)}else{let i=`page_snapshot_${e}_${r}`,p=localStorage.getItem(i);return p?(console.log(`Page snapshot loaded from localStorage: ${i}`),JSON.parse(p)):(console.log(`No snapshot found in localStorage: ${i}`),null)}}catch(s){return console.error("Error loading page snapshot:",s),null}},je=async(t,o,e)=>{let r={resources:[],asset:[],modifiers:[],entities:[]},s=H(),i=t||j,p=J(o,`artifacts/${s}/users/${i}/sessions/${e}/game_state/current_state`),c=await he(p);c.exists()&&(r.resources=c.data().resources||[],r.asset=c.data().asset||[],r.modifiers=c.data().modifiers||[]);let m=xe(o,`artifacts/${s}/users/${i}/sessions/${e}/codex_entities`);return(await pt(m)).forEach(f=>{r.entities.push(f.data())}),r},gt=(t,o)=>{let e={resources:[],asset:[],modifiers:[],entities:[]},r=H(),s=t||j;return e.resources=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${s}_sessions_${o}_resources`)||"[]"),e.asset=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${s}_sessions_${o}_asset`)||"[]"),e.modifiers=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${s}_sessions_${o}_modifiers`)||"[]"),e.entities=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${s}_sessions_${o}_entities`)||"[]"),e},W=(t,o,e,r)=>{let s=t||j,i=`artifacts_${H()}_users_${s}_sessions_${r}_${o}`,p=JSON.parse(localStorage.getItem(i)||"[]"),c=e;p.length>0&&(c=B(p,e,"id")),localStorage.setItem(i,JSON.stringify(c)),console.log(`Data type ${o} for session ${r} saved to localStorage.`)},oe=(t,o,e,r)=>{let s=t||j,i=`artifacts_${H()}_users_${s}_sessions_${r}_${o}`,c=JSON.parse(localStorage.getItem(i)||"[]").filter(m=>m.id!==e);localStorage.setItem(i,JSON.stringify(c)),console.log(`Item ${e} of type ${o} for session ${r} deleted from localStorage.`)},G=async(t,o,e,r,s)=>{try{let i=H();if(e==="new"||e==="update"){let p=xe(o,`artifacts/${i}/users/${t}/sessions/${s}/codex_entities`);for(let c of r)if(c.id){let m=J(p,c.id);await se(m,{...c,updatedAt:me()},{merge:!0})}console.log(`Codex entities (${e}) saved for session ${s}:`,r.length)}else if(e==="resources"||e==="asset"||e==="modifiers"){let p=J(o,`artifacts/${i}/users/${t}/sessions/${s}/game_state/current_state`),c=await he(p),m=c.exists()?c.data():{},g=r;m[e]&&(g=B(m[e],r,"id")),await se(p,{[e]:g,updatedAt:me()},{merge:!0}),console.log(`Game state (${e}) saved for session ${s}:`,g.length)}}catch(i){console.error(`Firestore \uC800\uC7A5 \uC2E4\uD328 [${e}] for session ${s}:`,i)}},re=async(t,o,e,r,s)=>{try{let i=H(),p;if(e==="entity")p=J(o,`artifacts/${i}/users/${t}/sessions/${s}/codex_entities`,r),await ut(p),console.log(`Entity ${r} deleted from session ${s}.`);else if(e==="resource"||e==="asset"||e==="modifier"){let c=J(o,`artifacts/${i}/users/${t}/sessions/${s}/game_state/current_state`),m=await he(c);if(m.exists()){let f=(m.data()[e+"s"]||[]).filter(b=>b.id!==r);await se(c,{[e+"s"]:f},{merge:!0}),console.log(`${e} ${r} removed from game_state for session ${s}.`)}}}catch(i){console.error(`Error deleting ${e} ${r} for session ${s}:`,i)}},Re=async(t,o,e)=>{try{let r=K(),s=t||j,i=e.page_number,p=`processed_pages_${r}`,c=JSON.parse(localStorage.getItem(p)||"[]"),m=c.find(f=>f.page_number===i),g=Date.now();if(m){console.log(`Page ${i} was already processed in this session. Skipping duplicate save.`);return}else c.push({page_number:i,timestamp:g}),localStorage.setItem(p,JSON.stringify(c));if(P&&M){if(e.codex_new&&e.codex_new.length>0&&await G(s,o,"new",e.codex_new,r),e.codex_update&&e.codex_update.length>0&&await G(s,o,"update",e.codex_update,r),e.resources&&e.resources.length>0&&await G(s,o,"resources",e.resources,r),e.asset&&e.asset.length>0&&await G(s,o,"asset",e.asset,r),e.modifiers&&e.modifiers.length>0&&await G(s,o,"modifiers",e.modifiers,r),e.removed){for(let l of e.removed.entities)await re(s,o,"entity",l,r);for(let l of e.removed.resources)await re(s,o,"resource",l,r);for(let l of e.removed.assets)await re(s,o,"asset",l,r);for(let l of e.removed.modifiers)await re(s,o,"modifier",l,r)}let f=xe(o,`artifacts/${H()}/users/${s}/page_index`),b=`${r}_${e.page_number}`,w=J(f,b);await se(w,{sessionId:r,page_number:e.page_number,title:e.header.title,timestamp:me()},{merge:!0}),console.log(`Page index entry for page ${e.page_number} in session ${r} saved to Firebase.`),console.log("All codex data processed and saved successfully to Firebase.")}else{if(e.codex_new&&e.codex_new.length>0&&W(s,"entities",e.codex_new,r),e.codex_update&&e.codex_update.length>0&&W(s,"entities",e.codex_update,r),e.resources&&e.resources.length>0&&W(s,"resources",e.resources,r),e.asset&&e.asset.length>0&&W(s,"asset",e.asset,r),e.modifiers&&e.modifiers.length>0&&W(s,"modifiers",e.modifiers,r),e.removed){for(let h of e.removed.entities)oe(s,"entities",h,r);for(let h of e.removed.resources)oe(s,"resources",h,r);for(let h of e.removed.assets)oe(s,"asset",h,r);for(let h of e.removed.modifiers)oe(s,"modifiers",h,r)}console.log(`All codex data processed and saved successfully to localStorage for session ${r}.`);let f="saved_pages",b=JSON.parse(localStorage.getItem(f)||"[]"),w={sessionId:r,page_number:e.page_number,title:e.header.title,timestamp:new Date().toISOString()},l=b.findIndex(h=>h.sessionId===r&&h.page_number===e.page_number);l>-1?b[l]=w:b.push(w),localStorage.setItem(f,JSON.stringify(b)),console.log(`Page index entry for page ${e.page_number} in session ${r} saved to localStorage index.`)}}catch(r){console.error("Error processing codex data:",r)}}});te();ee();N();ee();N();ee();te();var n=(t,o="",e="")=>{let r=document.createElement(t);return o&&(r.className=o),e&&(r.textContent=e),r},Ge=()=>{let t=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");t.id="active-overlay";let o=n("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6");o.innerHTML=`<h2 class="text-2xl font-bold text-[var(--ui-accent-primary)] mb-4">Image Modal (Placeholder)</h2><p>Image content will go here.</p><button class="mt-4 p-2 bg-[var(--ui-accent-primary)] rounded" onclick="document.getElementById('active-overlay').remove()">Close</button>`,t.appendChild(o),document.body.appendChild(t)},We=async(t,o)=>{let e=await Be(M,A,t,o);if(!e){console.warn(`Could not load snapshot for session ${t}, page ${o}.`);return}console.log(`Loading snapshot: ${t}/page_${o} - complete data restoration`);let{applyTheme:r}=await Promise.resolve().then(()=>(N(),F)),s=e.globalStates?.currentThemeName||e.current_theme;if(s&&(console.log(`Applying theme from snapshot: ${s}`),r(s)),e.globalStates){let{setIsInfoPanelPinned:p,saveResourceOrder:c,saveAssetOrder:m,saveModifierOrder:g}=await Promise.resolve().then(()=>(N(),F));if(e.globalStates.isInfoPanelPinned!==void 0&&p(e.globalStates.isInfoPanelPinned),e.globalStates.resourceOrder&&c(e.globalStates.resourceOrder),e.globalStates.assetOrder&&m(e.globalStates.assetOrder),e.globalStates.modifierOrder&&g(e.globalStates.modifierOrder),e.globalStates.assetCategoryStates){let{assetCategoryStates:f}=await Promise.resolve().then(()=>(N(),F));Object.assign(f,e.globalStates.assetCategoryStates)}if(e.globalStates.codexCategoryStates){let{codexCategoryStates:f}=await Promise.resolve().then(()=>(N(),F));Object.assign(f,e.globalStates.codexCategoryStates)}}let i=document.getElementById("app-root");i.innerHTML="",Se(),ve(e),we(e),be(e),ye(e),Ce(e),console.log(`Page snapshot fully restored: ${t}/page_${o} with theme: ${s}`)},De=async()=>{let{getDocs:t,collection:o,query:e,orderBy:r}=await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"),s=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");s.id="active-overlay";let i=n("div","w-full max-w-2xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),p=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),c=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uD398\uC774\uC9C0 \uBE0C\uB77C\uC6B0\uC9D5");p.appendChild(c);let m=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");m.textContent="\xD7",m.onclick=()=>s.remove(),p.appendChild(m),i.appendChild(p);let g=n("div","flex-grow overflow-y-auto"),f=n("p","text-[var(--text-color-secondary)]","\uD398\uC774\uC9C0 \uBAA9\uB85D \uBD88\uB7EC\uC624\uB294 \uC911...");if(g.appendChild(f),i.appendChild(g),s.appendChild(i),document.body.appendChild(s),P&&A&&M){let b=o(A,`artifacts/${H()}/users/${M}/page_index`),w=e(b,r("timestamp","desc")),l=await t(w);if(g.innerHTML="",l.empty)g.innerHTML='<p class="text-[var(--text-color-secondary)]">\uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let h=n("ul","space-y-2");l.forEach(u=>{let a=u.data(),d=n("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),v=a.timestamp?new Date(a.timestamp.toDate()).toLocaleString():"\uB0A0\uC9DC \uC5C6\uC74C";d.innerHTML=`
                    <div class="font-bold text-[var(--text-color-primary)]">${a.title||"\uC81C\uBAA9 \uC5C6\uC74C"} (Page ${a.page_number})</div>
                    <div class="text-sm text-[var(--text-color-secondary)]">\uC800\uC7A5 \uC2DC\uAC04: ${v}</div>
                    <div class="text-xs text-[var(--text-color-secondary)]">ID: ${a.sessionId}</div>
                `,d.addEventListener("click",()=>{We(a.sessionId,a.page_number),s.remove()}),h.appendChild(d)}),g.appendChild(h)}}else{let w=JSON.parse(localStorage.getItem("saved_branches")||"[]");if(g.innerHTML="",w.length===0)g.innerHTML='<p class="text-[var(--text-color-secondary)]">\uB85C\uCEEC\uC5D0 \uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let l=n("ul","space-y-2");w.forEach(h=>{let u=`page_snapshot_${h}`,a=localStorage.getItem(u);if(a){let d=JSON.parse(a),v=n("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),x=new Date().toLocaleString();v.innerHTML=`
                        <div class="font-bold text-[var(--text-color-primary)]">${d.header.title||"\uC81C\uBAA9 \uC5C6\uC74C"} (Page ${d.page_number})</div>
                        <div class="text-sm text-[var(--text-color-secondary)]">\uB85C\uCEEC \uC800\uC7A5 (\uC2DC\uAC04: ${x})</div>
                        <div class="text-xs text-[var(--text-color-secondary)]">ID: ${h}</div>
                    `,v.addEventListener("click",()=>{We(d.sessionId,d.page_number),s.remove()}),l.appendChild(v)}}),g.appendChild(l)}}},Xe=()=>{let t=document.getElementById("active-overlay");t&&t.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let e=n("div","w-full max-w-md max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","Codex");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),e.appendChild(r);let p=n("div","flex-grow overflow-y-auto"),c=V(),m=[];if(c.codex_new&&c.codex_new.length>0&&m.push(...c.codex_new),c.codex_update&&c.codex_update.length>0&&m.push(...c.codex_update),m.length>0){let g=m.reduce((f,b)=>{let w="General";return b.data&&b.data.length>0&&b.data[0].category?w=b.data[0].category:b.id==="player_001"&&(w="Player"),f[w]||(f[w]=[]),f[w].push(b),f},{});for(let f in g){let b=n("div","mb-4 last:mb-0"),w=R[f]!==!1,l=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");l.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${f}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${w?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,b.appendChild(l);let h=n("div","overflow-hidden transition-all duration-300 ease-in-out");w?h.style.maxHeight=h.scrollHeight+"px":h.style.maxHeight="0px";let u=n("ul","space-y-2 mt-2 codex-list");u.setAttribute("data-list-type","codex"),g[f].forEach((a,d)=>{let v=!(a.id==="player_001"&&!m.some(y=>y.id==="player_002")),x=ze(a,v);u.appendChild(x)}),h.appendChild(u),b.appendChild(h),p.appendChild(b),l.addEventListener("click",()=>{let a=l.querySelector("svg");h.style.maxHeight==="0px"||h.style.maxHeight===""?(h.style.maxHeight=h.scrollHeight+"px",a.classList.remove("rotate-180"),R[f]=!0):(h.style.maxHeight="0px",a.classList.add("rotate-180"),R[f]=!1)})}}else{let g=n("p","text-sm text-[var(--text-color-secondary)] italic");g.textContent="Codex \uBAA9\uB85D\uC774 \uBE44\uC5B4\uC788\uC2B5\uB2C8\uB2E4",p.appendChild(g)}e.appendChild(p),o.appendChild(e),document.body.appendChild(o),o.addEventListener("click",g=>{g.target===o&&o.remove()})},Ye=()=>{let t=document.getElementById("active-overlay");t&&t.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let e=n("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uC124\uC815");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),e.appendChild(r);let p=n("div","mb-6"),c=n("label","block text-sm font-medium text-[var(--text-color-primary)] mb-2","\uD14C\uB9C8 \uC120\uD0DD");p.appendChild(c);let m=n("select","w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-md text-[var(--text-color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--ui-accent-secondary)]");Q.forEach(g=>{let f=n("option","",g);f.value=g,g===de&&(f.selected=!0),m.appendChild(f)}),m.addEventListener("change",async g=>{Z(g.target.value),localStorage.setItem("userPreferredTheme",g.target.value);let{savePageSnapshot:f}=await Promise.resolve().then(()=>(te(),Ve)),b=V();await f(M,A,b),console.log(`Snapshot updated with new theme: ${g.target.value}`)}),p.appendChild(m),e.appendChild(p),o.appendChild(e),document.body.appendChild(o),o.addEventListener("click",g=>{g.target===o&&o.remove()})};var Qe=()=>{let t=document.getElementById("active-overlay");t&&t.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let e=n("div","w-full max-w-6xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl flex flex-col"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] p-6 pb-3"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\u{1F41B} Debug Data Browser");r.appendChild(s);let i=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>o.remove(),r.appendChild(i),e.appendChild(r);let p=n("div","flex gap-2 px-6 pt-3 border-b border-[var(--border-color)]"),c=["Entities","Resources","Assets","Modifiers","localStorage","Page History"],m=[];c.forEach((u,a)=>{let d=n("button",`px-4 py-2 rounded-t-md transition-colors ${a===0?"bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]":"text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}`);d.textContent=u,d.dataset.tab=u,m.push(d),p.appendChild(d)}),e.appendChild(p);let g=n("div","flex-grow overflow-y-auto p-6");e.appendChild(g);let f=V(),b=K(),w=u=>{let a=n("pre","bg-black/30 p-4 rounded-md overflow-x-auto text-xs text-[var(--text-color-primary)] font-mono");return a.textContent=JSON.stringify(u,null,2),a},l=(u,a)=>{let d=n("div","mb-6"),v=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3",a);if(d.appendChild(v),!u||u.length===0){let C=n("p","text-[var(--text-color-secondary)] italic","\uB370\uC774\uD130 \uC5C6\uC74C");return d.appendChild(C),d}let x=n("table","w-full border-collapse text-sm");x.style.fontSize="12px";let y=n("thead"),I=n("tr","border-b border-[var(--border-color)]"),$=Object.keys(u[0]);$.forEach(C=>{let L=n("th","text-left p-2 text-[var(--text-color-primary)] font-bold",C);I.appendChild(L)}),y.appendChild(I),x.appendChild(y);let S=n("tbody");return u.forEach((C,L)=>{let O=n("tr","border-b border-[var(--border-color)]/30 hover:bg-[var(--bg-color)] transition-colors");$.forEach(U=>{let _=n("td","p-2 text-[var(--text-color-secondary)]"),E=C[U];typeof E=="object"&&E!==null?_.textContent=JSON.stringify(E):_.textContent=E??"null",O.appendChild(_)}),S.appendChild(O)}),x.appendChild(S),d.appendChild(x),d},h=u=>{switch(g.innerHTML="",u){case"Entities":g.appendChild(l(f.codex_new,"New Entities")),g.appendChild(l(f.codex_update,"Updated Entities"));break;case"Resources":g.appendChild(l(f.resources,"Resources"));break;case"Assets":g.appendChild(l(f.asset,"Assets"));break;case"Modifiers":g.appendChild(l(f.modifiers,"Modifiers"));break;case"localStorage":let a=n("div"),d=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","localStorage Keys");a.appendChild(d);let v=n("div","space-y-2"),x=Object.keys(localStorage).filter(_=>_.includes(b)||_.includes("processed_pages")||_.includes("snapshot_pages"));if(x.forEach(_=>{let E=n("div","bg-black/20 p-3 rounded-md"),$e=n("div","font-bold text-[var(--ui-accent-primary)] mb-2",_);E.appendChild($e);try{let q=localStorage.getItem(_),k=JSON.parse(q);E.appendChild(w(k))}catch{let k=n("pre","text-xs text-[var(--text-color-secondary)]",localStorage.getItem(_));E.appendChild(k)}v.appendChild(E)}),x.length===0){let _=n("p","text-[var(--text-color-secondary)] italic","\uAD00\uB828 localStorage \uD56D\uBAA9 \uC5C6\uC74C");v.appendChild(_)}a.appendChild(v),g.appendChild(a);break;case"Page History":let y=n("div"),I=`processed_pages_${b}`,$=JSON.parse(localStorage.getItem(I)||"[]");y.appendChild(l($,"Processed Pages (Anti-duplicate)"));let S=`snapshot_pages_${b}`,C=JSON.parse(localStorage.getItem(S)||"[]");y.appendChild(l(C,"Saved Snapshots"));let L=n("div","mt-6 bg-black/20 p-4 rounded-md"),O=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","Current Page Info");L.appendChild(O);let U={sessionId:b,page_number:f.page_number,title:f.header.title,timestamp:new Date().toISOString()};L.appendChild(w(U)),y.appendChild(L),g.appendChild(y);break}};m.forEach(u=>{u.addEventListener("click",()=>{m.forEach(a=>{a.className="px-4 py-2 rounded-t-md transition-colors text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}),u.className="px-4 py-2 rounded-t-md transition-colors bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]",h(u.dataset.tab)})}),h("Entities"),o.appendChild(e),document.body.appendChild(o),o.addEventListener("click",u=>{u.target===o&&o.remove()})};var T=null,ze=(t,o=!0)=>{let e=n("li","text-sm p-2 rounded-md transition-colors");o?(e.setAttribute("draggable","true"),e.classList.add("cursor-grab","bg-[var(--bg-panel)]/30","hover:bg-[var(--bg-panel)]/50")):e.classList.add("bg-amber-900/30","border","border-amber-600","text-amber-200","font-bold");let r=t.classifications||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--text-color-secondary)] mt-1">${Object.entries(r).map(([i,p])=>{let c=p.label||i,m=p.value||p;return`<span>${c}: ${m}</span>`}).join(", ")}</div>`:"";return e.innerHTML=`<strong class="text-[var(--ui-accent-secondary)]">${t.name||t.id}</strong>
        ${s}
    `,e.dataset.entityId=t.id,o&&(e.addEventListener("dragstart",ne),e.addEventListener("dragend",ae),e.addEventListener("dragover",ie),e.addEventListener("drop",le)),e},mt=(t,o)=>{let e=n("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");e.setAttribute("draggable","true"),e.setAttribute("data-index",o),e.dataset.assetId=t.id;let r=t.properties||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--ui-accent-tertiary)] mb-1">${Object.entries(r).map(([i,p])=>{let c=p.label||i,m=p.value||p;return`<span>${c}: ${m}</span>`}).join(", ")}</div>`:"";return e.innerHTML=`
        <div class="flex justify-between items-center mb-1">
            <span class="font-semibold text-[var(--text-color-primary)] text-base">${t.name}</span>
            <span class="text-xs font-mono text-[var(--text-color-secondary)]">x${t.quantity}</span>
        </div>
        ${s}
        ${t.description?`<p class="text-xs text-[var(--text-color-secondary)] leading-tight">${t.description}</p>`:""}
    `,e.addEventListener("dragstart",ne),e.addEventListener("dragend",ae),e.addEventListener("dragover",ie),e.addEventListener("drop",le),e},xt=(t,o)=>{let e=n("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");e.setAttribute("draggable","true"),e.setAttribute("data-index",o),e.dataset.resourceId=t.id;let r=t.max&&t.max>0?t.current/t.max*100:0;return e.innerHTML=`
        <div class="flex justify-between items-baseline text-sm mb-1">
            <span class="font-semibold text-[var(--text-color-primary)]">${t.name}</span>
            <span class="font-mono text-[var(--text-color-secondary)]">${t.current}${t.max?"/"+t.max:""}</span>
        </div>
        ${t.max?`
            <div class="w-full bg-black/30 rounded-full h-1.5 mb-1">
                <div class="h-1.5 rounded-full transition-all duration-300" style="width: ${r}%; background-color: ${t.color};"></div>
            </div>
        `:""}
        ${t.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${t.description}</p>`:""}
    `,e.addEventListener("dragstart",ne),e.addEventListener("dragend",ae),e.addEventListener("dragover",ie),e.addEventListener("drop",le),e},ht=(t,o)=>{let e=n("li","bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors");e.setAttribute("draggable","true"),e.setAttribute("data-index",o),e.dataset.modifierId=t.id;let r="text-[var(--ui-accent-secondary)]",s="";return t.alignment==="good"?(r="text-green-400",s="border-l-2 border-green-400"):t.alignment==="bad"?(r="text-red-400",s="border-l-2 border-red-400"):t.alignment==="neutral"&&(r="text-gray-400",s="border-l-2 border-gray-400"),e.className=`bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors ${s}`,e.innerHTML=`
        <div class="flex justify-between items-baseline mb-1">
            <span class="font-semibold ${r} text-sm">${t.name}</span>
            ${t.duration?`<span class="text-xs text-[var(--text-color-secondary)]">${t.duration}</span>`:""}
        </div>
        <div class="text-xs text-[var(--text-color-secondary)]">
            ${t.target} ${t.operation} ${t.value}
        </div>
        ${t.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${t.description}</p>`:""}
    `,e.addEventListener("dragstart",ne),e.addEventListener("dragend",ae),e.addEventListener("dragover",ie),e.addEventListener("drop",le),e},ne=t=>{T=t.target.closest('[draggable="true"]'),T&&(T.style.opacity="0.5",T.classList.add("border","border-stone-500"),t.dataTransfer.effectAllowed="move")},ae=t=>{if(T){T.style.opacity="1",T.classList.remove("border","border-stone-500");let o=T.parentNode;if(o){let e=o.getAttribute("data-list-type");vt(o,e)}}},ie=t=>{t.preventDefault(),t.dataTransfer.dropEffect="move";let o=t.target.closest('[draggable="true"]');if(o&&o!==T&&o.parentNode===T.parentNode){let e=o.getBoundingClientRect(),r=e.top+e.height/2;t.clientY<r?o.parentNode.insertBefore(T,o):o.parentNode.insertBefore(T,o.nextSibling)}},le=t=>{t.preventDefault(),t.stopPropagation()},vt=(t,o)=>{if(!t||!o)return;let r=Array.from(t.children).map(s=>o==="resource"?s.dataset.resourceId:o==="asset"?s.dataset.assetId||s.textContent.trim():o==="modifier"?s.dataset.modifierId:o==="codex"?s.dataset.entityId:null).filter(s=>s!==null);o==="resource"?(Me(r),console.log("Resource order saved:",r)):o==="asset"?(Oe(r),console.log("Asset order saved:",r)):o==="modifier"&&(He(r),console.log("Modifier order saved:",r))},Je=(t,o,e="id")=>{if(!o||o.length===0)return t;let r=new Map(t.map(p=>[p[e],p])),s=[],i=[];return o.forEach(p=>{let c=r.get(p);c&&(s.push(c),r.delete(p))}),r.forEach(p=>i.push(p)),[...s,...i]},ve=t=>{let o=document.getElementById("header-container");if(!o)return;let e=t.title||"\uC81C 1\uC7A5: \uADF8\uB9BC\uC790\uC758 \uAE38";o.innerHTML=`
        <div class="flex justify-between items-center">
            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
            <h1 class="text-2xl font-bold text-[var(--text-color-primary)] text-center cursor-pointer" id="header-title">${e}</h1>
            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
        </div>
        <div class="text-center text-sm text-[var(--text-color-secondary)] mt-2">
            <span>${t.hud?.location||"\uC54C \uC218 \uC5C6\uB294 \uC7A5\uC18C"}</span>
            <span class="mx-2">\xB7</span>
            <span>${t.hud?.date||""}</span>
            <span class="mx-2">\xB7</span>
            <span>${t.hud?.time||""}</span>
        </div>
    `,document.getElementById("header-title").addEventListener("click",De)};var be=t=>{let o=document.getElementById("info-panel-container");if(!o||!t.scene_elements||t.scene_elements.length===0)return;o.innerHTML="";let e=t.page_number||0,r=n("div","relative w-full transition-all duration-300 ease-in-out cursor-pointer rounded-lg hover:bg-[var(--bg-panel)]");D&&r.classList.add("is-expanded","bg-[var(--bg-panel)]");let s=n("div","h-24"),i=n("div","relative w-full h-full flex items-center"),p=n("div","absolute left-[5%] top-1/2 w-[90%] h-0.5 bg-[var(--info-panel-line-color)]");i.appendChild(p);let c=[...t.scene_elements].sort((l,h)=>l.distance-h.distance),m=Math.max(...t.scene_elements.map(l=>Math.abs(l.distance)),5),g=[],f=!1;c.forEach((l,h)=>{let u=Math.max(-m,Math.min(m,l.distance)),a=c.filter(k=>k.distance===l.distance),d=a.findIndex(k=>k.name===l.name),v=a.length,x=2,I=-((v-1)*x)/2,S=50+u/m*45+I+d*x,C=n("div","absolute top-1/2");C.style.left=`${S}%`,C.style.transform="translate(-50%, -50%)";let L=n("div","w-3 h-3 rounded-full border-2 transition-all duration-200 ease-in-out relative flex items-center justify-center"),O,U;if(l.type==="player"){let k="var(--player-color)";L.classList.add(`border-[${k}]`,`bg-[${k}]`),U="text-black",O=k}else{let k,ce;l.type==="ally"?(k="var(--ally-color-border)",ce="var(--ally-color-fill)"):l.type==="enemy"?(k="var(--enemy-color-border)",ce="var(--enemy-color-fill)"):(k="var(--object-color-border)",ce="var(--object-color-fill)"),L.classList.add(`border-[${k}]`,`bg-[${ce}]`),U="text-white",O=k}r.classList.contains("is-expanded")&&(L.classList.remove("w-3","h-3"),L.classList.add("w-5","h-5"));let _=n("div","absolute bottom-full mb-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap");_.style.left="50%",_.style.transform="translateX(-50%)",_.style.color=O,_.style.fontSize="16px",_.style.fontWeight="bold",_.textContent=l.name,l.type==="player"&&e===1?_.style.opacity="1":_.style.opacity="0",L.appendChild(_);let E=null;l.type==="player"&&l.status&&(E=n("div","absolute top-full mt-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap text-xs text-[var(--text-color-secondary)]"),E.style.left="50%",E.style.transform="translateX(-50%)",E.textContent=l.status,e===1?E.style.opacity="1":E.style.opacity="0",L.appendChild(E));let $e=String.fromCharCode(65+h),q=n("span",`relative text-xs font-bold ${U} opacity-0 transition-opacity duration-200`);q.textContent=$e,r.classList.contains("is-expanded")&&(q.style.opacity="1"),L.appendChild(q),g.push({dot:L,indexSpan:q,elementWrapper:C,nameTooltip:_,statusTooltip:E,element:l}),C.addEventListener("mouseenter",()=>{r.classList.contains("is-expanded")||(_.style.opacity="1",E&&e===1&&(E.style.opacity="1"))}),C.addEventListener("mouseleave",()=>{l.type==="player"&&e===1&&!f?(_.style.opacity="1",E&&(E.style.opacity="1")):(_.style.opacity="0",E&&(E.style.opacity="0"))}),C.appendChild(L),i.appendChild(C)}),r.addEventListener("mouseenter",()=>{f=!0,e===1&&g.forEach(({nameTooltip:l,statusTooltip:h,element:u})=>{u.type==="player"&&(l.style.opacity="0",h&&(h.style.opacity="0"))})}),r.addEventListener("mouseleave",()=>{f=!1,e===1&&!r.classList.contains("is-expanded")&&g.forEach(({nameTooltip:l,statusTooltip:h,element:u})=>{u.type==="player"&&(l.style.opacity="1",h&&(h.style.opacity="1"))})}),s.appendChild(i),r.appendChild(s);let b=n("div","max-h-0 overflow-hidden transition-all duration-300 ease-in-out relative"),w=n("ul","space-y-3 px-[5%] pb-12 opacity-0 transition-opacity duration-300");c.forEach((l,h)=>{let u=n("li","text-[var(--text-color-primary)]"),a;l.type==="player"?a="text-[var(--player-color)]":l.type==="ally"?a="text-[var(--ally-color-border)]":l.type==="enemy"?a="text-[var(--enemy-color-border)]":l.type==="object"&&(a="text-[var(--object-color-border)]");let d=String.fromCharCode(65+h);u.innerHTML=`<strong class="font-bold ${a}">${d}. ${l.name}:</strong> <span class="text-[var(--text-color-secondary)]">${l.status}</span>`,w.appendChild(u)}),b.appendChild(w),r.appendChild(b),r.classList.contains("is-expanded")&&(b.style.maxHeight=b.scrollHeight+"px",setTimeout(()=>{w.classList.add("opacity-100")},50),i.style.pointerEvents="none"),r.addEventListener("click",l=>{if(l.target.closest(".pointer-events-auto"))return;let h=r.classList.contains("is-expanded");if(D&&h)return;r.classList.toggle("is-expanded")?(r.classList.add("bg-[var(--bg-panel)]"),b.style.maxHeight=b.scrollHeight+"px",setTimeout(()=>{w.classList.add("opacity-100")},50),i.style.pointerEvents="none",g.forEach(({dot:a,indexSpan:d})=>{a.classList.remove("w-3","h-3"),a.classList.add("w-5","h-5"),d.style.opacity="1"})):(r.classList.remove("bg-[var(--bg-panel)]"),w.classList.remove("opacity-100"),b.style.maxHeight="0px",i.style.pointerEvents="auto",g.forEach(({dot:a,indexSpan:d})=>{a.classList.remove("w-5","h-5"),a.classList.add("w-3","h-3"),d.style.opacity="0"}))}),o.appendChild(r)},ye=t=>{let o=document.getElementById("choices-container");if(!o||!t.choices||t.choices.length===0)return;o.innerHTML="";let e=n("div","w-full pt-4");t.choices.forEach((r,s)=>{let i=n("div","w-full text-left py-2 text-[var(--text-color-primary)] text-lg"),p=Ke(r);i.innerHTML=`<span class="font-bold text-[var(--text-accent-bold)]">${s+1}.</span> ${p}`,e.appendChild(i)}),o.appendChild(e)},we=t=>{let o=document.getElementById("content-container");if(o){if(o.innerHTML="",t.story_html){let e=n("div","space-y-4");e.innerHTML=t.story_html,o.appendChild(e)}else if(t.main_content&&t.main_content.length>0){let e=n("div","space-y-4");t.main_content.forEach(r=>{let s=n("p");r.id==="narration"?(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.textContent=r.content):r.id==="thought"?(s.className="text-[var(--text-accent-bold)] leading-loose text-lg pl-4 border-l-2 border-[var(--ui-accent-secondary)]",s.textContent=r.content):r.id==="document"?(s.className="text-[var(--text-color-primary)] leading-relaxed text-base bg-[var(--bg-panel)]/50 p-4 rounded border border-[var(--border-color)]",s.textContent=r.content):r.id==="system"?(s.className="text-[var(--text-color-secondary)] text-sm text-center",s.textContent=r.content):r.id==="quote"?(s.className="text-[var(--text-accent-aux)] leading-relaxed text-lg pl-6 border-l-4 border-[var(--text-accent-aux)] italic",s.textContent=r.content):(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.innerHTML=`<span class="font-bold text-[var(--text-accent-italic)]">${r.id}:</span> ${r.content}`),e.appendChild(s)}),o.appendChild(e)}}},Ce=t=>{let o=!0,e=null,r=0,s=0,i="",p=document.getElementById("hud-container");if(!p)return;p.innerHTML="";let c=n("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(t.resources&&t.resources.length>0){let u=t.resources.filter(x=>x.max!==null&&x.max!==void 0),a=t.resources.filter(x=>x.max===null||x.max===void 0),d=[...u,...a];d=Je(d,pe,"id");let v=n("ul","space-y-2 resource-list");v.setAttribute("data-list-type","resource"),d.forEach((x,y)=>{let I=xt(x,y);v.appendChild(I)}),c.appendChild(v)}else{let u=n("p","text-sm text-[var(--text-color-secondary)] italic");u.textContent="\uC790\uC6D0 \uC815\uBCF4\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4",c.appendChild(u)}if(t.modifiers&&t.modifiers.length>0){let u=n("div","mt-4 pt-3 border-t border-[var(--border-color)]"),a=n("ul","space-y-2 modifier-list");a.setAttribute("data-list-type","modifier"),Je(t.modifiers,fe,"id").forEach((v,x)=>{let y=ht(v,x);a.appendChild(y)}),u.appendChild(a),c.appendChild(u)}let m=n("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(t.asset&&t.asset.length>0){let u=t.asset.reduce((a,d)=>{let v=d.category||"\uAE30\uD0C0";return a[v]||(a[v]=[]),a[v].push(d),a},{});for(let a in u){let d=n("div","mb-4 last:mb-0");d.setAttribute("draggable","true"),d.dataset.categoryName=a,d.addEventListener("dragstart",ne),d.addEventListener("dragend",ae),d.addEventListener("dragover",ie),d.addEventListener("drop",le);let v=X[a]!==!1,x=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");x.innerHTML=`
                            <span class="font-bold text-[var(--ui-accent-primary)] text-lg">${a}</span>
                            <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${v?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        `,d.appendChild(x);let y=n("div","overflow-hidden transition-all duration-300 ease-in-out");v?y.style.maxHeight=y.scrollHeight+"px":y.style.maxHeight="0px";let I=n("ul","space-y-2 mt-2 asset-list");I.setAttribute("data-list-type","asset"),Je(u[a],ue,"id").forEach((S,C)=>{let L=mt(S,C);I.appendChild(L)}),y.appendChild(I),d.appendChild(y),m.appendChild(d),x.addEventListener("click",()=>{let S=x.querySelector("svg");y.style.maxHeight==="0px"||y.style.maxHeight===""?(y.style.maxHeight=y.scrollHeight+"px",S.classList.remove("rotate-180"),X[a]=!0):(y.style.maxHeight="0px",S.classList.add("rotate-180"),X[a]=!1)})}}else{let u=n("p","text-sm text-[var(--text-color-secondary)] italic");u.textContent="Asset\uC774 \uC5C6\uC2B5\uB2C8\uB2E4",m.appendChild(u)}let g=n("div","hidden sm:block bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]"),f=[];if(t.codex_new&&t.codex_new.length>0&&f.push(...t.codex_new),t.codex_update&&t.codex_update.length>0&&f.push(...t.codex_update),f.length>0){let u=f.reduce((a,d)=>{let v="General";return d.data&&d.data.length>0&&d.data[0].category?v=d.data[0].category:d.id==="player_001"&&(v="Player"),a[v]||(a[v]=[]),a[v].push(d),a},{});for(let a in u){let d=n("div","mb-4 last:mb-0"),v=R[a]!==!1,x=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");x.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${a}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${v?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,d.appendChild(x);let y=n("div","overflow-hidden transition-all duration-300 ease-in-out");v?y.style.maxHeight=y.scrollHeight+"px":y.style.maxHeight="0px";let I=n("ul","space-y-2 mt-2 codex-list");I.setAttribute("data-list-type","codex"),u[a].forEach(($,S)=>{let C=!($.id==="player_001"&&!f.some(O=>O.id==="player_002")),L=ze($,C);I.appendChild(L)}),y.appendChild(I),d.appendChild(y),g.appendChild(d),x.addEventListener("click",()=>{let $=x.querySelector("svg");y.style.maxHeight==="0px"||y.style.maxHeight===""?(y.style.maxHeight=y.scrollHeight+"px",$.classList.remove("rotate-180"),R[a]=!0):(y.style.maxHeight="0px",$.classList.add("rotate-180"),R[a]=!1)})}}let b=[c,m,g],w=[];b.forEach(u=>{u.classList.add("flex","flex-col");let a=n("div","mt-4 w-full flex items-end");a.setAttribute("data-tip-spacer","true"),a.style.transition="height 300ms ease-out",a.style.willChange="height",u.appendChild(a),w.push(a),p.appendChild(u)});let l=()=>{requestAnimationFrame(()=>{let d=b,v=d.map($=>{let S=$.querySelector('[data-tip-spacer="true"]'),C=S?S.style.display:"";S&&(S.style.display="none");let L=$.offsetHeight;return S&&(S.style.display=C),L});if(v.length===0)return;let x=Math.max(...v);if(d.forEach(($,S)=>{let C=v[S],L=x-C,O=$.querySelector('[data-tip-spacer="true"]');O&&(O.style.height=`${Math.max(0,L)}px`)}),clearTimeout(e),x<1e3){d.forEach($=>{let S=$.querySelector('[data-tip-spacer="true"]');S&&(S.innerHTML="")});return}let y=[];d.forEach(($,S)=>{x-v[S]>50&&y.push({panel:$,index:S})});let I=y.length>0?y[y.length-1]:null;if(d.forEach(($,S)=>{if(!I||S!==I.index){let C=$.querySelector('[data-tip-spacer="true"]');C&&(C.innerHTML="")}}),!o&&I){let $=Date.now();if($<s)return;let S=I.panel.querySelector('[data-tip-spacer="true"]');($-r>1e4||i==="")&&(r=$,i=ge[Math.floor(Math.random()*ge.length)]);let C=S.querySelector("p");C||(C=document.createElement("p"),C.className="p-4 text-sm text-[var(--text-color-secondary)] italic transition-opacity duration-300 opacity-0",S.appendChild(C)),C.textContent=i,requestAnimationFrame(()=>C.classList.remove("opacity-0")),e=setTimeout(()=>{C.classList.add("opacity-0"),s=Date.now()+1e4,setTimeout(()=>{C.parentNode&&C.parentNode.removeChild(C)},300)},5e3)}})},h=new ResizeObserver(l);b.forEach(u=>{h.observe(u)}),setTimeout(()=>{l(),o=!1},150)},Se=()=>{let t=document.getElementById("app-root");t.innerHTML="";let o=n("div","max-w-5xl mx-auto p-4 sm:p-6"),e=n("div","mb-8");e.id="header-container";let r=n("div","my-8");r.id="content-container";let s=n("div","my-1");s.id="info-panel-container";let i=n("div");i.id="choices-container";let p=n("div","relative mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 items-start");p.id="hud-container";let c=n("div","flex justify-end gap-2 mt-2");c.id="hud-controls-container";let m=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");m.id="image-button",m.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',m.addEventListener("click",Ge);let g=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");g.id="page-button",g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',g.addEventListener("click",De);let f=n("button","sm:hidden p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");f.id="codex-button",f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>';let b=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");b.id="pin-infopanel-button",b.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',b.addEventListener("click",()=>{ke(!D),b.classList.toggle("bg-[var(--ui-accent-primary)]",D);let h=document.querySelector("#info-panel-container > div");if(h){let u=h.classList.contains("is-expanded");(D&&!u||!D&&u)&&h.click()}});let w=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");w.id="settings-button",w.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67c-.2.2-.3.3-.3.3s-.2.1-.3.1c-.2.1-.4.1-.6.1-.2 0-.4 0-.6-.1a1.65 1.65 0 0 0-1.67-.3c-.2-.2-.3-.3-.3-.3s-.1-.2-.1-.3c-.1-.2-.1-.4-.1-.6 0-.2 0-.4.1-.6a1.65 1.65 0 0 0 .3-1.67c.2-.2.3-.3.3-.3s-.2-.1.3-.1c.2-.1.4-.1.6-.1.2 0 .4 0 .6.1a1.65 1.65 0 0 0 1.67.3c.2.2.3.3.3.3s.1.2.1.3c.1.2.1.4.1.6 0 .2 0 .4-.1.6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';let l=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors border border-[var(--border-color)]");l.id="debug-button",l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="6" width="8" height="1"></rect><rect x="8" y="11" width="8" height="1"></rect><rect x="8" y="16" width="8" height="1"></rect><path d="M12 3v3"></path><path d="M12 18v3"></path><path d="M4 9h2"></path><path d="M18 9h2"></path><path d="M4 15h2"></path><path d="M18 15h2"></path><circle cx="12" cy="12" r="9"></circle></svg>',l.title="Debug Data Browser",c.appendChild(m),c.appendChild(g),c.appendChild(f),c.appendChild(b),c.appendChild(w),c.appendChild(l),o.append(e,r,s,i,c,p),t.appendChild(o)};N();import{initializeApp as bt}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";var Ze=async()=>{try{await Ae(bt);let t=V(),o=t.sessionId,e={resources:[],asset:[],modifiers:[],codex_new:[],codex_update:[]};e=await je(M,A,o),t.resources=B(e.resources,t.resources,"id"),t.asset=B(e.asset,t.asset,"id"),t.modifiers=B(e.modifiers,t.modifiers,"id"),t.codex_new=B(e.entities,t.codex_new,"id"),t.codex_update&&t.codex_update.length>0&&(t.codex_new=B(t.codex_new,t.codex_update,"id"),t.codex_update=[]);let s=Pe()[0]||"modern";Y&&Q.includes(Y)&&(s=Y),Z(s),await Re(M,A,t),await Ne(M,A,t),Se(),ve(t),we(t),be(t),ye(t),Ce(t);let i=document.getElementById("codex-button");i&&i.addEventListener("click",Xe);let p=document.getElementById("settings-button");p&&p.addEventListener("click",Ye);let c=document.getElementById("debug-button");c&&c.addEventListener("click",Qe),console.log("Application initialized successfully")}catch(t){console.error("Initialization Error:",t),document.body.innerHTML=`<div class="text-red-400 p-8">Error: ${t.message}</div>`}};document.addEventListener("DOMContentLoaded",async()=>{await Ze()});
//# sourceMappingURL=bundle.min.js.map

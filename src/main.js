var Rt=Object.defineProperty;var ct=(e,r)=>()=>(e&&(r=e(e=0)),r);var dt=(e,r)=>{for(var t in r)Rt(e,t,{get:r[t],enumerable:!0})};var X={};dt(X,{DEFAULT_OFFLINE_USER_ID:()=>ne,applyTheme:()=>he,assetCategoryStates:()=>Ie,assetOrder:()=>te,auth:()=>U,codexCategoryStates:()=>W,codexOrder:()=>G,controlTips:()=>$e,currentApiMode:()=>Z,currentThemeName:()=>ue,currentUserId:()=>O,db:()=>E,isAuthReady:()=>gt,isImageDebugMode:()=>me,isInfoPanelPinned:()=>A,loadUiState:()=>Be,modifierOrder:()=>oe,parseAvailableThemes:()=>We,quotaExceededOnFree:()=>Se,quotaExceededOnPaid:()=>pt,resourceOrder:()=>ee,saveAssetCategoryState:()=>Gt,saveAssetOrder:()=>ze,saveCodexCategoryState:()=>Qt,saveCodexOrder:()=>Ve,saveModifierOrder:()=>Ke,saveResourceOrder:()=>qe,saveUiState:()=>J,sessionId:()=>pe,setAuth:()=>Fe,setCurrentApiMode:()=>ge,setCurrentThemeName:()=>ut,setCurrentUserId:()=>Je,setDb:()=>Ue,setIsAuthReady:()=>Q,setIsImageDebugMode:()=>Wt,setIsInfoPanelPinned:()=>je,setQuotaExceededOnFree:()=>De,setQuotaExceededOnPaid:()=>He,setSessionId:()=>Re,themeNames:()=>fe,userPreferredTheme:()=>zt});import{doc as jt,getDoc as qt}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";var Z,Se,pt,ge,De,He,U,E,gt,O,pe,ne,Ie,W,A,me,ue,zt,ee,te,oe,G,$e,fe,Kt,mt,J,Vt,Be,Fe,Ue,Q,Je,Re,Wt,je,ut,Gt,Qt,qe,ze,Ke,Ve,he,We,T=ct(()=>{Z="free",Se=!1,pt=!1,ge=e=>{Z=e},De=e=>{Se=e},He=e=>{pt=e},U=null,E=null,gt=!1,O=null,pe=null,ne="offline-user",Ie={},W={},A=!1,me=!0,ue="default",zt=localStorage.getItem("userPreferredTheme")||null,ee=JSON.parse(localStorage.getItem("resourceOrder")||"[]"),te=JSON.parse(localStorage.getItem("assetOrder")||"[]"),oe=JSON.parse(localStorage.getItem("modifierOrder")||"[]"),G=JSON.parse(localStorage.getItem("codexOrder")||"[]"),$e=["\uC120\uD0DD\uC9C0 \uC704\uC5D0 \uC788\uB294 \uAC00\uB85C\uC904\uACFC \uC810\uB4E4\uC740 \uC778\uD3EC\uD328\uB110\uC785\uB2C8\uB2E4. \uD55C\uBC88 \uB20C\uB7EC\uBCF4\uC138\uC694.","\uC120\uD0DD\uC9C0 \uC6B0\uCE21 \uD558\uB2E8\uC5D0 \uC704\uCE58\uD55C \uC544\uC774\uCF58\uC744 \uB20C\uB7EC\uD574\uBCF4\uC138\uC694.","\uB4DC\uB798\uADF8 \uC564 \uB4DC\uB86D\uC73C\uB85C \uBAA9\uB85D\uC758 \uC704\uCE58\uB97C \uBC14\uAFD4\uBCF4\uC138\uC694.","\uD398\uC774\uC9C0 \uC81C\uBAA9\uC744 \uD074\uB9AD\uD558\uBA74 \uD398\uC774\uC9C0 \uBAA9\uB85D\uC774 \uB098\uC635\uB2C8\uB2E4.","\uD398\uC774\uC9C0 \uC591 \uC606\uC758 \uD654\uC0B4\uD45C\uB85C \uD398\uC774\uC9C0\uB97C \uC774\uB3D9\uD560 \uC218 \uC788\uC5B4\uC694.","\uC120\uD0DD\uC9C0 \uC544\uB798\uC5D0 \uC788\uB294 \uC774\uBBF8\uC9C0 \uC544\uC774\uCF58\uC744 \uD074\uB9AD\uD558\uBA74 \uD574\uB2F9 \uC7A5\uBA74\uC5D0 \uB9DE\uB294 \uC774\uBBF8\uC9C0\uB97C \uC0DD\uC131\uD560 \uC218 \uC788\uC5B4\uC694."],fe=["fantasy","stone-cyan-dark","cyberpunk","horror","modern","cyberpunk-dark","material-dark","material-light"],Kt=()=>!E||!O||!pe?null:jt(E,`artifacts/${pe}/users/${O}/ui_state/main`),mt=e=>{localStorage.setItem("resourceOrder",JSON.stringify(e.resourceOrder)),localStorage.setItem("assetOrder",JSON.stringify(e.assetOrder)),localStorage.setItem("modifierOrder",JSON.stringify(e.modifierOrder)),localStorage.setItem("assetCategoryStates",JSON.stringify(e.assetCategoryStates)),localStorage.setItem("codexCategoryStates",JSON.stringify(e.codexCategoryStates)),localStorage.setItem("isInfoPanelPinned",JSON.stringify(e.isInfoPanelPinned)),localStorage.setItem("isImageDebugMode",JSON.stringify(e.isImageDebugMode)),e.userPreferredTheme&&localStorage.setItem("userPreferredTheme",e.userPreferredTheme),console.log("UI state saved to localStorage.")},J=async()=>{let e={resourceOrder:ee,assetOrder:te,modifierOrder:oe,codexOrder:G,assetCategoryStates:Ie,codexCategoryStates:W,isInfoPanelPinned:A,isImageDebugMode:me,userPreferredTheme:localStorage.getItem("userPreferredTheme")||ue};mt(e)},Vt=()=>{ee=JSON.parse(localStorage.getItem("resourceOrder")||"[]"),te=JSON.parse(localStorage.getItem("assetOrder")||"[]"),oe=JSON.parse(localStorage.getItem("modifierOrder")||"[]"),G=JSON.parse(localStorage.getItem("codexOrder")||"[]"),Ie=JSON.parse(localStorage.getItem("assetCategoryStates")||"{}"),W=JSON.parse(localStorage.getItem("codexCategoryStates")||"{}"),A=JSON.parse(localStorage.getItem("isInfoPanelPinned")||"false"),me=JSON.parse(localStorage.getItem("isImageDebugMode"))??!0,console.log("UI state loaded from localStorage.")},Be=async()=>{if(Vt(),JSON.parse(localStorage.getItem("resourceOrder")||"[]").length===0&&E&&O&&pe){console.log("Local UI state is empty, attempting to fetch from Firebase...");let r=Kt();if(r){let t=await qt(r);if(t.exists()){let o=t.data();console.log("Successfully fetched UI state from Firebase. Applying and saving locally."),ee=o.resourceOrder||[],te=o.assetOrder||[],oe=o.modifierOrder||[],G=o.codexOrder||[],Ie=o.assetCategoryStates||{},W=o.codexCategoryStates||{},A=o.isInfoPanelPinned||!1,me=o.isImageDebugMode??!0,o.userPreferredTheme&&localStorage.setItem("userPreferredTheme",o.userPreferredTheme),mt(o)}else console.log("No UI state document found in Firebase for this session.")}}},Fe=e=>{U=e},Ue=e=>{E=e},Q=e=>{gt=e},Je=e=>{O=e},Re=e=>{pe=e},Wt=async e=>{me=e,await J()},je=async e=>{A=e,await J()},ut=async e=>{ue=e,localStorage.setItem("userPreferredTheme",e),await J()},Gt=async()=>{await J()},Qt=async()=>{await J()},qe=async e=>{ee=e,await J()},ze=async e=>{te=e,await J()},Ke=async e=>{oe=e,await J()},Ve=async e=>{G=e,await J()},he=async e=>{document.body.className=document.body.className.split(" ").filter(r=>!r.startsWith("theme-")).join(" "),document.body.classList.add(`theme-${e}`),await ut(e),console.log(`Applied theme: ${e}`)},We=()=>{let e=document.getElementById("available-themes");return e&&e.textContent.trim()?e.textContent.trim().split(";").map(r=>r.trim()):["modern","material-dark","material-light","cyberpunk-dark"]}});var _t={};dt(_t,{getApiKey:()=>et,saveApiKey:()=>mo});var et,mo,tt=ct(()=>{et=()=>localStorage.getItem("geminiApiKey")||"",mo=e=>{localStorage.setItem("geminiApiKey",e)}});T();import{getAuth as so,signInWithCustomToken as no,onAuthStateChanged as ao}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore as io,collection as Ye,doc as z,getDoc as Le,setDoc as ae,serverTimestamp as Pe,getDocs as lo,query as co,deleteDoc as Po}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";var Xt=()=>{let e={};return document.querySelectorAll('script[type="text/html"]').forEach(r=>{let t=r.getAttribute("data-id"),o=r.getAttribute("data-category");t&&(e[t]={category:o||"unknown",content:r.innerHTML.trim()})}),e},Yt=e=>{if(!e)return"";let r=e;return r=r.replace(/^### (.+)$/gm,'<h3 class="text-xl font-bold text-[var(--text-color-primary)] mt-4 mb-2">$1</h3>'),r=r.replace(/^## (.+)$/gm,'<h2 class="text-2xl font-bold text-[var(--text-color-primary)] mt-6 mb-3">$1</h2>'),r=r.replace(/^# (.+)$/gm,'<h1 class="text-3xl font-bold text-[var(--text-color-primary)] mt-8 mb-4">$1</h1>'),r=r.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),r=r.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),r=r.replace(/\n\n/g,'</p><p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'),r='<p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'+r+"</p>",r},ft=e=>{if(!e)return"";let r=e;return r=r.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),r},Zt=()=>{let e=document.getElementById("image");return e?e.textContent.trim():null},eo=()=>{let e=document.getElementById("header");if(!e)return{title:"",location:"",date:"",time:""};let t=e.textContent.trim().split(";").map(o=>o.trim());return{title:t[0]||"",location:t[1]||"",date:t[2]||"",time:t[3]||""}},to=()=>{let e=document.getElementById("story");return e?Yt(e.textContent.trim()):""},oo=()=>{let e=document.getElementById("choices");return e?e.textContent.trim().split(`
`).map(o=>o.trim()).filter(o=>o).map(o=>o.replace(/^\d+\.\s*/,"").trim()):[]},ro=()=>{let e=document.getElementById("scene-data");return e?e.textContent.trim().split(`
`).map(o=>o.trim()).filter(o=>o).map(o=>{let s=o.split(";").map(i=>i.trim());return{type:s[1]||"",name:s[2]||"",distance:s[3]?Number(s[3]):0,condition:s[4]||""}}).filter(o=>o.type):[]};var Ge=e=>{let r=document.querySelectorAll('script[id="codex"]'),t=null;r.forEach(f=>{f.getAttribute("data-type")===e&&(t=f)});let o={entities:[],resources:[],assets:[],modifiers:[],removed:{entities:[],resources:[],assets:[],modifiers:[]}};if(!t)return o;let i=t.textContent.trim().split(`
`).map(f=>f.trim()).filter(f=>f),g={},c={},m={},d={};return i.forEach(f=>{let x=f.indexOf(";");if(x===-1)return;let C=f.substring(0,x).trim(),h=f.substring(x+1).trim(),p=C.split("."),v=p[0],n=p[1],l=p.slice(2);if(e==="remove"){v==="entity"?o.removed.entities.push(n):v==="resource"?o.removed.resources.push(n):v==="asset"&&o.removed.assets.push(n);return}if(v==="entity"){g[n]||(g[n]={id:n,classifications:{}});let y=g[n];if(l.length===1){let u=l[0];u==="friendliness"||u==="familiarity"||u==="relevance"?y[u]=Number(h):y[u]=h}else if(l[0]==="classifications"&&l.length===2){let u=l[1],b=h.indexOf(":");if(b>-1){let w=h.substring(0,b).trim(),S=h.substring(b+1).trim();y.classifications[u]={label:w,value:S}}else y.classifications[u]={label:u,value:h}}}else if(v==="resource"){c[n]||(c[n]={id:n});let y=c[n],u=l[0];u==="current"||u==="max"?y[u]=h==="NULL"?null:Number(h):y[u]=h}else if(v==="asset"){m[n]||(m[n]={id:n,properties:{}});let y=m[n];if(l.length===1){let u=l[0];u==="condition"||u==="grade"||u==="burden"||u==="quantity"||u==="quality"||u==="weight"||u==="threat"?y[u]=Number(h):y[u]=h}else if(l[0]==="properties"&&l.length===2){let u=l[1],b=h.indexOf(":");if(b>-1){let w=h.substring(0,b).trim(),S=h.substring(b+1).trim();y.properties[u]={label:w,value:S}}else y.properties[u]={label:u,value:h}}}else if(v==="effect"){d[n]||(d[n]={id:n});let y=d[n],u=l[0];y[u]=h}}),o.entities=Object.values(g),o.resources=Object.values(c),o.assets=Object.values(m),o.modifiers=Object.values(d),o},Y=()=>{let e=document.getElementById("session-uuid");if(e&&e.textContent.trim()){let t=e.textContent.trim();return console.log(`Session ID loaded from HTML: ${t}`),t}let r=localStorage.getItem("gameSessionId");return r||(r=crypto.randomUUID(),localStorage.setItem("gameSessionId",r),console.warn("New Session ID generated and stored in localStorage.")),r};var re=()=>{let e=eo(),r=to(),t=oo(),o=ro(),s=Ge("new"),i=Ge("update"),g=Ge("remove"),c=s.entities,m=i.entities,d=[...s.resources,...i.resources],f=[...s.assets,...i.assets],x=[...s.modifiers,...i.modifiers],C=g.removed,h=document.querySelector("title"),p=h?parseInt(h.textContent.match(/\d+/)?.[0]||"0"):0,v=Xt(),n=Zt();return{sessionId:Y(),header:e,story_html:r,choices:t,scene_elements:o,codex_new:c,codex_update:m,resources:d,asset:f,modifiers:x,removed:C,html_docs:v,image_prompt:n,page_number:p,define:c,update:m,hud:{location:e.location,date:e.date,time:e.time},title:e.title,character_stats:{resources:d,attributes:{},equipment:{},name:"",level:1},information_panel:[]}};var po=()=>typeof __app_id<"u"?__app_id:"default-app-id";var xt=e=>new Promise(r=>{try{let t=typeof __firebase_config<"u"?JSON.parse(__firebase_config):{},o=typeof __initial_auth_token<"u"?__initial_auth_token:null,s;if(typeof e>"u"&&typeof firebase<"u"&&typeof firebase.initializeApp<"u")e=firebase.initializeApp,console.warn("Using global firebase.initializeApp as passed parameter was undefined.");else if(typeof e>"u"){console.error("initializeApp function not provided. Cannot initialize Firebase."),Q(!1),r();return}if(Object.keys(t).length>0)s=e(t);else if(typeof firebase<"u"&&firebase.apps.length>0)s=firebase.app(),console.log("Firebase app already initialized, using existing app.");else{console.warn("Firebase config not found and no existing app. Running in offline mode."),Q(!1),r();return}Fe(so(s)),Ue(io(s)),ao(U,async i=>{if(i)Je(i.uid),Q(!0),console.log("Firebase authenticated:",i.uid),r();else if(o)try{await no(U,o)}catch(g){console.error("Custom token sign-in failed:",g);try{await signInAnonymously(U)}catch(c){console.error("Anonymous sign-in failed after custom token failure:",c),console.warn("No authentication available, running in offline mode."),Q(!1),r()}}else try{await signInAnonymously(U)}catch(g){console.error("Anonymous sign-in failed:",g),console.warn("No authentication available, running in offline mode."),Q(!1),r()}})}catch(t){console.error("Firebase initialization error:",t),Q(!1),r()}}),K=(e,r,t="name")=>{if(!e||e.length===0)return r;if(!r||r.length===0)return e;let o=new Map;return e.forEach(s=>{s[t]&&o.set(s[t],s)}),r.forEach(s=>{s[t]&&o.set(s[t],{...o.get(s[t]),...s})}),Array.from(o.values())},vt=async(e,r,t)=>{try{let o=Y(),s=t.page_number,i=`snapshot_pages_${o}`,g=JSON.parse(localStorage.getItem(i)||"[]"),c=g.find(y=>y.page_number===s),m=Date.now();if(c){console.log(`Page ${s} snapshot was already saved in this session. Skipping duplicate save.`);return}else g.push({page_number:s,timestamp:m}),localStorage.setItem(i,JSON.stringify(g));let{resourceOrder:d,assetOrder:f,modifierOrder:x,assetCategoryStates:C,codexCategoryStates:h,isInfoPanelPinned:p,currentThemeName:v}=await Promise.resolve().then(()=>(T(),X)),n=`page_snapshot_${o}_${s}`,l={...t,globalStates:{resourceOrder:d,assetOrder:f,modifierOrder:x,assetCategoryStates:C,codexCategoryStates:h,isInfoPanelPinned:p,currentThemeName:v},timestamp:new Date().toISOString()};localStorage.setItem(n,JSON.stringify(l)),console.log(`Page snapshot saved to localStorage: ${n} (Theme: ${v})`)}catch(o){console.error("Error saving page snapshot to localStorage:",o)}},bt=async(e,r,t,o)=>{let s=`page_snapshot_${t}_${o}`,i=null,g=localStorage.getItem(s);return g&&(console.log(`Page snapshot loaded from localStorage: ${s}`),i=JSON.parse(g)),i||console.log(`No snapshot found for page ${o} in localStorage.`),i},yt=async(e,r,t)=>{let o=go(e,t);if(o.resources.length===0&&o.asset.length===0&&o.modifiers.length===0&&o.entities.length===0&&e&&r&&t){console.log("Local persistent codex is empty, attempting to fetch from Firebase...");try{let i={resources:[],asset:[],modifiers:[],entities:[]},g=z(r,`artifacts/${t}/users/${e}/game_state/current_state`),c=await Le(g);if(c.exists()){let x=c.data();i.resources=x.resources||[],i.asset=x.asset||[],i.modifiers=x.modifiers||[]}let m=Ye(r,`artifacts/${t}/users/${e}/codex_entities`),d=co(m),f=await lo(d);if(f.empty||f.forEach(x=>{i.entities.push(x.data())}),i.resources.length>0||i.asset.length>0||i.modifiers.length>0||i.entities.length>0)return console.log("Successfully fetched persistent codex from Firebase. Saving locally."),q(e,"resources",i.resources,t),q(e,"asset",i.asset,t),q(e,"modifiers",i.modifiers,t),q(e,"entities",i.entities,t),i;console.log("No persistent codex found in Firebase.")}catch(i){console.error("Error fetching persistent codex from Firebase:",i)}}return o},go=(e,r)=>{let t={resources:[],asset:[],modifiers:[],entities:[]},o=e||ne;return t.resources=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${o}_resources`)||"[]"),t.asset=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${o}_asset`)||"[]"),t.modifiers=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${o}_modifiers`)||"[]"),t.entities=JSON.parse(localStorage.getItem(`artifacts_${r}_users_${o}_entities`)||"[]"),t},q=(e,r,t,o)=>{let i=`artifacts_${o}_users_${e||ne}_${r}`,g=JSON.parse(localStorage.getItem(i)||"[]"),c=t;g.length>0&&(c=K(g,t,"id")),localStorage.setItem(i,JSON.stringify(c)),console.log(`Data type ${r} for session ${o} saved to localStorage.`)},_e=(e,r,t,o)=>{let i=`artifacts_${o}_users_${e||ne}_${r}`,c=JSON.parse(localStorage.getItem(i)||"[]").filter(m=>m.id!==t);localStorage.setItem(i,JSON.stringify(c)),console.log(`Item ${t} of type ${r} for session ${o} deleted from localStorage.`)},Qe=750*1024,wt=(e,r,t)=>{let o=`page_image_${e}_${r}`;try{localStorage.setItem(o,t),console.log(`Image for page ${r} saved to localStorage.`)}catch(s){console.error(`Error saving image to localStorage for page ${r}:`,s)}},Ct=(e,r)=>{let t=`page_image_${e}_${r}`,o=localStorage.getItem(t);return o?(console.log(`Image for page ${r} loaded from localStorage.`),o):(console.log(`No image found in localStorage for page ${r}.`),null)},St=async(e,r,t,o,s)=>{if(!e||!r||!t||!o||!s){console.warn("Skipping Firebase image save: missing parameters.");return}try{let i=z(r,`artifacts/${t}/users/${e}/pages/${o}/image_data/metadata`),g=s.match(/^data:(.*?);base64,/),c=g?g[1]:"image/jpeg",m=s.split(",")[1],d=Math.ceil(m.length/Qe),f=[];for(let x=0;x<d;x++){let C=x*Qe,h=Math.min((x+1)*Qe,m.length),p=m.substring(C,h),v=z(r,`artifacts/${t}/users/${e}/pages/${o}/image_data/chunks/${x}`);f.push(ae(v,{data:p}))}await Promise.all(f),await ae(i,{totalChunks:d,mimeType:c,updatedAt:Pe()},{merge:!0}),console.log(`Image for page ${o} saved to Firebase in ${d} chunks.`)}catch(i){console.error(`Error saving image to Firebase for page ${o}:`,i)}},It=async(e,r,t,o)=>{if(!e||!r||!t||!o)return console.warn("Skipping Firebase image load: missing parameters."),null;try{let s=z(r,`artifacts/${t}/users/${e}/pages/${o}/image_data/metadata`),i=await Le(s);if(!i.exists())return console.log(`No image metadata found in Firebase for page ${o}.`),null;let g=i.data(),c=g.totalChunks,m=g.mimeType,d=[];for(let h=0;h<c;h++){let p=z(r,`artifacts/${t}/users/${e}/pages/${o}/image_data/chunks/${h}`);d.push(Le(p))}let f=await Promise.all(d),x="";for(let h of f)if(h.exists())x+=h.data().data;else return console.warn(`Missing image chunk ${h.id} for page ${o}.`),null;let C=`data:${m};base64,${x}`;return console.log(`Image for page ${o} loaded from Firebase.`),C}catch(s){return console.error(`Error loading image from Firebase for page ${o}:`,s),null}},Ee=async(e,r,t,o,s)=>{try{let i=po();if(t==="new"||t==="update"){let g=Ye(r,`artifacts/${s}/users/${e}/codex_entities`);for(let c of o)if(c.id){let m=z(g,c.id);await ae(m,{...c,updatedAt:Pe()},{merge:!0})}console.log(`Codex entities (${t}) saved for session ${s}:`,o.length)}else if(t==="resources"||t==="asset"||t==="modifiers"){let g=z(r,`artifacts/${s}/users/${e}/game_state/current_state`),c=await Le(g),m=c.exists()?c.data():{},d=o;m[t]&&(d=K(m[t],o,"id")),await ae(g,{[t]:d,updatedAt:Pe()},{merge:!0}),console.log(`Game state (${t}) saved for session ${s}:`,d.length)}}catch(i){console.error(`Firestore \uC800\uC7A5 \uC2E4\uD328 [${t}] for session ${s}:`,i)}};var $t=async(e,r,t)=>{try{let o=Y(),s=e||ne,i=t.page_number,g=`processed_pages_${o}`,c=JSON.parse(localStorage.getItem(g)||"[]"),m=c.find(p=>p.page_number===i),d=Date.now();if(m){console.log(`Page ${i} was already processed in this session. Skipping duplicate save.`);return}else c.push({page_number:i,timestamp:d}),localStorage.setItem(g,JSON.stringify(c));if(t.codex_new&&t.codex_new.length>0&&q(s,"entities",t.codex_new,o),t.codex_update&&t.codex_update.length>0&&q(s,"entities",t.codex_update,o),t.resources&&t.resources.length>0&&q(s,"resources",t.resources,o),t.asset&&t.asset.length>0&&q(s,"asset",t.asset,o),t.modifiers&&t.modifiers.length>0&&q(s,"modifiers",t.modifiers,o),t.removed){for(let p of t.removed.entities)_e(s,"entities",p,o);for(let p of t.removed.resources)_e(s,"resources",p,o);for(let p of t.removed.assets)_e(s,"asset",p,o);for(let p of t.removed.modifiers)_e(s,"modifiers",p,o)}console.log(`All codex data processed and saved successfully to localStorage for session ${o}.`);let f="saved_pages",x=JSON.parse(localStorage.getItem(f)||"[]"),C={sessionId:o,page_number:t.page_number,title:t.header.title,timestamp:new Date().toISOString()},h=x.findIndex(p=>p.sessionId===o&&p.page_number===t.page_number);h>-1?x[h]=C:x.push(C),localStorage.setItem(f,JSON.stringify(x)),console.log(`Page index entry for page ${t.page_number} in session ${o} saved to localStorage index.`)}catch(o){console.error("Error processing codex data:",o)}},Xe=!1,ht="",Ze=async()=>{if(!(!U||!O||!E))try{let e=Y(),r=O,t={uiState:{resourceOrder:JSON.parse(localStorage.getItem("resourceOrder")||"[]"),assetOrder:JSON.parse(localStorage.getItem("assetOrder")||"[]"),modifierOrder:JSON.parse(localStorage.getItem("modifierOrder")||"[]"),codexOrder:JSON.parse(localStorage.getItem("codexOrder")||"[]"),assetCategoryStates:JSON.parse(localStorage.getItem("assetCategoryStates")||"{}"),codexCategoryStates:JSON.parse(localStorage.getItem("codexCategoryStates")||"{}"),isInfoPanelPinned:JSON.parse(localStorage.getItem("isInfoPanelPinned")||"false"),isImageDebugMode:JSON.parse(localStorage.getItem("isImageDebugMode"))??!0,userPreferredTheme:localStorage.getItem("userPreferredTheme")||"default"},codex:{resources:JSON.parse(localStorage.getItem(`artifacts_${e}_users_${r}_resources`)||"[]"),assets:JSON.parse(localStorage.getItem(`artifacts_${e}_users_${r}_asset`)||"[]"),modifiers:JSON.parse(localStorage.getItem(`artifacts_${e}_users_${r}_modifiers`)||"[]"),entities:JSON.parse(localStorage.getItem(`artifacts_${e}_users_${r}_entities`)||"[]")},pageIndex:JSON.parse(localStorage.getItem("saved_pages")||"[]").filter(d=>d.sessionId===e)},o=JSON.stringify(t);if(o===ht)return;if(Xe){console.log("Sync already in progress. Skipping.");return}Xe=!0,console.log("Data change detected. Starting sync to Firebase...");let{uiState:s,codex:i,pageIndex:g}=t,c=z(E,`artifacts/${e}/users/${r}/ui_state/main`);await ae(c,s,{merge:!0}),i.resources.length>0&&await Ee(r,E,"resources",i.resources,e),i.assets.length>0&&await Ee(r,E,"asset",i.assets,e),i.modifiers.length>0&&await Ee(r,E,"modifiers",i.modifiers,e),i.entities.length>0&&await Ee(r,E,"new",i.entities,e);let m=Ye(E,`artifacts/${e}/users/${r}/page_index`);for(let d of g){let f=`${e}_${d.page_number}`,x=z(m,f);await ae(x,{...d,timestamp:Pe()},{merge:!0})}console.log("Firebase sync completed successfully."),ht=o}catch(e){console.error("Error during Firebase sync:",e)}finally{Xe=!1}};T();T();var a=(e,r="",t="")=>{let o=document.createElement(e);return r&&(o.className=r),t&&(o.textContent=t),o};function ie(e,r=""){let t=document.getElementById("apiStatus");if(!t){console.warn("API Status element not found. Cannot update API status UI.");return}let o={free:{text:"\uBB34\uB8CC \uC0AC\uC6A9 \uC911",class:"free"},paid:{text:"\uC720\uB8CC API \uC0AC\uC6A9 \uC911",class:"paid"},error:{text:"\uC624\uB958 \uBC1C\uC0DD",class:"error"},stopped:{text:"\uC911\uB2E8\uB428",class:"error"}},s=o[e]||o.free;t.textContent=s.text+(r?` - ${r}`:""),t.className=`api-status ${s.class}`}var Et=()=>{let e=a("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");e.id="active-overlay";let r=a("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),t=a("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),o=a("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","Image");t.appendChild(o);let s=a("button","text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)] transition-colors text-2xl px-2");s.textContent="\xD7",s.onclick=()=>e.remove(),t.appendChild(s),r.appendChild(t);let i=a("div","flex-grow");i.innerHTML="<p>Image content will go here.</p>",r.appendChild(i),e.appendChild(r),document.body.appendChild(e),e.addEventListener("click",g=>{g.target===e&&e.remove()})},xe=async(e,r)=>{let t=await bt(O,E,e,r);if(!t){console.warn(`Could not load snapshot for session ${e}, page ${r}.`);return}console.log(`Loading snapshot: ${e}/page_${r} - complete data restoration`);let{applyTheme:o}=await Promise.resolve().then(()=>(T(),X)),s=t.globalStates?.currentThemeName||t.current_theme;if(s&&(console.log(`Applying theme from snapshot: ${s}`),o(s)),t.globalStates){let{setIsInfoPanelPinned:g,saveResourceOrder:c,saveAssetOrder:m,saveModifierOrder:d}=await Promise.resolve().then(()=>(T(),X));if(t.globalStates.isInfoPanelPinned!==void 0&&g(t.globalStates.isInfoPanelPinned),t.globalStates.resourceOrder&&c(t.globalStates.resourceOrder),t.globalStates.assetOrder&&m(t.globalStates.assetOrder),t.globalStates.modifierOrder&&d(t.globalStates.modifierOrder),t.globalStates.assetCategoryStates){let{assetCategoryStates:f}=await Promise.resolve().then(()=>(T(),X));Object.assign(f,t.globalStates.assetCategoryStates)}if(t.globalStates.codexCategoryStates){let{codexCategoryStates:f}=await Promise.resolve().then(()=>(T(),X));Object.assign(f,t.globalStates.codexCategoryStates)}}let i=document.getElementById("app-root");i.innerHTML="",Oe(),ve(t),ye(t),le(t),be(t),we(t),console.log(`Page snapshot fully restored: ${e}/page_${r} with theme: ${s}`)},ot=async()=>{let{getDocs:e,collection:r,query:t,orderBy:o}=await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"),s=a("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");s.id="active-overlay";let i=a("div","w-full max-w-2xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),g=a("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),c=a("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uD398\uC774\uC9C0 \uBAA9\uB85D");g.appendChild(c);let m=a("button","text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)] transition-colors text-2xl px-2");m.textContent="\xD7",m.onclick=()=>s.remove(),g.appendChild(m),i.appendChild(g);let d=a("div","flex-grow overflow-y-auto"),f=a("p","text-[var(--text-color-secondary)]","\uD398\uC774\uC9C0 \uBAA9\uB85D \uBD88\uB7EC\uC624\uB294 \uC911...");d.appendChild(f),i.appendChild(d),s.appendChild(i),document.body.appendChild(s);let x=re().page_number,C=()=>{let h=document.getElementById("current-page-item");h&&setTimeout(()=>{h.scrollIntoView({block:"center",behavior:"smooth"})},100)};if(U&&E&&O){let h=Y(),p=r(E,`artifacts/${h}/users/${O}/page_index`),v=t(p,o("timestamp","desc")),n=await e(v);if(d.innerHTML="",n.empty)d.innerHTML='<p class="text-[var(--text-color-secondary)]">\uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let l=a("ul","space-y-1");n.forEach(y=>{let u=y.data(),b=a("li");b.className="p-3 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border-b border-[var(--border-color)]/30 flex items-baseline",b.innerHTML=`
                    <span class="font-mono text-sm text-[var(--text-color-secondary)] w-20">Page ${u.page_number}</span>
                    <span class="font-bold text-lg text-[var(--text-color-primary)] ml-4">${u.title||"\uC81C\uBAA9 \uC5C6\uC74C"}</span>
                `,u.page_number===x&&(b.classList.add("bg-[var(--ui-accent-primary)]/20","border-l-4","border-[var(--ui-accent-primary)]"),b.id="current-page-item"),b.addEventListener("click",()=>{xe(u.sessionId,u.page_number),s.remove()}),l.appendChild(b)}),d.appendChild(l),C()}}else{let p=JSON.parse(localStorage.getItem("saved_pages")||"[]").sort((v,n)=>new Date(n.timestamp)-new Date(v.timestamp));if(d.innerHTML="",p.length===0)d.innerHTML='<p class="text-[var(--text-color-secondary)]">\uB85C\uCEEC\uC5D0 \uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let v=a("ul","space-y-1");p.forEach(n=>{let l=a("li");l.className="p-3 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border-b border-[var(--border-color)]/30 flex items-baseline",l.innerHTML=`
                    <span class="font-mono text-sm text-[var(--text-color-secondary)] w-20">Page ${n.page_number}</span>
                    <span class="font-bold text-lg text-[var(--text-color-primary)] ml-4">${n.title||"\uC81C\uBAA9 \uC5C6\uC74C"}</span>
                `,n.page_number===x&&(l.classList.add("bg-[var(--ui-accent-primary)]/20","border-l-4","border-[var(--ui-accent-primary)]"),l.id="current-page-item"),l.addEventListener("click",()=>{xe(n.sessionId,n.page_number),s.remove()}),v.appendChild(l)}),d.appendChild(v),C()}}},Lt=()=>{let e=document.getElementById("active-overlay");e&&e.remove();let r=a("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");r.id="active-overlay";let t=a("div","w-full max-w-md max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),o=a("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=a("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","Codex");o.appendChild(s);let i=a("button","text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)] transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>r.remove(),o.appendChild(i),t.appendChild(o);let g=a("div","flex-grow overflow-y-auto"),c=re(),m=[];if(c.codex_new&&c.codex_new.length>0&&m.push(...c.codex_new),c.codex_update&&c.codex_update.length>0&&m.push(...c.codex_update),m.length>0){let d=m.reduce((f,x)=>{let C="General";return x.data&&x.data.length>0&&x.data[0].category?C=x.data[0].category:x.id==="player_001"&&(C="Player"),f[C]||(f[C]=[]),f[C].push(x),f},{});for(let f in d){let x=a("div","mb-4 last:mb-0"),C=W[f]!==!1,h=a("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");h.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${f}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${C?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,x.appendChild(h);let p=a("div","overflow-hidden transition-all duration-300 ease-in-out");C?p.style.maxHeight=p.scrollHeight+"px":p.style.maxHeight="0px";let v=a("ul","space-y-2 mt-2 codex-list");v.setAttribute("data-list-type","codex"),d[f].forEach((n,l)=>{let y=!(n.id==="player_001"&&!m.some(b=>b.id==="player_002")),u=rt(n,y);v.appendChild(u)}),p.appendChild(v),x.appendChild(p),g.appendChild(x),h.addEventListener("click",()=>{let n=h.querySelector("svg");p.style.maxHeight==="0px"||p.style.maxHeight===""?(p.style.maxHeight=p.scrollHeight+"px",n.classList.remove("rotate-180"),W[f]=!0):(p.style.maxHeight="0px",n.classList.add("rotate-180"),W[f]=!1)})}}else{let d=a("p","text-sm text-[var(--text-color-secondary)] italic");d.textContent="Codex \uBAA9\uB85D\uC774 \uBE44\uC5B4\uC788\uC2B5\uB2C8\uB2E4",g.appendChild(d)}t.appendChild(g),r.appendChild(t),document.body.appendChild(r),r.addEventListener("click",d=>{d.target===r&&r.remove()})},Pt=async()=>{let{saveApiKey:e,getApiKey:r}=await Promise.resolve().then(()=>(tt(),_t)),t=document.getElementById("active-overlay");t&&t.remove();let o=a("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let s=a("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6"),i=a("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),g=a("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uC124\uC815");i.appendChild(g);let c=a("button","text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)] transition-colors text-2xl px-2");c.textContent="\xD7",c.onclick=()=>o.remove(),i.appendChild(c),s.appendChild(i);let m=a("div","mb-6"),d=a("label","block text-sm font-medium text-[var(--text-color-primary)] mb-2","\uD14C\uB9C8 \uC120\uD0DD");m.appendChild(d);let f=a("select","w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-md text-[var(--text-color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--ui-accent-secondary)]");fe.forEach(p=>{let v=a("option","",p);v.value=p,p===ue&&(v.selected=!0),f.appendChild(v)}),f.addEventListener("change",async p=>{await he(p.target.value)}),m.appendChild(f),s.appendChild(m);let x=a("div","mb-4"),C=a("label","block text-sm font-medium text-[var(--text-color-primary)] mb-2","Gemini API Key");x.appendChild(C);let h=a("input");h.type="password",h.id="userApiKeyInput",h.className="w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-md text-[var(--text-color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--ui-accent-secondary)]",h.placeholder="AIzaSy...",h.value=r(),h.addEventListener("change",p=>{e(p.target.value),console.log("Gemini API Key saved.")}),x.appendChild(h),s.appendChild(x),o.appendChild(s),document.body.appendChild(o),o.addEventListener("click",p=>{p.target===o&&o.remove()})};var Ot=async()=>{let e=document.getElementById("active-overlay");e&&e.remove();let r=a("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");r.id="active-overlay";let t=a("div","w-full max-w-6xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl flex flex-col"),o=a("div","flex items-center justify-between border-b border-[var(--border-color)] p-6 pb-3"),s=a("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\u{1F41B} Debug Data Browser");o.appendChild(s);let i=a("button","text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)] transition-colors text-2xl px-2");i.textContent="\xD7",i.onclick=()=>r.remove(),o.appendChild(i),t.appendChild(o);let g=a("div","px-6 pt-4"),c=a("label","flex items-center text-sm font-medium text-[var(--text-color-primary)]"),m=a("input");m.type="checkbox",m.className="mr-2 h-4 w-4 rounded border-gray-300 text-[var(--ui-accent-primary)] focus:ring-[var(--ui-accent-primary)]";let{isImageDebugMode:d,setIsImageDebugMode:f}=await Promise.resolve().then(()=>(T(),X));m.checked=d,m.addEventListener("change",b=>{f(b.target.checked);let w=re();le(w)}),c.appendChild(m),c.appendChild(document.createTextNode("Enable Info Panel Image Mode")),g.appendChild(c),t.appendChild(g);let x=a("div","flex gap-2 px-6 pt-3 border-b border-[var(--border-color)]"),C=["Entities","Resources","Assets","Modifiers","UI State","localStorage","Page History"],h=[];C.forEach((b,w)=>{let S=a("button",`px-4 py-2 rounded-t-md transition-colors ${w===0?"bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]":"text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}`);S.textContent=b,S.dataset.tab=b,h.push(S),x.appendChild(S)}),t.appendChild(x);let p=a("div","flex-grow overflow-y-auto p-6");t.appendChild(p);let v=re(),n=Y(),l=b=>{let w=a("pre","bg-black/30 p-4 rounded-md overflow-x-auto text-xs text-[var(--text-color-primary)] font-mono");return w.textContent=JSON.stringify(b,null,2),w},y=(b,w)=>{let S=a("div","mb-6"),$=a("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3",w);if(S.appendChild($),!b||b.length===0){let j=a("p","text-[var(--text-color-secondary)] italic","\uB370\uC774\uD130 \uC5C6\uC74C");return S.appendChild(j),S}let I=a("table","w-full border-collapse text-sm");I.style.fontSize="12px";let _=a("thead"),N=a("tr","border-b border-[var(--border-color)]"),R=Object.keys(b[0]);R.forEach(j=>{let D=a("th","text-left p-2 text-[var(--text-color-primary)] font-bold",j);N.appendChild(D)}),_.appendChild(N),I.appendChild(_);let ce=a("tbody");return b.forEach((j,D)=>{let M=a("tr","border-b border-[var(--border-color)]/30 hover:bg-[var(--bg-color)] transition-colors");R.forEach(B=>{let V=a("td","p-2 text-[var(--text-color-secondary)]"),P=j[B];typeof P=="object"&&P!==null?V.textContent=JSON.stringify(P):V.textContent=P??"null",M.appendChild(V)}),ce.appendChild(M)}),I.appendChild(ce),S.appendChild(I),S},u=b=>{switch(p.innerHTML="",b){case"Entities":p.appendChild(y(v.codex_new,"New Entities")),p.appendChild(y(v.codex_update,"Updated Entities"));break;case"Resources":p.appendChild(y(v.resources,"Resources"));break;case"Assets":p.appendChild(y(v.asset,"Assets"));break;case"Modifiers":p.appendChild(y(v.modifiers,"Modifiers"));break;case"UI State":let w=a("div");Promise.all([Promise.resolve().then(()=>(T(),X)),import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js")]).then(([{resourceOrder:P,assetOrder:L,modifierOrder:k,assetCategoryStates:se,codexCategoryStates:F,isInfoPanelPinned:de,currentThemeName:Tt,db:nt,currentUserId:at,sessionId:it},{getDoc:Nt,doc:Dt}])=>{let Ht={resourceOrder:P,assetOrder:L,modifierOrder:k,assetCategoryStates:se,codexCategoryStates:F,isInfoPanelPinned:de,currentThemeName:Tt,userPreferredTheme:localStorage.getItem("userPreferredTheme")},Bt=a("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","Current In-Memory UI State");if(w.appendChild(Bt),w.appendChild(l(Ht)),nt&&at&&it){let Ft=Dt(nt,`artifacts/${it}/users/${at}/ui_state/main`);Nt(Ft).then(lt=>{let Ut=a("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mt-6 mb-3","Saved UI State (from Firebase)");if(w.appendChild(Ut),lt.exists())w.appendChild(l(lt.data()));else{let Jt=a("p","text-sm text-[var(--text-color-secondary)] italic","No UI state document found in Firebase for this session.");w.appendChild(Jt)}})}p.appendChild(w)});break;case"localStorage":let S=a("div"),$=a("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","localStorage Keys");S.appendChild($);let I=a("div","space-y-2"),_=Object.keys(localStorage).filter(P=>P.includes(n)||P.includes("processed_pages")||P.includes("snapshot_pages"));if(_.forEach(P=>{let L=a("div","bg-black/20 p-3 rounded-md"),k=a("div","font-bold text-[var(--ui-accent-primary)] mb-2",P);L.appendChild(k);try{let se=localStorage.getItem(P),F=JSON.parse(se);L.appendChild(l(F))}catch{let F=a("pre","text-xs text-[var(--text-color-secondary)]",localStorage.getItem(P));L.appendChild(F)}I.appendChild(L)}),_.length===0){let P=a("p","text-[var(--text-color-secondary)] italic","\uAD00\uB828 localStorage \uD56D\uBAA9 \uC5C6\uC74C");I.appendChild(P)}S.appendChild(I),p.appendChild(S);break;case"Page History":let N=a("div"),R=`processed_pages_${n}`,ce=JSON.parse(localStorage.getItem(R)||"[]");N.appendChild(y(ce,"Processed Pages (Anti-duplicate)"));let j=`snapshot_pages_${n}`,D=JSON.parse(localStorage.getItem(j)||"[]");N.appendChild(y(D,"Saved Snapshots"));let M=a("div","mt-6 bg-black/20 p-4 rounded-md"),B=a("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","Current Page Info");M.appendChild(B);let V={sessionId:n,page_number:v.page_number,title:v.header.title,timestamp:new Date().toISOString()};M.appendChild(l(V)),N.appendChild(M),p.appendChild(N);break}};h.forEach(b=>{b.addEventListener("click",()=>{h.forEach(w=>{w.className="px-4 py-2 rounded-t-md transition-colors text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}),b.className="px-4 py-2 rounded-t-md transition-colors bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]",u(b.dataset.tab)})}),u("Entities"),r.appendChild(t),document.body.appendChild(r),r.addEventListener("click",b=>{b.target===r&&r.remove()})};tt();T();function kt(e,r,t){let o=r.split(" "),s=[],i="";for(let g of o){let c=i+g+" ";e.measureText(c).width>t&&i!==""?(s.push(i.trim()),i=g+" "):i=c}return s.push(i.trim()),s}function At(e,r=""){let t=document.createElement("canvas");t.width=512,t.height=512;let o=t.getContext("2d"),s=o.createLinearGradient(0,0,t.width,t.height);s.addColorStop(0,"#667eea"),s.addColorStop(1,"#764ba2"),o.fillStyle=s,o.fillRect(0,0,t.width,t.height),o.fillStyle="white",o.textAlign="center",o.textBaseline="middle",r&&(o.font="bold 24px Arial",o.fillText("Generation Failed",t.width/2,t.height/2-60),o.font="16px Arial",kt(o,r,480).forEach((m,d)=>{o.fillText(m,t.width/2,t.height/2-30+d*20)})),o.font="bold 20px Arial";let i=kt(o,e,400),g=(t.height-i.length*30)/2+(r?60:0);return i.forEach((c,m)=>{o.fillText(c,t.width/2,g+m*30)}),o.font="bold 16px Arial",o.fillStyle="rgba(255, 255, 255, 0.8)",o.fillText("Generated Image Placeholder",t.width/2,t.height-30),t.toDataURL("image/jpeg",.8)}async function ke(e,r,t){let o=`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent?key=${r}`,s={contents:[{parts:[{text:e}]}],generationConfig:{responseModalities:["IMAGE"]}};console.log(`Calling ${t} with prompt:`,e);let i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok){let m=`API call failed: HTTP ${i.status}`;try{let d=await i.json();console.error(`API Error (${t}, Status: ${i.status}):`,d),d.error&&d.error.message&&(m+=` - ${d.error.message}`),i.status===429&&(m="QUOTA_EXCEEDED")}catch{let f=await i.text();console.error(`API Error (${t}, Status: ${i.status}):`,f)}throw new Error(m)}let g=await i.json(),c=g?.candidates?.[0]?.content?.parts?.find(m=>m.inlineData);if(c&&c.inlineData&&c.inlineData.data){let m=`data:${c.inlineData.mimeType};base64,${c.inlineData.data}`;return console.log(`Image generated successfully with ${t}`),m}throw console.error(`No image data in response from ${t}:`,g),new Error("No image data in API response.")}async function st(e,r=0){let o="gemini-2.5-flash-image-preview";try{let s,i=et();if(Z==="stopped")throw new Error("Image generation stopped due to all API quotas exceeded.");if(Z==="free"){ie("free","\uBB34\uB8CC API \uC0AC\uC6A9 \uC911");try{s=await ke(e,"",o)}catch(g){if(g.message==="QUOTA_EXCEEDED")console.warn("Free API quota exceeded. Switching to paid API."),ie("paid","\uBB34\uB8CC \uD560\uB2F9\uB7C9 \uCD08\uACFC\uB85C \uC804\uD658"),ge("paid"),De(!0),s=await ke(e,i,o);else throw g}}else if(Z==="paid"){if(!i)throw new Error("Paid API mode selected, but no user API key provided.");ie("paid","\uC720\uB8CC API \uC0AC\uC6A9 \uC911");try{s=await ke(e,i,o)}catch(g){if(g.message==="QUOTA_EXCEEDED"){if(Se)throw console.error("All API quotas exceeded. Stopping image generation."),ie("stopped","\uBAA8\uB4E0 \uD560\uB2F9\uB7C9 \uCD08\uACFC"),ge("stopped"),He(!0),new Error("All API quotas exceeded.");console.warn("Paid API quota exceeded. Switching back to free API."),ie("free","\uC720\uB8CC \uD560\uB2F9\uB7C9 \uCD08\uACFC\uB85C \uC7AC\uC804\uD658"),ge("free"),s=await ke(e,"",o)}else throw g}}return s}catch(s){return console.error("Image generation failed:",s.message),s.message.includes("All API quotas exceeded")||Z==="stopped"?At(e,s.message):r<3?(console.warn(`Image generation failed, retrying... (${r+1}/3)`),await new Promise(i=>setTimeout(i,2e3)),await st(e,r+1)):At(e,s.message)}}var H=null,rt=(e,r=!0,t=!1)=>{let o=a("details","d6-card");t&&o.setAttribute("open",""),r||o.classList.add("main-player-card");let s=a("summary","d6-summary"),i=a("div","d6-header");i.innerHTML=`
        <span class="d6-name flex-grow min-w-0 whitespace-nowrap overflow-hidden text-ellipsis">${e.name||e.id}</span>
        <span class="d6-type">${e.type||"Unknown"}</span>
    `;let g=a("div","d6-scale-container"),c=a("div","d6-scale-line");g.appendChild(c);let m=n=>{let l=Number(n);return isNaN(l)||l<1?"0%":l>5?"100%":`${(l-1)*25}%`},d=n=>n.friendliness!==void 0&&n.friendliness!==null?{name:"friendliness",value:Number(n.friendliness)}:n.familiarity!==void 0&&n.familiarity!==null?{name:"familiarity",value:Number(n.familiarity)}:n.relevance!==void 0&&n.relevance!==null?{name:"relevance",value:Number(n.relevance)}:null,f=[{name:"status",value:e.status},{name:"importance",value:e.importance}],x=d(e);x&&f.push(x);let C=f.filter(n=>{let l=Number(n.value);return!isNaN(l)&&l>0}),h={};C.forEach(n=>{let l=m(n.value);h[l]||(h[l]=[]),h[l].push(n.name)});let p=8;for(let n in h){let l=h[n],y=l.length,b=-((y-1)*p)/2;l.forEach((w,S)=>{let $;w==="importance"?$="var(--dot-yellow-color)":w==="status"?$="var(--dot-red-color)":w==="friendliness"||w==="familiarity"||w==="relevance"?$="var(--dot-cyan-color)":$="var(--dot-gray-color)";let I=a("div",`d6-dot ${w} border-[${$}] bg-[${$}]`);if(y>1){let _=b+S*p;I.style.left=`calc(${n} + ${_}px)`}else I.style.left=n;g.appendChild(I)})}s.appendChild(i),s.appendChild(g);let v=a("div","d6-desc");if(e.description){let n=a("p");n.textContent=e.description,v.appendChild(n)}else{let n=a("p","italic text-stone-500");n.textContent="No description available.",v.appendChild(n)}return o.appendChild(s),o.appendChild(v),o.dataset.entityId=e.id,r&&(o.setAttribute("draggable","true"),o.classList.add("cursor-grab"),o.addEventListener("dragstart",Ae),o.addEventListener("dragend",Me),o.addEventListener("dragover",Te),o.addEventListener("drop",Ne)),s.addEventListener("click",n=>{if(n.detail>0){let l=n.target.closest("details");l&&(l.hasAttribute("open")?l.removeAttribute("open"):l.setAttribute("open",""))}n.preventDefault()}),o},uo=(e,r,t=!1)=>{let o=a("details","d6-card");t&&o.setAttribute("open",""),o.dataset.assetId=e.id;let s=a("summary","d6-summary"),i=a("div","d6-header");i.innerHTML=`
        <span class="d6-name flex-grow min-w-0 whitespace-nowrap overflow-hidden text-ellipsis">${e.name||e.id}</span>
        <span class="d6-type">${e.type||"Asset"}</span>
    `;let g=a("div","d6-scale-container"),c=a("div","d6-scale-line");g.appendChild(c);let m=n=>{let l=Number(n);return isNaN(l)||l<1?"0%":l>5?"100%":`${(l-1)*25}%`},d=(n,l)=>{for(let y of l)if(n[y]!==void 0&&n[y]!==null){let u=Number(n[y]);if(!isNaN(u))return u}return 0},f=[{name:"state",value:d(e,["condition","quantity"])},{name:"value",value:d(e,["grade","quality"])},{name:"impact",value:d(e,["burden","weight","threat"])}].filter(n=>{let l=Number(n.value);return!isNaN(l)&&l>0}),x={};f.forEach(n=>{let l=m(n.value);x[l]||(x[l]=[]),x[l].push(n.name)});let C=8;for(let n in x){let l=x[n],y=l.length,b=-((y-1)*C)/2;l.forEach((w,S)=>{let $;w==="state"?$="var(--dot-red-color)":w==="value"?$="var(--dot-cyan-color)":$="var(--dot-yellow-color)";let I=a("div",`d6-dot ${w} border-[${$}] bg-[${$}]`);if(y>1){let _=b+S*C;I.style.left=`calc(${n} + ${_}px)`}else I.style.left=n;g.appendChild(I)})}s.appendChild(i),s.appendChild(g);let h=a("div","d6-desc"),p=e.properties||{},v="";if(e.description&&(v+=e.description),v){let n=a("p");n.innerHTML=v,h.appendChild(n)}else{let n=a("p","italic text-stone-500");n.textContent="No description or properties available.",h.appendChild(n)}return o.appendChild(s),o.appendChild(h),o.setAttribute("draggable","true"),o.classList.add("cursor-grab"),o.addEventListener("dragstart",Ae),o.addEventListener("dragend",Me),o.addEventListener("dragover",Te),o.addEventListener("drop",Ne),s.addEventListener("click",n=>{if(n.detail>0){let l=n.target.closest("details");l&&(l.hasAttribute("open")?l.removeAttribute("open"):l.setAttribute("open",""))}n.preventDefault()}),o},fo=(e,r)=>{let t=a("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");t.setAttribute("draggable","true"),t.setAttribute("data-index",r),t.dataset.resourceId=e.id;let o=e.max&&e.max>0?e.current/e.max*100:0;return t.innerHTML=`
        <div class="flex justify-between items-baseline text-sm mb-1">
            <span class="font-semibold text-[var(--text-color-primary)]">${e.name}</span>
            <span class="font-mono text-[var(--text-color-secondary)]">${e.current}${e.max?"/"+e.max:""}</span>
        </div>
        ${e.max?`
            <div class="w-full bg-black/30 rounded-full h-1.5 mb-1">
                <div class="h-1.5 rounded-full transition-all duration-300" style="width: ${o}%; background-color: ${e.color};"></div>
            </div>
        `:""}
        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${e.description}</p>`:""}
    `,t.addEventListener("dragstart",Ae),t.addEventListener("dragend",Me),t.addEventListener("dragover",Te),t.addEventListener("drop",Ne),t},ho=(e,r)=>{let t=a("li","bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors");t.setAttribute("draggable","true"),t.setAttribute("data-index",r),t.dataset.modifierId=e.id;let o="text-[var(--ui-accent-secondary)]",s="";return e.alignment==="good"?(o="text-[var(--ally-color-border)]",s="border-l-2 border-[var(--ally-color-border)]"):e.alignment==="bad"?(o="text-[var(--enemy-color-border)]",s="border-l-2 border-[var(--enemy-color-border)]"):e.alignment==="neutral"&&(o="text-[var(--object-color-border)]",s="border-l-2 border-[var(--object-color-border)]"),t.className=`bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors ${s}`,t.innerHTML=`
        <div class="flex justify-between items-baseline mb-1">
            <span class="font-semibold ${o} text-sm">${e.name}</span>
            ${e.duration?`<span class="text-xs text-[var(--text-color-secondary)]">${e.duration}</span>`:""}
        </div>
        <div class="text-xs text-[var(--text-color-secondary)]">
            ${e.target} ${e.operation} ${e.value}
        </div>
        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${e.description}</p>`:""}
    `,t.addEventListener("dragstart",Ae),t.addEventListener("dragend",Me),t.addEventListener("dragover",Te),t.addEventListener("drop",Ne),t},Ae=e=>{H=e.target.closest('[draggable="true"]'),H&&(H.style.opacity="0.5",H.classList.add("border","border-stone-500"),e.dataTransfer.effectAllowed="move")},Me=async e=>{if(H){H.style.opacity="1",H.classList.remove("border","border-stone-500");let r=H.parentNode;if(r){let t=r.getAttribute("data-list-type");await xo(r,t)}}},Te=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";let r=e.target.closest('[draggable="true"]');if(r&&r!==H&&r.parentNode===H.parentNode){let t=r.parentNode,o=Array.from(t.children).filter(c=>c.hasAttribute("draggable")),s=new Map;o.forEach(c=>{s.set(c,c.getBoundingClientRect())});let i=r.getBoundingClientRect(),g=i.top+i.height/2;e.clientY<g?t.insertBefore(H,r):t.insertBefore(H,r.nextSibling),o.forEach(c=>{let m=s.get(c),d=c.getBoundingClientRect(),f=m.top-d.top,x=m.left-d.left;(f||x)&&(c.style.transition="none",c.style.transform=`translate(${x}px, ${f}px)`)}),requestAnimationFrame(()=>{o.forEach(c=>{c.style.transition="transform 0.3s ease-out",c.style.transform=""})})}},Ne=e=>{e.preventDefault(),e.stopPropagation()},xo=async(e,r)=>{if(!e||!r)return;let o=Array.from(e.children).map(s=>r==="resource"?s.dataset.resourceId:r==="asset"?s.dataset.assetId||s.textContent.trim():r==="modifier"?s.dataset.modifierId:r==="codex"?s.dataset.entityId:null).filter(s=>s!==null);r==="resource"?(await qe(o),console.log("Resource order saved:",o)):r==="asset"?(await ze(o),console.log("Asset order saved:",o)):r==="modifier"?(await Ke(o),console.log("Modifier order saved:",o)):r==="codex"&&(await Ve(o),console.log("Codex order saved:",o))},Ce=(e,r,t="id")=>{if(!r||r.length===0)return e;let o=new Map(e.map(g=>[g[t],g])),s=[],i=[];return r.forEach(g=>{let c=o.get(g);c&&(s.push(c),o.delete(g))}),o.forEach(g=>i.push(g)),[...i,...s]},ve=e=>{let r=document.getElementById("header-container");if(!r)return;let t=e.title||"\uC81C 1\uC7A5: \uADF8\uB9BC\uC790\uC758 \uAE38";r.innerHTML=`
        <div class="flex justify-between items-center">
            <button id="prev-page-button" class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
            <h1 class="text-2xl font-bold text-[var(--text-color-primary)] text-center cursor-pointer" id="header-title">${t}</h1>
            <button id="next-page-button" class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
        </div>
        <div class="text-center text-sm text-[var(--text-color-secondary)] mt-2">
            <span class="block sm:inline">${e.hud?.location||"\uC54C \uC218 \uC5C6\uB294 \uC7A5\uC18C"}</span>
            <span class="hidden sm:inline mx-2">\xB7</span>
            <span class="block sm:inline">
                <span>${e.hud?.date||""}</span>
                <span class="mx-2">\xB7</span>
                <span>${e.hud?.time||""}</span>
            </span>
        </div>
    `,document.getElementById("header-title").addEventListener("click",ot)};var le=e=>{let r=document.getElementById("info-panel-container");if(!r)return;r.innerHTML="";let t=e.image_prompt,o=t&&t.trim()!==""&&t.trim().toUpperCase()!=="NULL",s=e.scene_elements&&e.scene_elements.length>0,i=o,g=e.page_image_data_url,c=i;if(!s&&!c){let p=a("div","relative w-full transition-all duration-300 ease-in-out rounded-lg overflow-hidden"),v=a("div","h-24"),n=a("div","relative w-full h-full flex items-center"),l=a("div","absolute left-[5%] top-1/2 w-[90%] h-0.5 bg-[var(--info-panel-line-color)] info-panel-line");l.id="info-panel-line",n.appendChild(l),v.appendChild(n),p.appendChild(v),p.style.maxHeight="96px",r.appendChild(p);return}let m=e.page_number||0,d=a("div","relative w-full transition-all duration-300 ease-in-out rounded-lg overflow-hidden"),f=a("div","max-h-0 overflow-hidden transition-all duration-300 ease-in-out relative"),x=[],C=!1,h=null;if(s){d.classList.add("cursor-pointer","hover:bg-[var(--bg-panel)]"),h=a("div","h-24");let p=a("div","relative w-full h-full flex items-center"),v="absolute left-[5%] top-1/2 w-[90%] h-0.5 bg-[var(--info-panel-line-color)] info-panel-line"+(c?" loading-shine":""),n=a("div",v);n.id="info-panel-line",p.appendChild(n);let l=[...e.scene_elements].sort((u,b)=>u.distance-b.distance),y=Math.max(...e.scene_elements.map(u=>Math.abs(u.distance)),5);l.forEach((u,b)=>{let w=Math.max(-y,Math.min(y,u.distance)),S=l.filter(de=>de.distance===u.distance),$=S.findIndex(de=>de.name===u.name),I=S.length,_=2,R=-((I-1)*_)/2,j=50+w/y*45+R+$*_,D=a("div","absolute top-1/2");D.style.left=`${j}%`,D.style.transform="translate(-50%, -50%)";let M=a("div","w-3 h-3 rounded-full border-2 transition-all duration-200 ease-in-out relative flex items-center justify-center"),B,V,P;u.type==="player"?B="var(--dot-yellow-color)":u.type==="ally"?B="var(--dot-cyan-color)":u.type==="enemy"?B="var(--dot-red-color)":B="var(--dot-gray-color)",M.classList.add(`border-[${B}]`,`bg-[${B}]`),V=u.type==="player"?"text-black":"text-white",P=B,d.classList.contains("is-expanded")&&(M.classList.remove("w-3","h-3"),M.classList.add("w-5","h-5"));let L=a("div","absolute bottom-full mb-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap");L.style.left="50%",L.style.transform="translateX(-50%)",L.style.color=P,L.style.fontSize="16px",L.style.fontWeight="bold",L.textContent=u.name,u.type==="player"&&m===1?L.style.opacity="1":L.style.opacity="0",M.appendChild(L);let k=null;u.type==="player"&&u.condition&&(k=a("div","absolute top-full mt-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap text-xs text-[var(--text-color-secondary)]"),k.style.left="50%",k.style.transform="translateX(-50%)",k.textContent=u.condition,m===1?k.style.opacity="1":k.style.opacity="0",M.appendChild(k));let se=String.fromCharCode(65+b),F=a("span",`relative text-xs font-bold ${V} opacity-0 transition-opacity duration-200`);F.textContent=se,d.classList.contains("is-expanded")&&(F.style.opacity="1"),M.appendChild(F),x.push({dot:M,indexSpan:F,elementWrapper:D,nameTooltip:L,statusTooltip:k,element:u}),D.addEventListener("mouseenter",()=>{d.classList.contains("is-expanded")||(L.style.opacity="1",k&&m===1&&(k.style.opacity="1"))}),D.addEventListener("mouseleave",()=>{u.type==="player"&&m===1&&!C?(L.style.opacity="1",k&&(k.style.opacity="1")):(L.style.opacity="0",k&&(k.style.opacity="0"))}),D.appendChild(M),p.appendChild(D)}),h.appendChild(p),d.appendChild(h)}if(c){s||d.classList.add("cursor-pointer","hover:bg-[var(--bg-panel)]"),f.classList.add("px-4","pb-4");let p=a("div","w-full aspect-square bg-black/20 border border-[var(--border-color)] rounded-md flex items-center justify-center transition-opacity duration-300 opacity-0");if(p.id="image-placeholder-content",g){let v=a("img","w-full h-full object-cover");v.src=g,v.alt=t,p.appendChild(v)}else{let v=a("p","text-[var(--text-color-secondary)] italic","\uC774\uBBF8\uC9C0 \uC0DD\uC131\uC911...");p.appendChild(v)}f.appendChild(p)}else if(s){let p=a("ul","space-y-3 px-[5%] pb-12 opacity-0 transition-opacity duration-300");[...e.scene_elements].sort((n,l)=>n.distance-l.distance).forEach((n,l)=>{let y=a("li","text-[var(--text-color-primary)]"),u;n.type==="player"?u="text-[var(--player-color)]":n.type==="ally"?u="text-[var(--ally-color-border)]":n.type==="enemy"?u="text-[var(--enemy-color-border)]":n.type==="object"&&(u="text-[var(--object-color-border)]");let b=String.fromCharCode(65+l);y.innerHTML=`<strong class="font-bold ${u}">${b}. ${n.name}:</strong> <span class="text-[var(--text-color-secondary)]">${n.condition}</span>`,p.appendChild(y)}),f.appendChild(p)}if(d.appendChild(f),A?d.style.maxHeight=d.scrollHeight+"px":d.style.maxHeight="96px",A&&d.classList.add("is-expanded","bg-[var(--bg-panel)]"),d.classList.contains("is-expanded")){f.style.maxHeight=f.scrollHeight+"px";let p=f.querySelector("ul"),v=f.querySelector("#image-placeholder-content");p&&setTimeout(()=>p.classList.add("opacity-100"),50),v&&setTimeout(()=>v.classList.add("opacity-100"),50),h&&(h.style.pointerEvents="none"),x.forEach(({dot:n,indexSpan:l})=>{n.classList.remove("w-3","h-3"),n.classList.add("w-5","h-5"),c?l.style.opacity="0":l.style.opacity="1"})}else d.classList.remove("bg-[var(--bg-panel)]"),d.style.maxHeight="96px",f.style.maxHeight="0px",h&&(h.style.pointerEvents="auto"),x.forEach(({dot:p,indexSpan:v})=>{p.classList.remove("w-5","h-5"),p.classList.add("w-3","h-3"),v.style.opacity="0"});d.addEventListener("mouseenter",()=>{C=!0,m===1&&!c&&x.forEach(({nameTooltip:p,statusTooltip:v,element:n})=>{n.type==="player"&&(p.style.opacity="0",v&&(v.style.opacity="0"))})}),d.addEventListener("mouseleave",()=>{C=!1,m===1&&!c&&!d.classList.contains("is-expanded")&&x.forEach(({nameTooltip:p,statusTooltip:v,element:n})=>{n.type==="player"&&(p.style.opacity="1",v&&(v.style.opacity="1"))})}),d.addEventListener("click",p=>{if(p.target.closest(".pointer-events-auto"))return;let v=d.classList.contains("is-expanded");if(A&&v)return;let n=d.classList.toggle("is-expanded"),l=f.querySelector("ul"),y=f.querySelector("#image-placeholder-content");if(n)d.classList.add("bg-[var(--bg-panel)]"),d.style.maxHeight="9999px",f.style.maxHeight=f.scrollHeight+"px",l&&setTimeout(()=>l.classList.add("opacity-100"),50),y&&setTimeout(()=>y.classList.add("opacity-100"),50),h&&(h.style.pointerEvents="none"),x.forEach(({dot:u,indexSpan:b})=>{u.classList.remove("w-3","h-3"),u.classList.add("w-5","h-5"),c?b.style.opacity="0":b.style.opacity="1"});else{d.classList.remove("bg-[var(--bg-panel)]"),d.style.maxHeight="96px";let u=f.querySelector("ul"),b=f.querySelector("#image-placeholder-content");u&&u.classList.remove("opacity-100"),b&&b.classList.remove("opacity-100"),f.style.maxHeight="0px",h&&(h.style.pointerEvents="auto"),x.forEach(({dot:w,indexSpan:S})=>{w.classList.remove("w-5","h-5"),w.classList.add("w-3","h-3"),S.style.opacity="0"})}}),r.appendChild(d)},be=e=>{let r=document.getElementById("choices-container");if(!r||!e.choices||e.choices.length===0)return;r.innerHTML="";let t=a("div","w-full pt-4");e.choices.forEach((o,s)=>{let i=a("div","w-full text-left py-2 text-[var(--text-color-primary)] text-lg"),g=ft(o);i.innerHTML=`<span class="font-bold text-[var(--text-accent-bold)]">${s+1}.</span> ${g}`,t.appendChild(i)}),r.appendChild(t)},ye=e=>{let r=document.getElementById("content-container");if(r){if(r.innerHTML="",e.story_html){let t=a("div","space-y-4");t.innerHTML=e.story_html,r.appendChild(t)}else if(e.main_content&&e.main_content.length>0){let t=a("div","space-y-4");e.main_content.forEach(o=>{let s=a("p");o.id==="narration"?(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.textContent=o.content):o.id==="thought"?(s.className="text-[var(--text-accent-bold)] leading-loose text-lg pl-4 border-l-2 border-[var(--ui-accent-secondary)]",s.textContent=o.content):o.id==="document"?(s.className="text-[var(--text-color-primary)] leading-relaxed text-base bg-[var(--bg-panel)]/50 p-4 rounded border border-[var(--border-color)]",s.textContent=o.content):o.id==="system"?(s.className="text-[var(--text-color-secondary)] text-sm text-center",s.textContent=o.content):o.id==="quote"?(s.className="text-[var(--text-accent-aux)] leading-relaxed text-lg pl-6 border-l-4 border-[var(--text-accent-aux)] italic",s.textContent=o.content):(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.innerHTML=`<span class="font-bold text-[var(--text-accent-italic)]">${o.id}:</span> ${o.content}`),t.appendChild(s)}),r.appendChild(t)}}},we=e=>{let r=!0,t=null,o=0,s=0,i="",g=document.getElementById("hud-container");if(!g)return;g.innerHTML="";let c=a("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(e.resources&&e.resources.length>0){let n=e.resources.filter(b=>b.max!==null&&b.max!==void 0),l=e.resources.filter(b=>b.max===null||b.max===void 0),y=[...n,...l];y=Ce(y,ee,"id");let u=a("ul","space-y-2 resource-list");u.setAttribute("data-list-type","resource"),y.forEach((b,w)=>{let S=fo(b,w);u.appendChild(S)}),c.appendChild(u)}else{let n=a("p","text-sm text-[var(--text-color-secondary)] italic");n.textContent="\uC774\uACF3\uC5D0 \uC790\uC6D0\uC774 \uD45C\uC2DC\uB429\uB2C8\uB2E4.",c.appendChild(n)}if(e.modifiers&&e.modifiers.length>0){let n=a("div","mt-4 pt-3 border-t border-[var(--border-color)]"),l=a("ul","space-y-2 modifier-list");l.setAttribute("data-list-type","modifier"),Ce(e.modifiers,oe,"id").forEach((u,b)=>{let w=ho(u,b);l.appendChild(w)}),n.appendChild(l),c.appendChild(n)}let m=a("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(e.asset&&e.asset.length>0){let n=Ce(e.asset,te,"id"),l=a("ul","space-y-2 asset-list");l.setAttribute("data-list-type","asset"),n.forEach((y,u)=>{let b=uo(y,u,!0);l.appendChild(b)}),m.appendChild(l)}else{let n=a("p","text-sm text-[var(--text-color-secondary)] italic");n.textContent="\uC774\uACF3\uC5D0 \uC790\uC0B0\uC774 \uD45C\uC2DC\uB429\uB2C8\uB2E4.",m.appendChild(n)}let d=a("div","hidden sm:block bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]"),f=[],x=new Set;if(e.codex_new&&e.codex_new.length>0&&e.codex_new.forEach(n=>{f.push(n),x.add(n.id)}),e.codex_update&&e.codex_update.length>0&&e.codex_update.forEach(n=>{x.has(n.id)||f.push(n),x.add(n.id)}),f.length>0){let n=[],l=[];f.forEach(S=>{x.has(S.id)?n.push(S):l.push(S)});let y=Ce(n,G,"id"),u=Ce(l,G,"id"),b=[...y,...u],w=a("ul","space-y-2 codex-list");w.setAttribute("data-list-type","codex"),b.forEach(S=>{let $=x.has(S.id),I=rt(S,!0,$);w.appendChild(I)}),d.appendChild(w)}else{let n=a("p","text-sm text-[var(--text-color-secondary)] italic");n.textContent="\uC774\uACF3\uC5D0 \uC9C0\uC2DD\uC774 \uD45C\uC2DC\uB429\uB2C8\uB2E4.",d.appendChild(n)}let C=[c,m,d],h=[];C.forEach(n=>{n.classList.add("flex","flex-col");let l=a("div","mt-4 w-full flex items-end");l.setAttribute("data-tip-spacer","true"),l.style.transition="height 300ms ease-out",l.style.willChange="height",n.appendChild(l),h.push(l),g.appendChild(n)});let p=()=>{requestAnimationFrame(()=>{let y=C,u=y.map($=>{let I=$.querySelector('[data-tip-spacer="true"]'),_=I?I.style.display:"";I&&(I.style.display="none");let N=$.offsetHeight;return I&&(I.style.display=_),N});if(u.length===0)return;let b=Math.max(...u);if(y.forEach(($,I)=>{let _=u[I],N=b-_,R=$.querySelector('[data-tip-spacer="true"]');R&&(R.style.height=`${Math.max(0,N)}px`)}),clearTimeout(t),b<1e3){y.forEach($=>{let I=$.querySelector('[data-tip-spacer="true"]');I&&(I.innerHTML="")});return}let w=[];y.forEach(($,I)=>{b-u[I]>50&&w.push({panel:$,index:I})});let S=w.length>0?w[w.length-1]:null;if(y.forEach(($,I)=>{if(!S||I!==S.index){let _=$.querySelector('[data-tip-spacer="true"]');_&&(_.innerHTML="")}}),!r&&S){let $=Date.now();if($<s)return;let I=S.panel.querySelector('[data-tip-spacer="true"]');($-o>1e4||i==="")&&(o=$,i=$e[Math.floor(Math.random()*$e.length)]);let _=I.querySelector("p");_||(_=document.createElement("p"),_.className="p-4 text-sm text-[var(--text-color-secondary)] italic transition-opacity duration-300 opacity-0",I.appendChild(_)),_.textContent=i,requestAnimationFrame(()=>_.classList.remove("opacity-0")),t=setTimeout(()=>{_.classList.add("opacity-0"),s=Date.now()+1e4,setTimeout(()=>{_.parentNode&&_.parentNode.removeChild(_)},300)},5e3)}})},v=new ResizeObserver(p);C.forEach(n=>{v.observe(n)}),setTimeout(()=>{p(),r=!1},150)},Oe=()=>{let e=document.getElementById("app-root");e.innerHTML="";let r=a("div","max-w-5xl mx-auto p-4 sm:p-6"),t=a("div","mb-8");t.id="header-container";let o=a("div","my-1");o.id="content-container";let s=a("div","my-1");s.id="info-panel-container";let i=a("div");i.id="choices-container";let g=a("div","relative mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 items-start");g.id="hud-container";let c=a("div","flex justify-end gap-2 mt-2");c.id="hud-controls-container";let m=a("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");m.id="image-button",m.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',m.addEventListener("click",Et);let d=a("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");d.id="page-button",d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',d.addEventListener("click",ot);let f=a("button","sm:hidden p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");f.id="codex-button",f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>';let x=a("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");x.id="pin-infopanel-button",x.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',x.addEventListener("click",async()=>{await je(!A),x.classList.toggle("bg-[var(--ui-accent-primary)]",A);let p=document.querySelector("#info-panel-container > div");if(p){let v=p.classList.contains("is-expanded");(A&&!v||!A&&v)&&p.click()}console.log(`Info panel pin state saved: ${A}`)});let C=a("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");C.id="settings-button",C.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67c-.2.2-.3.3-.3.3s-.2.1-.3.1c-.2.1-.4.1-.6.1-.2 0-.4 0-.6-.1a1.65 1.65 0 0 0-1.67-.3c-.2-.2-.3-.3-.3-.3s-.1-.2-.1-.3c-.1-.2-.1-.4-.1-.6 0-.2 0-.4.1-.6a1.65 1.65 0 0 0 .3-1.67c.2-.2.3-.3.3-.3s-.2-.1.3-.1c.2-.1.4-.1.6-.1.2 0 .4 0 .6.1a1.65 1.65 0 0 0 1.67.3c.2.2.3.3.3.3s.1.2.1.3c.1.2.1.4.1.6 0 .2 0 .4-.1.6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';let h=a("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors border border-[var(--border-color)]");h.id="debug-button",h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="6" width="8" height="1"></rect><rect x="8" y="11" width="8" height="1"></rect><rect x="8" y="16" width="8" height="1"></rect><path d="M12 3v3"></path><path d="M12 18v3"></path><path d="M4 9h2"></path><path d="M18 9h2"></path><path d="M4 15h2"></path><path d="M18 15h2"></path><circle cx="12" cy="12" r="9"></circle></svg>',h.title="Debug Data Browser",c.appendChild(m),c.appendChild(d),c.appendChild(f),c.appendChild(x),c.appendChild(C),c.appendChild(h),r.append(t,o,s,i,c,g),e.appendChild(r)};T();import{initializeApp as vo}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";var Mt=async()=>{try{await xt(vo);let e=re();Re(e.sessionId),console.log("Performing initial render with HTML data only."),Oe(),ve(e),ye(e),be(e),we(e),await new Promise(l=>setTimeout(l,50)),console.log("Loading and merging persistent data...");let r=e.sessionId;await Be();let t=await yt(O,E,r);e.resources=K(t.resources,e.resources,"id"),e.asset=K(t.asset,e.asset,"id"),e.modifiers=K(t.modifiers,e.modifiers,"id"),e.codex_new=K(t.entities,e.codex_new,"id"),e.codex_update&&e.codex_update.length>0&&(e.codex_new=K(e.codex_new,e.codex_update,"id"),e.codex_update=[]);let o=e.codex_new||[],s=-1;for(let l=o.length-1;l>=0;l--)if(o[l].id==="player"){s=l;break}s!==-1&&(o[s].is_main="true");let i=e.image_prompt,g=i&&i.trim()!=="",c=e.page_number,m=null;g&&(console.log(`Image prompt found for page ${c}. Attempting to load/generate image.`),m=Ct(r,c),!m&&O&&E&&(console.log(`Image not in localStorage for page ${c}. Checking Firebase.`),m=await It(O,E,r,c)),m?e.page_image_data_url=m:(console.log(`No image found for page ${c}. Generating new image.`),e.page_image_data_url=null,le(e),m=await st(i),m?(e.page_image_data_url=m,wt(r,c,m),St(O,E,r,c,m)):console.warn(`Image generation failed for page ${c}.`)));let f=We()[0]||"modern",x=localStorage.getItem("userPreferredTheme");if(x&&fe.includes(x)&&(f=x),await he(f),console.log("Re-rendering UI with merged data and image."),ve(e),ye(e),le(e),be(e),we(e),e.page_image_data_url){let l=document.getElementById("info-panel-container")?.querySelector(".panel");l&&!A&&!l.classList.contains("is-expanded")&&setTimeout(()=>l.click(),100)}await $t(O,E,e),await vt(O,E,e);let C=document.getElementById("codex-button");C&&C.addEventListener("click",Lt);let h=document.getElementById("settings-button");h&&h.addEventListener("click",Pt);let p=document.getElementById("debug-button");p&&p.addEventListener("click",Ot);let v=document.getElementById("prev-page-button");v&&v.addEventListener("click",()=>{let l=e.page_number-1;l>0&&xe(e.sessionId,l)});let n=document.getElementById("next-page-button");n&&n.addEventListener("click",()=>{let l=e.page_number+1;xe(e.sessionId,l)}),console.log("Application fully initialized with persistent data."),console.log("Setting up periodic sync to Firebase..."),setTimeout(Ze,2e3),setInterval(Ze,2e3)}catch(e){console.error("Initialization Error:",e),document.body.innerHTML=`<div class="text-[var(--enemy-color-border)] p-8">Error: ${e.message}</div>`}};document.addEventListener("DOMContentLoaded",async()=>{await Mt()});
//# sourceMappingURL=bundle.min.js.map

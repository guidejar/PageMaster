var Ge=Object.defineProperty;var Xe=(e,o)=>()=>(e&&(o=e(e=0)),o);var Ye=(e,o)=>{for(var t in o)Ge(e,t,{get:o[t],enumerable:!0})};var F={};Ye(F,{DEFAULT_OFFLINE_USER_ID:()=>D,applyTheme:()=>X,assetCategoryStates:()=>V,assetOrder:()=>le,auth:()=>H,codexCategoryStates:()=>B,controlTips:()=>de,currentThemeName:()=>ae,currentUserId:()=>M,db:()=>N,isAuthReady:()=>Ae,isInfoPanelPinned:()=>j,modifierOrder:()=>ce,parseAvailableThemes:()=>ke,resourceOrder:()=>ie,saveAssetOrder:()=>Le,saveModifierOrder:()=>Ee,saveResourceOrder:()=>Ie,setAuth:()=>Ce,setCurrentThemeName:()=>Te,setCurrentUserId:()=>$e,setDb:()=>Se,setIsAuthReady:()=>z,setIsInfoPanelPinned:()=>_e,themeNames:()=>G,userPreferredTheme:()=>W});var H,N,Ae,M,D,V,B,j,ae,W,ie,le,ce,de,G,Ce,Se,z,$e,_e,Te,Ie,Le,Ee,X,ke,A=Xe(()=>{H=null,N=null,Ae=!1,M=null,D="offline-user",V={},B={},j=!1,ae="default",W=localStorage.getItem("userPreferredTheme")||null,ie=JSON.parse(localStorage.getItem("resourceOrder")||"[]"),le=JSON.parse(localStorage.getItem("assetOrder")||"[]"),ce=JSON.parse(localStorage.getItem("modifierOrder")||"[]"),de=["\uC120\uD0DD\uC9C0 \uC704\uC5D0 \uC788\uB294 \uAC00\uB85C\uC904\uACFC \uC810\uB4E4\uC740 \uC778\uD3EC\uD328\uB110\uC785\uB2C8\uB2E4. \uD55C\uBC88 \uB20C\uB7EC\uBCF4\uC138\uC694.","\uC120\uD0DD\uC9C0 \uC6B0\uCE21 \uD558\uB2E8\uC5D0 \uC704\uCE58\uD55C \uC544\uC774\uCF58\uC744 \uB20C\uB7EC\uD574\uBCF4\uC138\uC694.","\uB4DC\uB798\uADF8 \uC564 \uB4DC\uB86D\uC73C\uB85C \uBAA9\uB85D\uC758 \uC704\uCE58\uB97C \uBC14\uAFD4\uBCF4\uC138\uC694.","\uD398\uC774\uC9C0 \uC81C\uBAA9\uC744 \uD074\uB9AD\uD558\uBA74 \uD398\uC774\uC9C0 \uBAA9\uB85D\uC774 \uB098\uC635\uB2C8\uB2E4.","\uD398\uC774\uC9C0 \uC591 \uC606\uC758 \uD654\uC0B4\uD45C\uB85C \uD398\uC774\uC9C0\uB97C \uC774\uB3D9\uD560 \uC218 \uC788\uC5B4\uC694.","\uC120\uD0DD\uC9C0 \uC544\uB798\uC5D0 \uC788\uB294 \uC774\uBBF8\uC9C0 \uC544\uC774\uCF58\uC744 \uD074\uB9AD\uD558\uBA74 \uD574\uB2F9 \uC7A5\uBA74\uC5D0 \uB9DE\uB294 \uC774\uBBF8\uC9C0\uB97C \uC0DD\uC131\uD560 \uC218 \uC788\uC5B4\uC694."],G=["fantasy","stone-cyan-dark","cyberpunk","horror","modern","cyberpunk-dark","material-dark","material-light"],Ce=e=>{H=e},Se=e=>{N=e},z=e=>{Ae=e},$e=e=>{M=e},_e=e=>{j=e},Te=e=>{ae=e},Ie=e=>{ie=e,localStorage.setItem("resourceOrder",JSON.stringify(e))},Le=e=>{le=e,localStorage.setItem("assetOrder",JSON.stringify(e))},Ee=e=>{ce=e,localStorage.setItem("modifierOrder",JSON.stringify(e))},X=e=>{document.body.className=document.body.className.split(" ").filter(o=>!o.startsWith("theme-")).join(" "),document.body.classList.add(`theme-${e}`),Te(e),console.log(`Applied theme: ${e}`)},ke=()=>{let e=document.getElementById("available-themes");return e&&e.textContent.trim()?e.textContent.trim().split("|").map(o=>o.trim()):["modern","material-dark","material-light","cyberpunk-dark"]}});A();import{getAuth as st,signInWithCustomToken as nt,onAuthStateChanged as at}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore as it,collection as Oe,doc as J,getDoc as ge,setDoc as ee,serverTimestamp as fe,getDocs as lt,deleteDoc as ct}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";var Qe=()=>{let e={};return document.querySelectorAll('script[type="text/html"]').forEach(o=>{let t=o.getAttribute("data-id"),r=o.getAttribute("data-category");t&&(e[t]={category:r||"unknown",content:o.innerHTML.trim()})}),e},Ze=e=>{if(!e)return"";let o=e;return o=o.replace(/^### (.+)$/gm,'<h3 class="text-xl font-bold text-[var(--text-color-primary)] mt-4 mb-2">$1</h3>'),o=o.replace(/^## (.+)$/gm,'<h2 class="text-2xl font-bold text-[var(--text-color-primary)] mt-6 mb-3">$1</h2>'),o=o.replace(/^# (.+)$/gm,'<h1 class="text-3xl font-bold text-[var(--text-color-primary)] mt-8 mb-4">$1</h1>'),o=o.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),o=o.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),o=o.replace(/\n\n/g,'</p><p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'),o='<p class="text-[var(--text-color-primary)] leading-loose text-lg mb-4">'+o+"</p>",o},Be=e=>{if(!e)return"";let o=e;return o=o.replace(/\*\*(.+?)\*\*/g,'<strong class="font-bold text-[var(--text-accent-bold)]">$1</strong>'),o=o.replace(/\*(.+?)\*/g,'<em class="italic text-[var(--text-accent-italic)]">$1</em>'),o},et=()=>{let e=document.getElementById("header");if(!e)return{title:"",location:"",date:"",time:""};let t=e.textContent.trim().split("|").map(r=>r.trim());return{title:t[0]||"",location:t[1]||"",date:t[2]||"",time:t[3]||""}},tt=()=>{let e=document.getElementById("story");return e?Ze(e.textContent.trim()):""},ot=()=>{let e=document.getElementById("choices");return e?e.textContent.trim().split(`
`).map(r=>r.trim()).filter(r=>r).map(r=>r.replace(/^\d+\.\s*/,"").trim()):[]},rt=()=>{let e=document.getElementById("scene-data");return e?e.textContent.trim().split(`
`).map(r=>r.trim()).filter(r=>r).map(r=>{let s=r.split("|").map(l=>l.trim());return{type:s[1]||"",name:s[2]||"",distance:s[3]?Number(s[3]):0,status:s[4]||""}}).filter(r=>r.type):[]};var Me=e=>{let o=document.querySelectorAll('script[id="codex"]'),t=null;o.forEach(g=>{g.getAttribute("data-type")===e&&(t=g)});let r={entities:[],resources:[],assets:[],modifiers:[],removed:{entities:[],resources:[],assets:[],modifiers:[]}};if(!t)return r;let l=t.textContent.trim().split(`
`).map(g=>g.trim()).filter(g=>g),c={},d={},h={},f={};return l.forEach(g=>{let b=g.indexOf("|");if(b===-1)return;let w=g.substring(0,b).trim(),i=g.substring(b+1).trim(),m=w.split("."),u=m[0],a=m[1],p=m.slice(2);if(e==="remove"){u==="entity"?r.removed.entities.push(a):u==="resource"?r.removed.resources.push(a):u==="asset"?r.removed.assets.push(a):u==="effect"&&r.removed.modifiers.push(a);return}if(u==="entity"){c[a]||(c[a]={id:a,classifications:{}});let v=c[a];if(p.length===1){let x=p[0];v[x]=i}else if(p[0]==="classifications"&&p.length===2){let x=p[1],y=i.indexOf(":");if(y>-1){let I=i.substring(0,y).trim(),$=i.substring(y+1).trim();v.classifications[x]={label:I,value:$}}else v.classifications[x]={label:x,value:i}}}else if(u==="resource"){d[a]||(d[a]={id:a});let v=d[a],x=p[0];x==="current"||x==="max"?v[x]=i==="NULL"?null:Number(i):v[x]=i}else if(u==="asset"){h[a]||(h[a]={id:a,properties:{}});let v=h[a];if(p.length===1){let x=p[0];x==="quantity"?v[x]=Number(i):v[x]=i}else if(p[0]==="properties"&&p.length===2){let x=p[1],y=i.indexOf(":");if(y>-1){let I=i.substring(0,y).trim(),$=i.substring(y+1).trim();v.properties[x]={label:I,value:$}}else v.properties[x]={label:x,value:i}}}else if(u==="effect"){f[a]||(f[a]={id:a});let v=f[a],x=p[0];v[x]=i}}),r.entities=Object.values(c),r.resources=Object.values(d),r.assets=Object.values(h),r.modifiers=Object.values(f),r},K=()=>{let e=document.getElementById("session-uuid");if(e&&e.textContent.trim()){let t=e.textContent.trim();return console.log(`Session ID loaded from HTML: ${t}`),t}let o=localStorage.getItem("gameSessionId");return o||(o=crypto.randomUUID(),localStorage.setItem("gameSessionId",o),console.warn("New Session ID generated and stored in localStorage.")),o};var Y=()=>{let e=et(),o=tt(),t=ot(),r=rt(),s=Me("new"),l=Me("update"),c=Me("remove"),d=s.entities,h=l.entities,f=[...s.resources,...l.resources],g=[...s.assets,...l.assets],b=[...s.modifiers,...l.modifiers],w=c.removed,i=document.querySelector("title"),m=i?parseInt(i.textContent.match(/\d+/)?.[0]||"0"):0,u=Qe();return{sessionId:K(),header:e,story_html:o,choices:t,scene_elements:r,codex_new:d,codex_update:h,resources:f,asset:g,modifiers:b,removed:w,html_docs:u,page_number:m,define:d,update:h,hud:{location:e.location,date:e.date,time:e.time},title:e.title,character_stats:{resources:f,attributes:{},equipment:{},name:"",level:1},information_panel:[]}};var T=()=>typeof __app_id<"u"?__app_id:"default-app-id";var je=e=>new Promise(o=>{try{let t=typeof __firebase_config<"u"?JSON.parse(__firebase_config):{},r=typeof __initial_auth_token<"u"?__initial_auth_token:null,s;if(typeof e>"u"&&typeof firebase<"u"&&typeof firebase.initializeApp<"u")e=firebase.initializeApp,console.warn("Using global firebase.initializeApp as passed parameter was undefined.");else if(typeof e>"u"){console.error("initializeApp function not provided. Cannot initialize Firebase."),z(!1),o();return}if(Object.keys(t).length>0)s=e(t);else if(typeof firebase<"u"&&firebase.apps.length>0)s=firebase.app(),console.log("Firebase app already initialized, using existing app.");else{console.warn("Firebase config not found and no existing app. Running in offline mode."),z(!1),o();return}Ce(st(s)),Se(it(s)),at(H,async l=>{if(l)$e(l.uid),z(!0),console.log("Firebase authenticated:",l.uid),o();else if(r)try{await nt(H,r)}catch(c){console.error("Custom token sign-in failed:",c);try{await signInAnonymously(H)}catch(d){console.error("Anonymous sign-in failed after custom token failure:",d),console.warn("No authentication available, running in offline mode."),z(!1),o()}}else try{await signInAnonymously(H)}catch(c){console.error("Anonymous sign-in failed:",c),console.warn("No authentication available, running in offline mode."),z(!1),o()}})}catch(t){console.error("Firebase initialization error:",t),z(!1),o()}}),R=(e,o,t="name")=>{if(!e||e.length===0)return o;if(!o||o.length===0)return e;let r=new Map;return e.forEach(s=>{s[t]&&r.set(s[t],s)}),o.forEach(s=>{s[t]&&r.set(s[t],{...r.get(s[t]),...s})}),Array.from(r.values())},Re=async(e,o,t)=>{try{let r=K(),s=e||D,l=t.page_number,c=`snapshot_pages_${r}`,d=JSON.parse(localStorage.getItem(c)||"[]"),h=d.find(p=>p.page_number===l),f=Date.now();if(h){console.log(`Page ${l} snapshot was already saved in this session. Skipping duplicate save.`);return}else d.push({page_number:l,timestamp:f}),localStorage.setItem(c,JSON.stringify(d));let{resourceOrder:g,assetOrder:b,modifierOrder:w,assetCategoryStates:i,codexCategoryStates:m,isInfoPanelPinned:u,currentThemeName:a}=await Promise.resolve().then(()=>(A(),F));if(H&&M){let p=T(),v=J(o,`artifacts/${p}/users/${s}/pages/${r}`),x={...t,globalStates:{resourceOrder:g,assetOrder:b,modifierOrder:w,assetCategoryStates:i,codexCategoryStates:m,isInfoPanelPinned:u,currentThemeName:a},timestamp:fe()};await ee(v,x,{merge:!0}),console.log(`Page snapshot for session ${r} saved successfully to Firebase (complete data). Theme: ${a}`)}else{let p=`page_snapshot_${r}`,v={...t,globalStates:{resourceOrder:g,assetOrder:b,modifierOrder:w,assetCategoryStates:i,codexCategoryStates:m,isInfoPanelPinned:u,currentThemeName:a},timestamp:new Date().toISOString()};localStorage.setItem(p,JSON.stringify(v)),console.log(`Page snapshot for session ${r} saved successfully to localStorage (complete data). Theme: ${a}`)}}catch(r){console.error("Error saving page snapshot:",r)}},De=async(e,o,t)=>{try{let r=e||D;if(H&&M){let s=T(),l=J(o,`artifacts/${s}/users/${r}/pages/${t}`),c=await ge(l);return c.exists()?(console.log(`Page snapshot for session ${t} loaded successfully from Firebase.`),c.data()):(console.log(`No snapshot found for session ${t} in Firebase.`),null)}else{let s=`page_snapshot_${t}`,l=localStorage.getItem(s);return l?(console.log(`Page snapshot for session ${t} loaded successfully from localStorage.`),JSON.parse(l)):(console.log(`No snapshot found for session ${t} in localStorage.`),null)}}catch(r){return console.error("Error loading page snapshot:",r),null}},ze=async(e,o,t)=>{let r={resources:[],asset:[],modifiers:[],entities:[]},s=T(),l=e||D,c=J(o,`artifacts/${s}/users/${l}/sessions/${t}/game_state/current_state`),d=await ge(c);d.exists()&&(r.resources=d.data().resources||[],r.asset=d.data().asset||[],r.modifiers=d.data().modifiers||[]);let h=Oe(o,`artifacts/${s}/users/${l}/sessions/${t}/codex_entities`);return(await lt(h)).forEach(g=>{r.entities.push(g.data())}),r};var Q=(e,o,t,r)=>{let s=e||D,l=`artifacts_${T()}_users_${s}_sessions_${r}_${o}`,c=JSON.parse(localStorage.getItem(l)||"[]"),d=t;c.length>0&&(d=R(c,t,"id")),localStorage.setItem(l,JSON.stringify(d)),console.log(`Data type ${o} for session ${r} saved to localStorage.`)},pe=(e,o,t,r)=>{let s=e||D,l=`artifacts_${T()}_users_${s}_sessions_${r}_${o}`,d=JSON.parse(localStorage.getItem(l)||"[]").filter(h=>h.id!==t);localStorage.setItem(l,JSON.stringify(d)),console.log(`Item ${t} of type ${o} for session ${r} deleted from localStorage.`)},Z=async(e,o,t,r,s)=>{try{let l=T();if(t==="new"||t==="update"){let c=Oe(o,`artifacts/${l}/users/${e}/sessions/${s}/codex_entities`);for(let d of r)if(d.id){let h=J(c,d.id);await ee(h,{...d,updatedAt:fe()},{merge:!0})}console.log(`Codex entities (${t}) saved for session ${s}:`,r.length)}else if(t==="resources"||t==="asset"||t==="modifiers"){let c=J(o,`artifacts/${l}/users/${e}/sessions/${s}/game_state/current_state`),d=await ge(c),h=d.exists()?d.data():{},f=r;h[t]&&(f=R(h[t],r,"id")),await ee(c,{[t]:f,updatedAt:fe()},{merge:!0}),console.log(`Game state (${t}) saved for session ${s}:`,f.length)}}catch(l){console.error(`Firestore \uC800\uC7A5 \uC2E4\uD328 [${t}] for session ${s}:`,l)}},ue=async(e,o,t,r,s)=>{try{let l=T(),c;if(t==="entity")c=J(o,`artifacts/${l}/users/${e}/sessions/${s}/codex_entities`,r),await ct(c),console.log(`Entity ${r} deleted from session ${s}.`);else if(t==="resource"||t==="asset"||t==="modifier"){let d=J(o,`artifacts/${l}/users/${e}/sessions/${s}/game_state/current_state`),h=await ge(d);if(h.exists()){let g=(h.data()[t+"s"]||[]).filter(b=>b.id!==r);await ee(d,{[t+"s"]:g},{merge:!0}),console.log(`${t} ${r} removed from game_state for session ${s}.`)}}}catch(l){console.error(`Error deleting ${t} ${r} for session ${s}:`,l)}},Je=async(e,o,t)=>{try{let r=K(),s=e||D,l=t.page_number,c=`processed_pages_${r}`,d=JSON.parse(localStorage.getItem(c)||"[]"),h=d.find(g=>g.page_number===l),f=Date.now();if(h){console.log(`Page ${l} was already processed in this session. Skipping duplicate save.`);return}else d.push({page_number:l,timestamp:f}),localStorage.setItem(c,JSON.stringify(d));if(H&&M){if(t.codex_new&&t.codex_new.length>0&&await Z(s,o,"new",t.codex_new,r),t.codex_update&&t.codex_update.length>0&&await Z(s,o,"update",t.codex_update,r),t.resources&&t.resources.length>0&&await Z(s,o,"resources",t.resources,r),t.asset&&t.asset.length>0&&await Z(s,o,"asset",t.asset,r),t.modifiers&&t.modifiers.length>0&&await Z(s,o,"modifiers",t.modifiers,r),t.removed){for(let i of t.removed.entities)await ue(s,o,"entity",i,r);for(let i of t.removed.resources)await ue(s,o,"resource",i,r);for(let i of t.removed.assets)await ue(s,o,"asset",i,r);for(let i of t.removed.modifiers)await ue(s,o,"modifier",i,r)}let g=Oe(o,`artifacts/${T()}/users/${s}/page_index`),b=`${r}_${t.page_number}`,w=J(g,b);await ee(w,{sessionId:r,page_number:t.page_number,title:t.header.title,timestamp:fe()},{merge:!0}),console.log(`Page index entry for page ${t.page_number} in session ${r} saved to Firebase.`),console.log("All codex data processed and saved successfully to Firebase.")}else{if(t.codex_new&&t.codex_new.length>0&&Q(s,"entities",t.codex_new,r),t.codex_update&&t.codex_update.length>0&&Q(s,"entities",t.codex_update,r),t.resources&&t.resources.length>0&&Q(s,"resources",t.resources,r),t.asset&&t.asset.length>0&&Q(s,"asset",t.asset,r),t.modifiers&&t.modifiers.length>0&&Q(s,"modifiers",t.modifiers,r),t.removed){for(let m of t.removed.entities)pe(s,"entities",m,r);for(let m of t.removed.resources)pe(s,"resources",m,r);for(let m of t.removed.assets)pe(s,"asset",m,r);for(let m of t.removed.modifiers)pe(s,"modifiers",m,r)}console.log(`All codex data processed and saved successfully to localStorage for session ${r}.`);let g="saved_pages",b=JSON.parse(localStorage.getItem(g)||"[]"),w={sessionId:r,page_number:t.page_number,title:t.header.title,timestamp:new Date().toISOString()},i=b.findIndex(m=>m.sessionId===r&&m.page_number===t.page_number);i>-1?b[i]=w:b.push(w),localStorage.setItem(g,JSON.stringify(b)),console.log(`Page index entry for page ${t.page_number} in session ${r} saved to localStorage index.`)}}catch(r){console.error("Error processing codex data:",r)}};A();A();var n=(e,o="",t="")=>{let r=document.createElement(e);return o&&(r.className=o),t&&(r.textContent=t),r},qe=()=>{let e=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");e.id="active-overlay";let o=n("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6");o.innerHTML=`<h2 class="text-2xl font-bold text-[var(--ui-accent-primary)] mb-4">Image Modal (Placeholder)</h2><p>Image content will go here.</p><button class="mt-4 p-2 bg-[var(--ui-accent-primary)] rounded" onclick="document.getElementById('active-overlay').remove()">Close</button>`,e.appendChild(o),document.body.appendChild(e)},Ue=async e=>{let o=await De(M,N,e);if(!o){console.warn(`Could not load snapshot for session ${e}.`);return}console.log(`Loading snapshot for session ${e} - complete data restoration`);let{applyTheme:t}=await Promise.resolve().then(()=>(A(),F)),r=o.globalStates?.currentThemeName||o.current_theme;if(r&&(console.log(`Applying theme from snapshot: ${r}`),t(r)),o.globalStates){let{setIsInfoPanelPinned:l,saveResourceOrder:c,saveAssetOrder:d,saveModifierOrder:h}=await Promise.resolve().then(()=>(A(),F));if(o.globalStates.isInfoPanelPinned!==void 0&&l(o.globalStates.isInfoPanelPinned),o.globalStates.resourceOrder&&c(o.globalStates.resourceOrder),o.globalStates.assetOrder&&d(o.globalStates.assetOrder),o.globalStates.modifierOrder&&h(o.globalStates.modifierOrder),o.globalStates.assetCategoryStates){let{assetCategoryStates:f}=await Promise.resolve().then(()=>(A(),F));Object.assign(f,o.globalStates.assetCategoryStates)}if(o.globalStates.codexCategoryStates){let{codexCategoryStates:f}=await Promise.resolve().then(()=>(A(),F));Object.assign(f,o.globalStates.codexCategoryStates)}}let s=document.getElementById("app-root");s.innerHTML="",ye(),me(o),ve(o),xe(o),he(o),be(o),console.log(`Page snapshot for session ${e} fully restored with theme: ${r}`)},He=async()=>{let{getDocs:e,collection:o,query:t,orderBy:r}=await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"),s=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");s.id="active-overlay";let l=n("div","w-full max-w-2xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),c=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),d=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uD398\uC774\uC9C0 \uBE0C\uB77C\uC6B0\uC9D5");c.appendChild(d);let h=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");h.textContent="\xD7",h.onclick=()=>s.remove(),c.appendChild(h),l.appendChild(c);let f=n("div","flex-grow overflow-y-auto"),g=n("p","text-[var(--text-color-secondary)]","\uD398\uC774\uC9C0 \uBAA9\uB85D \uBD88\uB7EC\uC624\uB294 \uC911...");if(f.appendChild(g),l.appendChild(f),s.appendChild(l),document.body.appendChild(s),H&&N&&M){let b=o(N,`artifacts/${T()}/users/${M}/page_index`),w=t(b,r("timestamp","desc")),i=await e(w);if(f.innerHTML="",i.empty)f.innerHTML='<p class="text-[var(--text-color-secondary)]">\uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let m=n("ul","space-y-2");i.forEach(u=>{let a=u.data(),p=n("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),v=a.timestamp?new Date(a.timestamp.toDate()).toLocaleString():"\uB0A0\uC9DC \uC5C6\uC74C";p.innerHTML=`
                    <div class="font-bold text-[var(--text-color-primary)]">${a.title||"\uC81C\uBAA9 \uC5C6\uC74C"} (Page ${a.page_number})</div>
                    <div class="text-sm text-[var(--text-color-secondary)]">\uC800\uC7A5 \uC2DC\uAC04: ${v}</div>
                    <div class="text-xs text-[var(--text-color-secondary)]">ID: ${a.sessionId}</div>
                `,p.addEventListener("click",()=>{Ue(a.sessionId),s.remove()}),m.appendChild(p)}),f.appendChild(m)}}else{let w=JSON.parse(localStorage.getItem("saved_branches")||"[]");if(f.innerHTML="",w.length===0)f.innerHTML='<p class="text-[var(--text-color-secondary)]">\uB85C\uCEEC\uC5D0 \uC800\uC7A5\uB41C \uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>';else{let i=n("ul","space-y-2");w.forEach(m=>{let u=`page_snapshot_${m}`,a=localStorage.getItem(u);if(a){let p=JSON.parse(a),v=n("li","p-3 bg-[var(--bg-panel)]/50 hover:bg-[var(--bg-panel)]/70 rounded-md cursor-pointer border border-[var(--border-color)] transition-colors"),x=new Date().toLocaleString();v.innerHTML=`
                        <div class="font-bold text-[var(--text-color-primary)]">${p.header.title||"\uC81C\uBAA9 \uC5C6\uC74C"} (Page ${p.page_number})</div>
                        <div class="text-sm text-[var(--text-color-secondary)]">\uB85C\uCEEC \uC800\uC7A5 (\uC2DC\uAC04: ${x})</div>
                        <div class="text-xs text-[var(--text-color-secondary)]">ID: ${m}</div>
                    `,v.addEventListener("click",()=>{Ue(m),s.remove()}),i.appendChild(v)}}),f.appendChild(i)}}},Fe=()=>{let e=document.getElementById("active-overlay");e&&e.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let t=n("div","w-full max-w-md max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6 flex flex-col"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","Codex");r.appendChild(s);let l=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");l.textContent="\xD7",l.onclick=()=>o.remove(),r.appendChild(l),t.appendChild(r);let c=n("div","flex-grow overflow-y-auto"),d=Y(),h=[];if(d.codex_new&&d.codex_new.length>0&&h.push(...d.codex_new),d.codex_update&&d.codex_update.length>0&&h.push(...d.codex_update),h.length>0){let f=h.reduce((g,b)=>{let w="General";return b.data&&b.data.length>0&&b.data[0].category?w=b.data[0].category:b.id==="player_001"&&(w="Player"),g[w]||(g[w]=[]),g[w].push(b),g},{});for(let g in f){let b=n("div","mb-4 last:mb-0"),w=B[g]!==!1,i=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");i.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${g}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${w?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,b.appendChild(i);let m=n("div","overflow-hidden transition-all duration-300 ease-in-out");w?m.style.maxHeight=m.scrollHeight+"px":m.style.maxHeight="0px";let u=n("ul","space-y-2 mt-2 codex-list");u.setAttribute("data-list-type","codex"),f[g].forEach((a,p)=>{let v=!(a.id==="player_001"&&!h.some(y=>y.id==="player_002")),x=Pe(a,v);u.appendChild(x)}),m.appendChild(u),b.appendChild(m),c.appendChild(b),i.addEventListener("click",()=>{let a=i.querySelector("svg");m.style.maxHeight==="0px"||m.style.maxHeight===""?(m.style.maxHeight=m.scrollHeight+"px",a.classList.remove("rotate-180"),B[g]=!0):(m.style.maxHeight="0px",a.classList.add("rotate-180"),B[g]=!1)})}}else{let f=n("p","text-sm text-[var(--text-color-secondary)] italic");f.textContent="Codex \uBAA9\uB85D\uC774 \uBE44\uC5B4\uC788\uC2B5\uB2C8\uB2E4",c.appendChild(f)}t.appendChild(c),o.appendChild(t),document.body.appendChild(o),o.addEventListener("click",f=>{f.target===o&&o.remove()})},Ke=()=>{let e=document.getElementById("active-overlay");e&&e.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let t=n("div","w-full max-w-md bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl p-6"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] pb-3 mb-4"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\uC124\uC815");r.appendChild(s);let l=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");l.textContent="\xD7",l.onclick=()=>o.remove(),r.appendChild(l),t.appendChild(r);let c=n("div","mb-6"),d=n("label","block text-sm font-medium text-[var(--text-color-primary)] mb-2","\uD14C\uB9C8 \uC120\uD0DD");c.appendChild(d);let h=n("select","w-full px-3 py-2 bg-[var(--bg-color)] border border-[var(--border-color)] rounded-md text-[var(--text-color-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--ui-accent-secondary)]");G.forEach(f=>{let g=n("option","",f);g.value=f,f===ae&&(g.selected=!0),h.appendChild(g)}),h.addEventListener("change",f=>{X(f.target.value),localStorage.setItem("userPreferredTheme",f.target.value)}),c.appendChild(h),t.appendChild(c),o.appendChild(t),document.body.appendChild(o),o.addEventListener("click",f=>{f.target===o&&o.remove()})};var Ve=()=>{let e=document.getElementById("active-overlay");e&&e.remove();let o=n("div","fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50");o.id="active-overlay";let t=n("div","w-full max-w-6xl max-h-[90vh] bg-[var(--bg-panel)] border border-[var(--border-color)] rounded-lg shadow-xl flex flex-col"),r=n("div","flex items-center justify-between border-b border-[var(--border-color)] p-6 pb-3"),s=n("h2","text-2xl font-bold text-[var(--ui-accent-primary)]","\u{1F41B} Debug Data Browser");r.appendChild(s);let l=n("button","text-[var(--text-color-secondary)] hover:text-white transition-colors text-2xl px-2");l.textContent="\xD7",l.onclick=()=>o.remove(),r.appendChild(l),t.appendChild(r);let c=n("div","flex gap-2 px-6 pt-3 border-b border-[var(--border-color)]"),d=["Entities","Resources","Assets","Modifiers","localStorage","Page History"],h=[];d.forEach((u,a)=>{let p=n("button",`px-4 py-2 rounded-t-md transition-colors ${a===0?"bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]":"text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}`);p.textContent=u,p.dataset.tab=u,h.push(p),c.appendChild(p)}),t.appendChild(c);let f=n("div","flex-grow overflow-y-auto p-6");t.appendChild(f);let g=Y(),b=K(),w=u=>{let a=n("pre","bg-black/30 p-4 rounded-md overflow-x-auto text-xs text-[var(--text-color-primary)] font-mono");return a.textContent=JSON.stringify(u,null,2),a},i=(u,a)=>{let p=n("div","mb-6"),v=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3",a);if(p.appendChild(v),!u||u.length===0){let C=n("p","text-[var(--text-color-secondary)] italic","\uB370\uC774\uD130 \uC5C6\uC74C");return p.appendChild(C),p}let x=n("table","w-full border-collapse text-sm");x.style.fontSize="12px";let y=n("thead"),I=n("tr","border-b border-[var(--border-color)]"),$=Object.keys(u[0]);$.forEach(C=>{let L=n("th","text-left p-2 text-[var(--text-color-primary)] font-bold",C);I.appendChild(L)}),y.appendChild(I),x.appendChild(y);let S=n("tbody");return u.forEach((C,L)=>{let O=n("tr","border-b border-[var(--border-color)]/30 hover:bg-[var(--bg-color)] transition-colors");$.forEach(U=>{let _=n("td","p-2 text-[var(--text-color-secondary)]"),E=C[U];typeof E=="object"&&E!==null?_.textContent=JSON.stringify(E):_.textContent=E??"null",O.appendChild(_)}),S.appendChild(O)}),x.appendChild(S),p.appendChild(x),p},m=u=>{switch(f.innerHTML="",u){case"Entities":f.appendChild(i(g.codex_new,"New Entities")),f.appendChild(i(g.codex_update,"Updated Entities"));break;case"Resources":f.appendChild(i(g.resources,"Resources"));break;case"Assets":f.appendChild(i(g.asset,"Assets"));break;case"Modifiers":f.appendChild(i(g.modifiers,"Modifiers"));break;case"localStorage":let a=n("div"),p=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","localStorage Keys");a.appendChild(p);let v=n("div","space-y-2"),x=Object.keys(localStorage).filter(_=>_.includes(b)||_.includes("processed_pages")||_.includes("snapshot_pages"));if(x.forEach(_=>{let E=n("div","bg-black/20 p-3 rounded-md"),we=n("div","font-bold text-[var(--ui-accent-primary)] mb-2",_);E.appendChild(we);try{let q=localStorage.getItem(_),k=JSON.parse(q);E.appendChild(w(k))}catch{let k=n("pre","text-xs text-[var(--text-color-secondary)]",localStorage.getItem(_));E.appendChild(k)}v.appendChild(E)}),x.length===0){let _=n("p","text-[var(--text-color-secondary)] italic","\uAD00\uB828 localStorage \uD56D\uBAA9 \uC5C6\uC74C");v.appendChild(_)}a.appendChild(v),f.appendChild(a);break;case"Page History":let y=n("div"),I=`processed_pages_${b}`,$=JSON.parse(localStorage.getItem(I)||"[]");y.appendChild(i($,"Processed Pages (Anti-duplicate)"));let S=`snapshot_pages_${b}`,C=JSON.parse(localStorage.getItem(S)||"[]");y.appendChild(i(C,"Saved Snapshots"));let L=n("div","mt-6 bg-black/20 p-4 rounded-md"),O=n("h3","text-lg font-bold text-[var(--ui-accent-secondary)] mb-3","Current Page Info");L.appendChild(O);let U={sessionId:b,page_number:g.page_number,title:g.header.title,timestamp:new Date().toISOString()};L.appendChild(w(U)),y.appendChild(L),f.appendChild(y);break}};h.forEach(u=>{u.addEventListener("click",()=>{h.forEach(a=>{a.className="px-4 py-2 rounded-t-md transition-colors text-[var(--text-color-secondary)] hover:text-[var(--text-color-primary)]"}),u.className="px-4 py-2 rounded-t-md transition-colors bg-[var(--bg-color)] text-[var(--ui-accent-primary)] border-t border-x border-[var(--border-color)]",m(u.dataset.tab)})}),m("Entities"),o.appendChild(t),document.body.appendChild(o),o.addEventListener("click",u=>{u.target===o&&o.remove()})};var P=null,Pe=(e,o=!0)=>{let t=n("li","text-sm p-2 rounded-md transition-colors");o?(t.setAttribute("draggable","true"),t.classList.add("cursor-grab","bg-[var(--bg-panel)]/30","hover:bg-[var(--bg-panel)]/50")):t.classList.add("bg-amber-900/30","border","border-amber-600","text-amber-200","font-bold");let r=e.classifications||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--text-color-secondary)] mt-1">${Object.entries(r).map(([l,c])=>{let d=c.label||l,h=c.value||c;return`<span>${d}: ${h}</span>`}).join(", ")}</div>`:"";return t.innerHTML=`<strong class="text-[var(--ui-accent-secondary)]">${e.name||e.id}</strong>
        ${s}
    `,t.dataset.entityId=e.id,o&&(t.addEventListener("dragstart",te),t.addEventListener("dragend",oe),t.addEventListener("dragover",re),t.addEventListener("drop",se)),t},dt=(e,o)=>{let t=n("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");t.setAttribute("draggable","true"),t.setAttribute("data-index",o),t.dataset.assetId=e.id;let r=e.properties||{},s=Object.keys(r).length>0?`<div class="text-xs text-[var(--ui-accent-tertiary)] mb-1">${Object.entries(r).map(([l,c])=>{let d=c.label||l,h=c.value||c;return`<span>${d}: ${h}</span>`}).join(", ")}</div>`:"";return t.innerHTML=`
        <div class="flex justify-between items-center mb-1">
            <span class="font-semibold text-[var(--text-color-primary)] text-base">${e.name}</span>
            <span class="text-xs font-mono text-[var(--text-color-secondary)]">x${e.quantity}</span>
        </div>
        ${s}
        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] leading-tight">${e.description}</p>`:""}
    `,t.addEventListener("dragstart",te),t.addEventListener("dragend",oe),t.addEventListener("dragover",re),t.addEventListener("drop",se),t},pt=(e,o)=>{let t=n("li","bg-[var(--bg-panel)]/30 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/50 transition-colors");t.setAttribute("draggable","true"),t.setAttribute("data-index",o),t.dataset.resourceId=e.id;let r=e.max&&e.max>0?e.current/e.max*100:0;return t.innerHTML=`
        <div class="flex justify-between items-baseline text-sm mb-1">
            <span class="font-semibold text-[var(--text-color-primary)]">${e.name}</span>
            <span class="font-mono text-[var(--text-color-secondary)]">${e.current}${e.max?"/"+e.max:""}</span>
        </div>
        ${e.max?`
            <div class="w-full bg-black/30 rounded-full h-1.5 mb-1">
                <div class="h-1.5 rounded-full transition-all duration-300" style="width: ${r}%; background-color: ${e.color};"></div>
            </div>
        `:""}
        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${e.description}</p>`:""}
    `,t.addEventListener("dragstart",te),t.addEventListener("dragend",oe),t.addEventListener("dragover",re),t.addEventListener("drop",se),t},ut=(e,o)=>{let t=n("li","bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors");t.setAttribute("draggable","true"),t.setAttribute("data-index",o),t.dataset.modifierId=e.id;let r="text-[var(--ui-accent-secondary)]",s="";return e.alignment==="good"?(r="text-green-400",s="border-l-2 border-green-400"):e.alignment==="bad"?(r="text-red-400",s="border-l-2 border-red-400"):e.alignment==="neutral"&&(r="text-gray-400",s="border-l-2 border-gray-400"),t.className=`bg-[var(--bg-panel)]/50 p-2 rounded-md cursor-grab hover:bg-[var(--bg-panel)]/70 transition-colors ${s}`,t.innerHTML=`
        <div class="flex justify-between items-baseline mb-1">
            <span class="font-semibold ${r} text-sm">${e.name}</span>
            ${e.duration?`<span class="text-xs text-[var(--text-color-secondary)]">${e.duration}</span>`:""}
        </div>
        <div class="text-xs text-[var(--text-color-secondary)]">
            ${e.target} ${e.operation} ${e.value}
        </div>
        ${e.description?`<p class="text-xs text-[var(--text-color-secondary)] mt-1">${e.description}</p>`:""}
    `,t.addEventListener("dragstart",te),t.addEventListener("dragend",oe),t.addEventListener("dragover",re),t.addEventListener("drop",se),t},te=e=>{P=e.target.closest('[draggable="true"]'),P&&(P.style.opacity="0.5",P.classList.add("border","border-stone-500"),e.dataTransfer.effectAllowed="move")},oe=e=>{if(P){P.style.opacity="1",P.classList.remove("border","border-stone-500");let o=P.parentNode;if(o){let t=o.getAttribute("data-list-type");ft(o,t)}}},re=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move";let o=e.target.closest('[draggable="true"]');if(o&&o!==P&&o.parentNode===P.parentNode){let t=o.getBoundingClientRect(),r=t.top+t.height/2;e.clientY<r?o.parentNode.insertBefore(P,o):o.parentNode.insertBefore(P,o.nextSibling)}},se=e=>{e.preventDefault(),e.stopPropagation()},ft=(e,o)=>{if(!e||!o)return;let r=Array.from(e.children).map(s=>o==="resource"?s.dataset.resourceId:o==="asset"?s.dataset.assetId||s.textContent.trim():o==="modifier"?s.dataset.modifierId:o==="codex"?s.dataset.entityId:null).filter(s=>s!==null);o==="resource"?(Ie(r),console.log("Resource order saved:",r)):o==="asset"?(Le(r),console.log("Asset order saved:",r)):o==="modifier"&&(Ee(r),console.log("Modifier order saved:",r))},Ne=(e,o,t="id")=>{if(!o||o.length===0)return e;let r=new Map(e.map(c=>[c[t],c])),s=[],l=[];return o.forEach(c=>{let d=r.get(c);d&&(s.push(d),r.delete(c))}),r.forEach(c=>l.push(c)),[...s,...l]},me=e=>{let o=document.getElementById("header-container");if(!o)return;let t=e.title||"\uC81C 1\uC7A5: \uADF8\uB9BC\uC790\uC758 \uAE38";o.innerHTML=`
        <div class="flex justify-between items-center">
            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
            <h1 class="text-2xl font-bold text-[var(--text-color-primary)] text-center cursor-pointer" id="header-title">${t}</h1>
            <button class="p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
        </div>
        <div class="text-center text-sm text-[var(--text-color-secondary)] mt-2">
            <span>${e.hud?.location||"\uC54C \uC218 \uC5C6\uB294 \uC7A5\uC18C"}</span>
            <span class="mx-2">\xB7</span>
            <span>${e.hud?.date||""}</span>
            <span class="mx-2">\xB7</span>
            <span>${e.hud?.time||""}</span>
        </div>
    `,document.getElementById("header-title").addEventListener("click",He)};var xe=e=>{let o=document.getElementById("info-panel-container");if(!o||!e.scene_elements||e.scene_elements.length===0)return;o.innerHTML="";let t=e.page_number||0,r=n("div","relative w-full transition-all duration-300 ease-in-out cursor-pointer rounded-lg hover:bg-[var(--bg-panel)]");j&&r.classList.add("is-expanded","bg-[var(--bg-panel)]");let s=n("div","h-24"),l=n("div","relative w-full h-full flex items-center"),c=n("div","absolute left-[5%] top-1/2 w-[90%] h-0.5 bg-[var(--info-panel-line-color)]");l.appendChild(c);let d=[...e.scene_elements].sort((i,m)=>i.distance-m.distance),h=Math.max(...e.scene_elements.map(i=>Math.abs(i.distance)),5),f=[],g=!1;d.forEach((i,m)=>{let u=Math.max(-h,Math.min(h,i.distance)),a=d.filter(k=>k.distance===i.distance),p=a.findIndex(k=>k.name===i.name),v=a.length,x=2,I=-((v-1)*x)/2,S=50+u/h*45+I+p*x,C=n("div","absolute top-1/2");C.style.left=`${S}%`,C.style.transform="translate(-50%, -50%)";let L=n("div","w-3 h-3 rounded-full border-2 transition-all duration-200 ease-in-out relative flex items-center justify-center"),O,U;if(i.type==="player"){let k="var(--player-color)";L.classList.add(`border-[${k}]`,`bg-[${k}]`),U="text-black",O=k}else{let k,ne;i.type==="ally"?(k="var(--ally-color-border)",ne="var(--ally-color-fill)"):i.type==="enemy"?(k="var(--enemy-color-border)",ne="var(--enemy-color-fill)"):(k="var(--object-color-border)",ne="var(--object-color-fill)"),L.classList.add(`border-[${k}]`,`bg-[${ne}]`),U="text-white",O=k}r.classList.contains("is-expanded")&&(L.classList.remove("w-3","h-3"),L.classList.add("w-5","h-5"));let _=n("div","absolute bottom-full mb-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap");_.style.left="50%",_.style.transform="translateX(-50%)",_.style.color=O,_.style.fontSize="16px",_.style.fontWeight="bold",_.textContent=i.name,i.type==="player"&&t===1?_.style.opacity="1":_.style.opacity="0",L.appendChild(_);let E=null;i.type==="player"&&i.status&&(E=n("div","absolute top-full mt-2 transition-opacity duration-200 pointer-events-none whitespace-nowrap text-xs text-[var(--text-color-secondary)]"),E.style.left="50%",E.style.transform="translateX(-50%)",E.textContent=i.status,t===1?E.style.opacity="1":E.style.opacity="0",L.appendChild(E));let we=String.fromCharCode(65+m),q=n("span",`relative text-xs font-bold ${U} opacity-0 transition-opacity duration-200`);q.textContent=we,r.classList.contains("is-expanded")&&(q.style.opacity="1"),L.appendChild(q),f.push({dot:L,indexSpan:q,elementWrapper:C,nameTooltip:_,statusTooltip:E,element:i}),C.addEventListener("mouseenter",()=>{r.classList.contains("is-expanded")||(_.style.opacity="1",E&&t===1&&(E.style.opacity="1"))}),C.addEventListener("mouseleave",()=>{i.type==="player"&&t===1&&!g?(_.style.opacity="1",E&&(E.style.opacity="1")):(_.style.opacity="0",E&&(E.style.opacity="0"))}),C.appendChild(L),l.appendChild(C)}),r.addEventListener("mouseenter",()=>{g=!0,t===1&&f.forEach(({nameTooltip:i,statusTooltip:m,element:u})=>{u.type==="player"&&(i.style.opacity="0",m&&(m.style.opacity="0"))})}),r.addEventListener("mouseleave",()=>{g=!1,t===1&&!r.classList.contains("is-expanded")&&f.forEach(({nameTooltip:i,statusTooltip:m,element:u})=>{u.type==="player"&&(i.style.opacity="1",m&&(m.style.opacity="1"))})}),s.appendChild(l),r.appendChild(s);let b=n("div","max-h-0 overflow-hidden transition-all duration-300 ease-in-out relative"),w=n("ul","space-y-3 px-[5%] pb-12 opacity-0 transition-opacity duration-300");d.forEach((i,m)=>{let u=n("li","text-[var(--text-color-primary)]"),a;i.type==="player"?a="text-[var(--player-color)]":i.type==="ally"?a="text-[var(--ally-color-border)]":i.type==="enemy"?a="text-[var(--enemy-color-border)]":i.type==="object"&&(a="text-[var(--object-color-border)]");let p=String.fromCharCode(65+m);u.innerHTML=`<strong class="font-bold ${a}">${p}. ${i.name}:</strong> <span class="text-[var(--text-color-secondary)]">${i.status}</span>`,w.appendChild(u)}),b.appendChild(w),r.appendChild(b),r.classList.contains("is-expanded")&&(b.style.maxHeight=b.scrollHeight+"px",setTimeout(()=>{w.classList.add("opacity-100")},50),l.style.pointerEvents="none"),r.addEventListener("click",i=>{if(i.target.closest(".pointer-events-auto"))return;let m=r.classList.contains("is-expanded");if(j&&m)return;r.classList.toggle("is-expanded")?(r.classList.add("bg-[var(--bg-panel)]"),b.style.maxHeight=b.scrollHeight+"px",setTimeout(()=>{w.classList.add("opacity-100")},50),l.style.pointerEvents="none",f.forEach(({dot:a,indexSpan:p})=>{a.classList.remove("w-3","h-3"),a.classList.add("w-5","h-5"),p.style.opacity="1"})):(r.classList.remove("bg-[var(--bg-panel)]"),w.classList.remove("opacity-100"),b.style.maxHeight="0px",l.style.pointerEvents="auto",f.forEach(({dot:a,indexSpan:p})=>{a.classList.remove("w-5","h-5"),a.classList.add("w-3","h-3"),p.style.opacity="0"}))}),o.appendChild(r)},he=e=>{let o=document.getElementById("choices-container");if(!o||!e.choices||e.choices.length===0)return;o.innerHTML="";let t=n("div","w-full pt-4");e.choices.forEach((r,s)=>{let l=n("div","w-full text-left py-2 text-[var(--text-color-primary)] text-lg"),c=Be(r);l.innerHTML=`<span class="font-bold text-[var(--text-accent-bold)]">${s+1}.</span> ${c}`,t.appendChild(l)}),o.appendChild(t)},ve=e=>{let o=document.getElementById("content-container");if(o){if(o.innerHTML="",e.story_html){let t=n("div","space-y-4");t.innerHTML=e.story_html,o.appendChild(t)}else if(e.main_content&&e.main_content.length>0){let t=n("div","space-y-4");e.main_content.forEach(r=>{let s=n("p");r.id==="narration"?(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.textContent=r.content):r.id==="thought"?(s.className="text-[var(--text-accent-bold)] leading-loose text-lg pl-4 border-l-2 border-[var(--ui-accent-secondary)]",s.textContent=r.content):r.id==="document"?(s.className="text-[var(--text-color-primary)] leading-relaxed text-base bg-[var(--bg-panel)]/50 p-4 rounded border border-[var(--border-color)]",s.textContent=r.content):r.id==="system"?(s.className="text-[var(--text-color-secondary)] text-sm text-center",s.textContent=r.content):r.id==="quote"?(s.className="text-[var(--text-accent-aux)] leading-relaxed text-lg pl-6 border-l-4 border-[var(--text-accent-aux)] italic",s.textContent=r.content):(s.className="text-[var(--text-color-primary)] leading-loose text-lg",s.innerHTML=`<span class="font-bold text-[var(--text-accent-italic)]">${r.id}:</span> ${r.content}`),t.appendChild(s)}),o.appendChild(t)}}},be=e=>{let o=!0,t=null,r=0,s=0,l="",c=document.getElementById("hud-container");if(!c)return;c.innerHTML="";let d=n("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(e.resources&&e.resources.length>0){let u=e.resources.filter(x=>x.max!==null&&x.max!==void 0),a=e.resources.filter(x=>x.max===null||x.max===void 0),p=[...u,...a];p=Ne(p,ie,"id");let v=n("ul","space-y-2 resource-list");v.setAttribute("data-list-type","resource"),p.forEach((x,y)=>{let I=pt(x,y);v.appendChild(I)}),d.appendChild(v)}else{let u=n("p","text-sm text-[var(--text-color-secondary)] italic");u.textContent="\uC790\uC6D0 \uC815\uBCF4\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4",d.appendChild(u)}if(e.modifiers&&e.modifiers.length>0){let u=n("div","mt-4 pt-3 border-t border-[var(--border-color)]"),a=n("ul","space-y-2 modifier-list");a.setAttribute("data-list-type","modifier"),Ne(e.modifiers,ce,"id").forEach((v,x)=>{let y=ut(v,x);a.appendChild(y)}),u.appendChild(a),d.appendChild(u)}let h=n("div","bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]");if(e.asset&&e.asset.length>0){let u=e.asset.reduce((a,p)=>{let v=p.category||"\uAE30\uD0C0";return a[v]||(a[v]=[]),a[v].push(p),a},{});for(let a in u){let p=n("div","mb-4 last:mb-0");p.setAttribute("draggable","true"),p.dataset.categoryName=a,p.addEventListener("dragstart",te),p.addEventListener("dragend",oe),p.addEventListener("dragover",re),p.addEventListener("drop",se);let v=V[a]!==!1,x=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");x.innerHTML=`
                            <span class="font-bold text-[var(--ui-accent-primary)] text-lg">${a}</span>
                            <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${v?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        `,p.appendChild(x);let y=n("div","overflow-hidden transition-all duration-300 ease-in-out");v?y.style.maxHeight=y.scrollHeight+"px":y.style.maxHeight="0px";let I=n("ul","space-y-2 mt-2 asset-list");I.setAttribute("data-list-type","asset"),Ne(u[a],le,"id").forEach((S,C)=>{let L=dt(S,C);I.appendChild(L)}),y.appendChild(I),p.appendChild(y),h.appendChild(p),x.addEventListener("click",()=>{let S=x.querySelector("svg");y.style.maxHeight==="0px"||y.style.maxHeight===""?(y.style.maxHeight=y.scrollHeight+"px",S.classList.remove("rotate-180"),V[a]=!0):(y.style.maxHeight="0px",S.classList.add("rotate-180"),V[a]=!1)})}}else{let u=n("p","text-sm text-[var(--text-color-secondary)] italic");u.textContent="Asset\uC774 \uC5C6\uC2B5\uB2C8\uB2E4",h.appendChild(u)}let f=n("div","hidden sm:block bg-[var(--bg-panel)] p-4 rounded-lg border border-[var(--border-color)]"),g=[];if(e.codex_new&&e.codex_new.length>0&&g.push(...e.codex_new),e.codex_update&&e.codex_update.length>0&&g.push(...e.codex_update),g.length>0){let u=g.reduce((a,p)=>{let v="General";return p.data&&p.data.length>0&&p.data[0].category?v=p.data[0].category:p.id==="player_001"&&(v="Player"),a[v]||(a[v]=[]),a[v].push(p),a},{});for(let a in u){let p=n("div","mb-4 last:mb-0"),v=B[a]!==!1,x=n("button","flex justify-between items-center w-full py-2 transition-colors focus:outline-none");x.innerHTML=`
                <span class="font-bold text-[var(--text-color-primary)] text-lg">${a}</span>
                <svg class="w-5 h-5 text-[var(--text-color-secondary)] transform ${v?"":"rotate-180"} transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `,p.appendChild(x);let y=n("div","overflow-hidden transition-all duration-300 ease-in-out");v?y.style.maxHeight=y.scrollHeight+"px":y.style.maxHeight="0px";let I=n("ul","space-y-2 mt-2 codex-list");I.setAttribute("data-list-type","codex"),u[a].forEach(($,S)=>{let C=!($.id==="player_001"&&!g.some(O=>O.id==="player_002")),L=Pe($,C);I.appendChild(L)}),y.appendChild(I),p.appendChild(y),f.appendChild(p),x.addEventListener("click",()=>{let $=x.querySelector("svg");y.style.maxHeight==="0px"||y.style.maxHeight===""?(y.style.maxHeight=y.scrollHeight+"px",$.classList.remove("rotate-180"),B[a]=!0):(y.style.maxHeight="0px",$.classList.add("rotate-180"),B[a]=!1)})}}let b=[d,h,f],w=[];b.forEach(u=>{u.classList.add("flex","flex-col");let a=n("div","mt-4 w-full flex items-end");a.setAttribute("data-tip-spacer","true"),a.style.transition="height 300ms ease-out",a.style.willChange="height",u.appendChild(a),w.push(a),c.appendChild(u)});let i=()=>{requestAnimationFrame(()=>{let p=b,v=p.map($=>{let S=$.querySelector('[data-tip-spacer="true"]'),C=S?S.style.display:"";S&&(S.style.display="none");let L=$.offsetHeight;return S&&(S.style.display=C),L});if(v.length===0)return;let x=Math.max(...v);if(p.forEach(($,S)=>{let C=v[S],L=x-C,O=$.querySelector('[data-tip-spacer="true"]');O&&(O.style.height=`${Math.max(0,L)}px`)}),clearTimeout(t),x<1e3){p.forEach($=>{let S=$.querySelector('[data-tip-spacer="true"]');S&&(S.innerHTML="")});return}let y=[];p.forEach(($,S)=>{x-v[S]>50&&y.push({panel:$,index:S})});let I=y.length>0?y[y.length-1]:null;if(p.forEach(($,S)=>{if(!I||S!==I.index){let C=$.querySelector('[data-tip-spacer="true"]');C&&(C.innerHTML="")}}),!o&&I){let $=Date.now();if($<s)return;let S=I.panel.querySelector('[data-tip-spacer="true"]');($-r>1e4||l==="")&&(r=$,l=de[Math.floor(Math.random()*de.length)]);let C=S.querySelector("p");C||(C=document.createElement("p"),C.className="p-4 text-sm text-[var(--text-color-secondary)] italic transition-opacity duration-300 opacity-0",S.appendChild(C)),C.textContent=l,requestAnimationFrame(()=>C.classList.remove("opacity-0")),t=setTimeout(()=>{C.classList.add("opacity-0"),s=Date.now()+1e4,setTimeout(()=>{C.parentNode&&C.parentNode.removeChild(C)},300)},5e3)}})},m=new ResizeObserver(i);b.forEach(u=>{m.observe(u)}),setTimeout(()=>{i(),o=!1},150)},ye=()=>{let e=document.getElementById("app-root");e.innerHTML="";let o=n("div","max-w-5xl mx-auto p-4 sm:p-6"),t=n("div","mb-8");t.id="header-container";let r=n("div","my-8");r.id="content-container";let s=n("div","my-1");s.id="info-panel-container";let l=n("div");l.id="choices-container";let c=n("div","relative mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 items-start");c.id="hud-container";let d=n("div","flex justify-end gap-2 mt-2");d.id="hud-controls-container";let h=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");h.id="image-button",h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',h.addEventListener("click",qe);let f=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");f.id="page-button",f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',f.addEventListener("click",He);let g=n("button","sm:hidden p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");g.id="codex-button",g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>';let b=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");b.id="pin-infopanel-button",b.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',b.addEventListener("click",()=>{_e(!j),b.classList.toggle("bg-[var(--ui-accent-primary)]",j);let m=document.querySelector("#info-panel-container > div");if(m){let u=m.classList.contains("is-expanded");(j&&!u||!j&&u)&&m.click()}});let w=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors");w.id="settings-button",w.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .3 1.67c-.2.2-.3.3-.3.3s-.2.1-.3.1c-.2.1-.4.1-.6.1-.2 0-.4 0-.6-.1a1.65 1.65 0 0 0-1.67-.3c-.2-.2-.3-.3-.3-.3s-.1-.2-.1-.3c-.1-.2-.1-.4-.1-.6 0-.2 0-.4.1-.6a1.65 1.65 0 0 0 .3-1.67c.2-.2.3-.3.3-.3s-.2-.1.3-.1c.2-.1.4-.1.6-.1.2 0 .4 0 .6.1a1.65 1.65 0 0 0 1.67.3c.2.2.3.3.3.3s.1.2.1.3c.1.2.1.4.1.6 0 .2 0 .4-.1.6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';let i=n("button","p-2 rounded-md hover:bg-[var(--bg-panel)] transition-colors border border-[var(--border-color)]");i.id="debug-button",i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="6" width="8" height="1"></rect><rect x="8" y="11" width="8" height="1"></rect><rect x="8" y="16" width="8" height="1"></rect><path d="M12 3v3"></path><path d="M12 18v3"></path><path d="M4 9h2"></path><path d="M18 9h2"></path><path d="M4 15h2"></path><path d="M18 15h2"></path><circle cx="12" cy="12" r="9"></circle></svg>',i.title="Debug Data Browser",d.appendChild(h),d.appendChild(f),d.appendChild(g),d.appendChild(b),d.appendChild(w),d.appendChild(i),o.append(t,r,s,l,d,c),e.appendChild(o)};A();import{initializeApp as gt}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";var We=async()=>{try{await je(gt);let e=Y(),o=e.sessionId,t={resources:[],asset:[],modifiers:[],codex_new:[],codex_update:[]};t=await ze(M,N,o),e.resources=R(t.resources,e.resources,"id"),e.asset=R(t.asset,e.asset,"id"),e.modifiers=R(t.modifiers,e.modifiers,"id"),e.codex_new=R(t.entities,e.codex_new,"id"),e.codex_update&&e.codex_update.length>0&&(e.codex_new=R(e.codex_new,e.codex_update,"id"),e.codex_update=[]);let s=ke()[0]||"modern";W&&G.includes(W)&&(s=W),X(s),await Je(M,N,e),await Re(M,N,e),ye(),me(e),ve(e),xe(e),he(e),be(e);let l=document.getElementById("codex-button");l&&l.addEventListener("click",Fe);let c=document.getElementById("settings-button");c&&c.addEventListener("click",Ke);let d=document.getElementById("debug-button");d&&d.addEventListener("click",Ve),console.log("Application initialized successfully")}catch(e){console.error("Initialization Error:",e),document.body.innerHTML=`<div class="text-red-400 p-8">Error: ${e.message}</div>`}};document.addEventListener("DOMContentLoaded",async()=>{await We()});
//# sourceMappingURL=bundle.min.js.map
